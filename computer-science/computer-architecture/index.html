<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>计算机系统结构 复习笔记 | 小灰灰灰灰的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="计算机科学,课程笔记,计算机系统结构">
    <meta name="description" content="第一章 量化设计与分析基础引言处理器惊人的性能改进                                                                                             处理器惊人的性能改进               分析：  每年 25%（1978-1986）: 性能增长主要依赖实现技术的进步 每年 52%（1986-2003）">
<meta property="og:type" content="article">
<meta property="og:title" content="计算机系统结构 复习笔记">
<meta property="og:url" content="https://blog.lyh543.cn/computer-science/computer-architecture/index.html">
<meta property="og:site_name" content="小灰灰灰灰的博客">
<meta property="og:description" content="第一章 量化设计与分析基础引言处理器惊人的性能改进                                                                                             处理器惊人的性能改进               分析：  每年 25%（1978-1986）: 性能增长主要依赖实现技术的进步 每年 52%（1986-2003）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.lyh543.cn/images/c41ef765f8191573d0e90137e7fc29f14f38ff83ce79065843de8b497190bc2b.png">
<meta property="og:image" content="https://blog.lyh543.cn/images/e210f27c2af7a036b31d165446e01c6f0da4ffc97fe7f6eae9c7870a1f73fd96.png">
<meta property="og:image" content="https://blog.lyh543.cn/images/9c121277140d7e947db4dafc4fbe194bbe6240111b553e771bd8b4a3ed553a96.png">
<meta property="og:image" content="https://blog.lyh543.cn/images/99f94e94f25e5063eb6023b9342c3649169d261960d030194256612cfccb64ad.png">
<meta property="og:image" content="https://blog.lyh543.cn/images/544c090f1945ced01ccdaadf6ea9ab5e2191e910329a21859f6a334ca859170e.png">
<meta property="og:image" content="https://blog.lyh543.cn/images/0fd1ae059c05b774d2917c4426db53ae4f6fea81d0bd7384cc82ee49585b0556.png">
<meta property="og:image" content="https://blog.lyh543.cn/images/ab09b1e3bea2268297c3226b1629bb925fde236fa25387fecedc877a9eff1a0b.png">
<meta property="og:image" content="https://blog.lyh543.cn/images/58622010cfae339191b479b4f6260bc01a94cd25ea7b7e37f1e9fdb21f834bd6.png">
<meta property="og:image" content="https://blog.lyh543.cn/images/53296300cbab5a770b9e0caef8648ea3533020ee966447cdacfd5456a97dd777.png">
<meta property="og:image" content="https://blog.lyh543.cn/images/e19c3ed2a48466a604bee97c2c86752f2d8c63cac9287a5aa27b12c80af449d4.png">
<meta property="article:published_time" content="2021-03-01T06:40:25.000Z">
<meta property="article:modified_time" content="2021-09-11T12:19:35.019Z">
<meta property="article:author" content="lyh543">
<meta property="article:tag" content="计算机科学">
<meta property="article:tag" content="课程笔记">
<meta property="article:tag" content="计算机系统结构">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.lyh543.cn/images/c41ef765f8191573d0e90137e7fc29f14f38ff83ce79065843de8b497190bc2b.png">
    
        <link rel="alternate" type="application/atom+xml" title="小灰灰灰灰的博客" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.png">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu"  >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="mdi mdi-close icon-lg"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">lyh543</h5>
          <a href="mailto:lyh543@outlook.com" title="lyh543@outlook.com" class="mail">lyh543@outlook.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg mdi mdi-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg mdi mdi-archive"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg mdi mdi-tag-multiple"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg mdi mdi-format-list-bulleted-square"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/lyh543" target="_blank" >
                <i class="icon icon-lg mdi mdi-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg mdi mdi-menu"></i>
        </a>
        <div class="flex-col header-title ellipsis">计算机系统结构 复习笔记</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg mdi mdi-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg mdi mdi-magnify"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg mdi mdi-share-variant"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">计算机系统结构 复习笔记</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-03-01T06:40:25.000Z" itemprop="datePublished" class="page-time">
  2021-03-01
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/">计算机科学</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第一章-量化设计与分析基础"><span class="post-toc-text">第一章 量化设计与分析基础</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#引言"><span class="post-toc-text">引言</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#处理器惊人的性能改进"><span class="post-toc-text">处理器惊人的性能改进</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#计算机的分类"><span class="post-toc-text">计算机的分类</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#基于指令流和数据流数量分类-XIXD"><span class="post-toc-text">基于指令流和数据流数量分类 (XIXD)</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#基于市场分类"><span class="post-toc-text">基于市场分类</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#计算机系统结构定义与计算机的设计任务"><span class="post-toc-text">计算机系统结构定义与计算机的设计任务</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#计算机系统结构（原始定义）"><span class="post-toc-text">计算机系统结构（原始定义）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#计算机系统结构（现代定义）"><span class="post-toc-text">计算机系统结构（现代定义）</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#第三章"><span class="post-toc-text">第三章</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#结构冒险"><span class="post-toc-text">结构冒险</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#数据冒险"><span class="post-toc-text">数据冒险</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#硬件插入-stall"><span class="post-toc-text">硬件插入 stall</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#内部前推-forwading"><span class="post-toc-text">内部前推 forwading</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#处理-load-指令-stall-forwarding"><span class="post-toc-text">处理 load 指令: stall + forwarding</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#总结"><span class="post-toc-text">总结</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#控制冒险"><span class="post-toc-text">控制冒险</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#暂停流水线"><span class="post-toc-text">暂停流水线</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#假定转移不发生"><span class="post-toc-text">假定转移不发生</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#例题"><span class="post-toc-text">例题</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#延迟转移"><span class="post-toc-text">延迟转移</span></a></li></ol></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-computer-science/computer-architecture"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">计算机系统结构 复习笔记</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-03-01 14:40:25" datetime="2021-03-01T06:40:25.000Z"  itemprop="datePublished">2021-03-01</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/">计算机科学</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="第一章-量化设计与分析基础"><a href="#第一章-量化设计与分析基础" class="headerlink" title="第一章 量化设计与分析基础"></a>第一章 量化设计与分析基础</h2><h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><h4 id="处理器惊人的性能改进"><a href="#处理器惊人的性能改进" class="headerlink" title="处理器惊人的性能改进"></a>处理器惊人的性能改进</h4><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../../images/c41ef765f8191573d0e90137e7fc29f14f38ff83ce79065843de8b497190bc2b.png" alt="处理器惊人的性能改进" title="">
                </div>
                <div class="image-caption">处理器惊人的性能改进</div>
            </figure>

<p>分析：</p>
<ul>
<li>每年 25%（1978-1986）: 性能增长主要依赖实现技术的进步</li>
<li>每年 52%（1986-2003）: 性能增长依赖两方面：<ul>
<li>系统结构革新（<strong>RISC</strong>，<strong>指令级并行</strong> (ILP) 技术与Cache）；</li>
<li>实现技术的进步</li>
</ul>
</li>
<li>每年 22%（2004-2010）: ILP 开发的限制，功耗限制，因此其后性能提升手段出现了以下趋势：<ul>
<li>ILP  变为 <strong>TLP and DLP</strong>（线程级并行和数据级并行）</li>
<li>更快的单核处理器 变为 <strong>单芯片多处理器</strong>（多核）</li>
<li>隐含在编译器和硬件的硬件级并行处理 变为 显示的<strong>程序级并行</strong></li>
</ul>
</li>
</ul>
<h3 id="计算机的分类"><a href="#计算机的分类" class="headerlink" title="计算机的分类"></a>计算机的分类</h3><h4 id="基于指令流和数据流数量分类-XIXD"><a href="#基于指令流和数据流数量分类-XIXD" class="headerlink" title="基于指令流和数据流数量分类 (XIXD)"></a>基于指令流和数据流数量分类 (XIXD)</h4><h4 id="基于市场分类"><a href="#基于市场分类" class="headerlink" title="基于市场分类"></a>基于市场分类</h4><h3 id="计算机系统结构定义与计算机的设计任务"><a href="#计算机系统结构定义与计算机的设计任务" class="headerlink" title="计算机系统结构定义与计算机的设计任务"></a>计算机系统结构定义与计算机的设计任务</h3><h4 id="计算机系统结构（原始定义）"><a href="#计算机系统结构（原始定义）" class="headerlink" title="计算机系统结构（原始定义）"></a>计算机系统结构（原始定义）</h4><p>计算机系统结构的原始慨念：</p>
<blockquote>
<p>由程序员看见的计算机系统，就是<strong>慨念性结构</strong>和<strong>功能行为</strong>，以区分数据流动和控制逻辑设计的组成及物理实现。  – Amdahl, Blaaw, and Brooks, 1964</p>
</blockquote>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../../images/e210f27c2af7a036b31d165446e01c6f0da4ffc97fe7f6eae9c7870a1f73fd96.png" alt="指令系统" title="">
                </div>
                <div class="image-caption">指令系统</div>
            </figure>

<p>下面讨论<strong>计算机系统结构</strong>、<strong>计算机组成</strong>和<strong>物理实现</strong>及其关系关系。</p>
<blockquote>
<p>经典的<strong>计算机系统结构</strong>是机器语言程序员所看到的传统机器级所具有的<strong>属性</strong>。它确定计算机系统的软、硬件界面。<br><strong>计算机组成</strong>指的是计算机系统结构的<strong>逻辑实现</strong>，包括五大功能部件组成以及逻辑设计等。它着眼于机器级内各事件的排序方式与控制方式，各部件的功能以及各部件的联系。<br><strong>计算机实现</strong>指的是计算机组成的<strong>物理实现</strong>，包括处理机、主存等部件的物理结构，器件的集成度和速度功耗，模块、插件、底板的划分与连接，信号传输，电源、冷却及整机装配技术等。它着眼于器件技术和微组装技术，其中器件技术在实现技术中占主导作用。</p>
</blockquote>
<blockquote>
<p>① 主存容量与编址方式(按位、按字节、按字访问等)的确定属于计算机系统结构。<br>② 为达到所定性能价格比，主存速度应多快，在逻辑结构上需采用什么措施(如多体交叉存储等)属于计算机组成。<br>③ 主存系统的物理实现，如存储器器件的选定、逻辑电路的设计、微组装技术的选定属于计算机实现。</p>
</blockquote>
<blockquote>
<p>具有<strong>相同计算机系统结构</strong>(指令系统相同)的计算机，因为速度要求不同等因素可以采用<strong>不同的计算机组成</strong>。例如，AMD Opteron 64与 Intel Pentium 4的指令系统相同，即两者的系统结构相同；但内部组成不同，流水线和Cache结构是完全不同的，相同的程序在两个机器上的的运行时间可能不同。<br><strong>一种计算机组成</strong>可以采用多种<strong>不同的计算机实现</strong>。例如，主存器件可以采用SRAM芯片，也可以采用DRAM芯片。</p>
</blockquote>
<blockquote>
<p><strong>系列机</strong>（family machine）：是指由一个制造商生产的具有相同的系统结构，但具有不同组成和实现的一系列不同型号的计算机。<br>主要缺点：系列机为了保证软件的向后兼容，要求体系结构基本不改变，这无疑又妨碍了计算机体系结构的发展。</p>
</blockquote>
<blockquote>
<p><strong>软件兼容性</strong>：同一个软件可以不加修改地运行于系统结构相同的各档机器上，而且运行结果一样，差别只是运行时间不同。<br>向<strong>后</strong>兼容：在某一时间生产的机器上运行的目标软件能够直接运行于更晚生产的机器上。<br>向<strong>上</strong>兼容：在低档机器上运行的目标软件能够直接运行于高档机器上。</p>
</blockquote>
<h4 id="计算机系统结构（现代定义）"><a href="#计算机系统结构（现代定义）" class="headerlink" title="计算机系统结构（现代定义）"></a>计算机系统结构（现代定义）</h4><blockquote>
<p>计算机系统结构（现代定义）：是在满足功能、性能和价格目标的条件下，设计、选择和互连硬件部件构成计算机。 </p>
</blockquote>
<p>系统结构覆盖了：</p>
<ul>
<li>指令系统设计</li>
<li>组成（Organization）：计算机设计方面的高层次<ul>
<li>CPU内部结构、存储器、I/O系统、多处理器、网络</li>
<li>硬件: 计算机的具体实现技术</li>
<li>详细逻辑设计、封装、冷却系统、板级设计，功耗等</li>
</ul>
</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../../images/9c121277140d7e947db4dafc4fbe194bbe6240111b553e771bd8b4a3ed553a96.png" alt="计算机系统结构（单处理器）" title="">
                </div>
                <div class="image-caption">计算机系统结构（单处理器）</div>
            </figure>

<p>绿色部分 (ILP) 本课程不讲，只讲黄色部分。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../../images/99f94e94f25e5063eb6023b9342c3649169d261960d030194256612cfccb64ad.png" alt="计算机系统结构（多处理器）" title="">
                </div>
                <div class="image-caption">计算机系统结构（多处理器）</div>
            </figure>

<h2 id="第三章"><a href="#第三章" class="headerlink" title="第三章"></a>第三章</h2><h3 id="结构冒险"><a href="#结构冒险" class="headerlink" title="结构冒险"></a>结构冒险</h3><h3 id="数据冒险"><a href="#数据冒险" class="headerlink" title="数据冒险"></a>数据冒险</h3><p>解决办法：</p>
<ol>
<li>软件方法：编译器插入NOP（暂停相关流水线）</li>
<li>硬件方法1：硬件插入 stall（暂停相关流水线）</li>
<li>硬件方法2：内部前推</li>
<li>硬件方法3：stall+内部前推（针对 store 指令）</li>
</ol>
<h4 id="硬件插入-stall"><a href="#硬件插入-stall" class="headerlink" title="硬件插入 stall"></a>硬件插入 stall</h4><p>核心：ID 指令等前面的指令走完 WB （写寄存器）以后再继续（读寄存器）</p>
<p><strong>停顿条件：(ID 级指令 rs1/2 == EXE/MEM 级指令 rd) &amp;&amp; (EXE/MEM 级指令要写寄存器) &amp;&amp; (ID 级要读寄存器)</strong></p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DEPEN=(<span class="name">ID_rs1==EXE_rd</span>)(<span class="name">EXE_WREG==1</span>)(<span class="name">ID_rs1IsReg</span>)+</span><br><span class="line">      (<span class="name">ID_rs1==MEM_rd</span>)(<span class="name">MEM_WREG==1</span>)(<span class="name">ID_rs1IsReg</span>)+</span><br><span class="line">      (<span class="name">ID_rs2==EXE_rd</span>)(<span class="name">EXE_WREG==1</span>)(<span class="name">ID_rs2IsReg</span>)+</span><br><span class="line">       (<span class="name">ID_rd==EXE_rd</span>)(<span class="name">EXE_WREG==1</span>)(<span class="name">store</span>)+</span><br><span class="line">      (<span class="name">ID_rs2==MEM_rd</span>)(<span class="name">MEM_WREG==1</span>)(<span class="name">ID_rs2IsReg</span>)+</span><br><span class="line">       (<span class="number">1</span>D_rd==MEM_rd)(<span class="name">MEM_WREG==1</span>)(<span class="name">store</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ID_rs1IsReg</code> 条件是为了排除转移指令</li>
</ul>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ID_rs1IsReg=<span class="keyword">and</span>+<span class="keyword">andi</span>+<span class="keyword">or</span>+<span class="keyword">ori</span>+<span class="keyword">add</span>+addi+<span class="keyword">sub</span>+<span class="keyword">subi</span>+load+store</span><br><span class="line">ID_rs2IsReg=<span class="keyword">and</span>+<span class="keyword">or</span>+<span class="keyword">add</span>+<span class="keyword">sub</span>（排除立即数运算指令）</span><br></pre></td></tr></table></figure>

<hr>
<p>进行简单改写：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DEPEN = A_DEPEN + B_DEPEN</span><br><span class="line">A_DEPEN = EXE_A_DEPEN + MEM_A_DEPEN</span><br><span class="line">B_DEPEN = EXE_B_DEPEN + MEM_B_DEPEN</span><br><span class="line"></span><br><span class="line">EXE_A_DEPEN = (<span class="name">ID_rs1==EXE_rd</span>)(<span class="name">EXE_WREG==1</span>)(<span class="name">ID_rs1IsReg</span>)</span><br><span class="line">MEM_A_DEPEN = (<span class="name">ID_rs1==MEM_rd</span>)(<span class="name">MEM_WREG==1</span>)(<span class="name">ID_rs1IsReg</span>)</span><br><span class="line">EXE_B_DEPEN = (<span class="name">ID_rs2==EXE_rd</span>)(<span class="name">EXE_WREG==1</span>)(<span class="name">ID_rs2IsReg</span>) +</span><br><span class="line">               (<span class="name">ID_rd==EXE_rd</span>)(<span class="name">EXE_WREG==1</span>)(<span class="name">store</span>)</span><br><span class="line">MEM_B_DEPEN = (<span class="name">ID_rs2==MEM_rd</span>)(<span class="name">MEM_WREG==1</span>)(<span class="name">ID_rs2IsReg</span>)</span><br><span class="line">               (<span class="number">1</span>D_rd==MEM_rd)(<span class="name">MEM_WREG==1</span>)(<span class="name">store</span>)</span><br></pre></td></tr></table></figure>

<h4 id="内部前推-forwading"><a href="#内部前推-forwading" class="headerlink" title="内部前推 forwading"></a>内部前推 forwading</h4><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../images/544c090f1945ced01ccdaadf6ea9ab5e2191e910329a21859f6a334ca859170e.png" alt="内部前推 初版" title="">
                </div>
                <div class="image-caption">内部前推 初版</div>
            </figure>

<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../images/0fd1ae059c05b774d2917c4426db53ae4f6fea81d0bd7384cc82ee49585b0556.png" alt="内部前推 时序图" title="">
                </div>
                <div class="image-caption">内部前推 时序图</div>
            </figure>

<p><strong>注意时序图里 forwarding 箭头的写法！</strong></p>
<p>上一个计算结果可以直接从 ALU 里拿出来，至于多路选择哪个值，就是 <code>ADEPEN</code> 和 <code>BDEPEN</code> 的事情了。</p>
<table>
<thead>
<tr>
<th>MEM_WREG</th>
<th>EXE_rs1=MEM_rd</th>
<th>WB_WREG</th>
<th>EXE_rs1=WB_rd</th>
<th>ADEPEN</th>
<th>ALU 输入选择(A端)</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>x</td>
<td>x</td>
<td>2</td>
<td>MEM_R</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>3</td>
<td>WB_C</td>
</tr>
<tr>
<td>0</td>
<td>x</td>
<td>1</td>
<td>1</td>
<td>3</td>
<td>WB_C</td>
</tr>
<tr>
<td>其他情况</td>
<td></td>
<td></td>
<td></td>
<td>0</td>
<td>A</td>
</tr>
</tbody></table>
<p>还是比较显然的。</p>
<p>B 端就比 A 端多一个条件：当 <code>EXE_rs2IsReg</code> 成立时就走立即数 (<code>BDEPEN=2</code>)；其他情况下，按 A 端规则进行判断。</p>
<hr>
<p>和 stall 不同的是：</p>
<ol>
<li>forwarding 考虑的是 EXE 指令和 MEM/WB 指令的关系，stall 考虑的是 ID 指令和 EXE/MEM 指令的关系</li>
<li>forwading 不需要考虑转移指令，因为这类指令走不到 EXE 级</li>
</ol>
<hr>
<p>进行改进：将检测数据相关的时间从 EXE 级提前到 ID 级。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../images/ab09b1e3bea2268297c3226b1629bb925fde236fa25387fecedc877a9eff1a0b.png" alt="内部前推 改进" title="">
                </div>
                <div class="image-caption">内部前推 改进</div>
            </figure>


<h4 id="处理-load-指令-stall-forwarding"><a href="#处理-load-指令-stall-forwarding" class="headerlink" title="处理 load 指令: stall + forwarding"></a>处理 load 指令: stall + forwarding</h4><p>1 stall + 1 forwading 可以解决 EXE 级 store 和 ID 级 ALU 的数据冲突（称为 <code>load 冒险</code>）。</p>
<p>0 stall + 1 forwading 可以解决 MEM 级 store 和 ID 级 ALU 的数据冲突。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../images/58622010cfae339191b479b4f6260bc01a94cd25ea7b7e37f1e9fdb21f834bd6.png" alt="stall + forwarding" title="">
                </div>
                <div class="image-caption">stall + forwarding</div>
            </figure>


<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><table>
<thead>
<tr>
<th>指令</th>
<th>stall/nop</th>
<th>forwarding</th>
</tr>
</thead>
<tbody><tr>
<td>ALU 指令</td>
<td>2 stalls</td>
<td>0 stalls + 1 forwarding</td>
</tr>
<tr>
<td>store 指令</td>
<td>2 stalls</td>
<td>1 stall + 1 forwarding</td>
</tr>
</tbody></table>
<h3 id="控制冒险"><a href="#控制冒险" class="headerlink" title="控制冒险"></a>控制冒险</h3><p>三种解决方法</p>
<ol>
<li>暂停流水线（插 nop 或使用硬件方法）</li>
<li>假定转移不发生（针对条件转移）</li>
</ol>
<h4 id="暂停流水线"><a href="#暂停流水线" class="headerlink" title="暂停流水线"></a>暂停流水线</h4><p>使用软件方法的话，<code>beq</code> <code>bne</code>需要前插 1 个 nop，后插一个 nop；<code>branch</code> 需要后插一个 nop。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../images/53296300cbab5a770b9e0caef8648ea3533020ee966447cdacfd5456a97dd777.png" alt="插入 nop" title="">
                </div>
                <div class="image-caption">插入 nop</div>
            </figure>

<hr>
<p>使用硬件方法就要麻烦一些了。</p>
<p>首先要终止后面一条指令的执行，不然转移发生的时候，后一条指令已经到 ID 了，还将继续执行。</p>
<p>解决办法和 stall 类似，封锁指令的 WZ、WMEM、WREG。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../images/e19c3ed2a48466a604bee97c2c86752f2d8c63cac9287a5aa27b12c80af449d4.png" alt="解决办法" title="">
                </div>
                <div class="image-caption">解决办法</div>
            </figure>

<h4 id="假定转移不发生"><a href="#假定转移不发生" class="headerlink" title="假定转移不发生"></a>假定转移不发生</h4><p>这个其实很简单，就是在装流水线的时候，假设转移不发生，该咋装咋装。</p>
<p>所以，如果真的没有转移，1 次停顿都不会有；如果真的转移了，此时在流水线的指令全部要停掉（这个时候，其实就是硬件方法暂停流水线）。</p>
<h5 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h5><blockquote>
<p>假设某机器的流水线，转移目标地址计算需要2个流水段，转移条件形成需要3个流水段，完成一个流水段的操作用一个时钟周期。假定解决控制冒险有三种方法：停顿流水线、转移预测未选中、转移选中。试计算条件转移指令采用这三种方法在转移发生与转移不发生所产生的停顿时钟周期数</p>
</blockquote>
<table>
<thead>
<tr>
<th>停顿周期数</th>
<th>条件转移发生</th>
<th>条件转移未发生</th>
</tr>
</thead>
<tbody><tr>
<td>停顿流水线</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td>预测转移未选中</td>
<td>2</td>
<td>0</td>
</tr>
<tr>
<td>预测转移选中</td>
<td>1</td>
<td>2</td>
</tr>
</tbody></table>
<h4 id="延迟转移"><a href="#延迟转移" class="headerlink" title="延迟转移"></a>延迟转移</h4><p>注意到 <strong>branch/beq/neq 后的代码一定会被执行</strong>。前面的解决办法是在这个位置放一个 nop 或 stall 解决问题禁止它产生效果。但是能不能利用这个特性，让它在这个时候执行一点代码呢？</p>
<p>这个就和没有流水线的 MIPS 有点不一样了：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Lop： load     <span class="built_in">r1</span>, <span class="number">20</span>(<span class="built_in">r2</span>)</span><br><span class="line">      <span class="keyword">nop</span></span><br><span class="line">      addi     <span class="built_in">r3</span>, <span class="built_in">r1</span>, <span class="number">30</span></span><br><span class="line">      store    <span class="built_in">r3</span>, <span class="number">40</span>(<span class="built_in">r4</span>)</span><br><span class="line">      subicc   <span class="built_in">r5</span>, <span class="built_in">r5</span>, <span class="number">1</span></span><br><span class="line">      <span class="keyword">nop</span></span><br><span class="line">      bne      lop   ；如果Z标志为<span class="number">0</span>，即<span class="built_in">r6</span>的内容不为<span class="number">0</span>，则转Lop</span><br><span class="line">      <span class="keyword">nop</span></span><br></pre></td></tr></table></figure>

<p>上面没有优化的代码需要 3 个 nop。（假设除了 <code>subicc</code> 以外，其他指令不修改标志位，所以 <code>subicc</code> 不需要放在 <code>bne</code> 前）优化以后，一个 nop 都不需要！</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Lop： load     <span class="built_in">r1</span>, <span class="number">20</span>(<span class="built_in">r2</span>)</span><br><span class="line">      subicc   <span class="built_in">r5</span>, <span class="built_in">r5</span>, <span class="number">1</span></span><br><span class="line">      addi     <span class="built_in">r3</span>, <span class="built_in">r1</span>, <span class="number">30</span></span><br><span class="line">      bne      lop   ；如果Z标志为<span class="number">0</span>，即<span class="built_in">r6</span>的内容不为<span class="number">0</span>，则转Lop</span><br><span class="line">      store    <span class="built_in">r3</span>, <span class="number">40</span>(<span class="built_in">r4</span>)</span><br></pre></td></tr></table></figure>

<p>非常神奇的是，<strong>store 指令摆在 bne 以后，但每次跳转仍然会被执行</strong>。这是和单周期 CPU 非常不同的一点。</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2021-09-11T12:19:35.019Z" itemprop="dateUpdated">2021-09-11 20:19:35</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://blog.lyh543.cn">
            <img src="/img/avatar.png" alt="lyh543">
            lyh543
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" rel="tag">计算机科学</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84/" rel="tag">计算机系统结构</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" rel="tag">课程笔记</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.lyh543.cn/computer-science/computer-architecture/&title=《计算机系统结构 复习笔记》 — 小灰灰灰灰的博客&pic=https://blog.lyh543.cn/img/avatar.png" data-title="微博">
          <i class="icon mdi mdi-sina-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.lyh543.cn/computer-science/computer-architecture/&title=《计算机系统结构 复习笔记》 — 小灰灰灰灰的博客&source=" data-title=" QQ">
          <i class="icon mdi mdi-qqchat"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.lyh543.cn/computer-science/computer-architecture/" data-title=" Facebook">
          <i class="icon mdi mdi-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《计算机系统结构 复习笔记》 — 小灰灰灰灰的博客&url=https://blog.lyh543.cn/computer-science/computer-architecture/&via=https://blog.lyh543.cn" data-title=" Twitter">
          <i class="icon mdi mdi-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.lyh543.cn/computer-science/computer-architecture/" data-title=" Google+">
          <i class="icon mdi mdi-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-lg mdi mdi-share-variant"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/computer-science/parallel-and-distributed-computing/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon mdi mdi-chevron-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">并行计算 课程笔记</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/back-end/onedrive-rest-api/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-lg icon-pl mdi mdi-chevron-right"></i></div>
        <h4 class="title">后端利用 REST API 对接 Onedrive</h4>
      </a>
    </div>
  
</nav>



    

















<section class="comments" id="comments">
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
        var id = location.pathname
        if (location.pathname.length > 50) {
          id = location.pathname.replace(/\/\d+\/\d+\/\d+\//, '').replace('/', '').substring(0, 50)
        }
        const gitalk = new Gitalk({
          clientID: 'ec7daa4e047c3c30570d',
          clientSecret: '025a9e40a1d101f28fd1a945d286a819e9fa1c3d',
          repo: 'lyh543.github.io',
          owner: 'lyh543',
          admin: ['lyh543'],
          id: id,      // Ensure uniqueness and length less than 50
          title: document.title.split('|')[0],
          distractionFreeMode: false  // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    </script>
</section>




</article>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg mdi mdi-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>lyh543 &copy; 2019 - 2021</span>
            <span>
                
                <a href="http://www.miitbeian.gov.cn/" target="_blank">蜀ICP备19034464号</a><br>
                
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg mdi mdi-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.lyh543.cn/computer-science/computer-architecture/&title=《计算机系统结构 复习笔记》 — 小灰灰灰灰的博客&pic=https://blog.lyh543.cn/img/avatar.png" data-title="微博">
          <i class="icon mdi mdi-sina-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.lyh543.cn/computer-science/computer-architecture/&title=《计算机系统结构 复习笔记》 — 小灰灰灰灰的博客&source=" data-title=" QQ">
          <i class="icon mdi mdi-qqchat"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.lyh543.cn/computer-science/computer-architecture/" data-title=" Facebook">
          <i class="icon mdi mdi-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《计算机系统结构 复习笔记》 — 小灰灰灰灰的博客&url=https://blog.lyh543.cn/computer-science/computer-architecture/&via=https://blog.lyh543.cn" data-title=" Twitter">
          <i class="icon mdi mdi-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.lyh543.cn/computer-science/computer-architecture/" data-title=" Google+">
          <i class="icon mdi mdi-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJklEQVR42u3aza6CMBAGUN7/pbmJW6/lmyma0J6ujBLpYTF0fo4jXudr5b+eb+v9++T6mxcGBsZjGedwvW/00+fxv326Jvn/5D8xMDB2YIzDaDXgjrebbDrfGwYGBkYSRj+F1DEJAwMD45cBd+b4mCS9GBgYGHkSO5PoVktvX8zFMTAwHsioNgZ++fmL/Q0MDIyHMM7W6qW+vUAc7QcDA2NpxviINhOI84ZBr815JF0IDAyMJRjVIto8LBkCS5LVf94bGBgYGzDy8tkMu/prdF8MDIwNGNVxh17Rf2bM4uLwioGBsTSjGuyq4Thvi84cJTEwMNZmVEv2zXpeEJrz/URJLAYGxnKM3rbykJq3EPKgjIGBsQ+jd4M8TFcbAHniWjggYmBgPJwxvkH1OFhtSd4V4jEwMPZk9EYiemNhN1AxMDC2ZBRahsVyW6+Sf/GAMDAwlmbkiehRXL0Amt8dAwNjN8bMWWtmIKN3l/KIGAYGxhKMZCt5uT/f6MyQx0ULEwMDY2lGchSbD529d8LFuwIDA2MDRnWEotfyTEYrekdSDAyMtRk9TF5cq4bdXiEPAwNjVcZZXNWjYbV52WxkYmBgLM2otiRnkthesoqBgYGRlP7vah5UBynyazAwMPZh9IJsHqCrYbeZhWNgYGDEIxTzLckyGAMDAyMe8KoWzm4rrmFgYGzAqA5DVA9/OfjoLQwMjKUZ1cbA/MPKA33yuDEwMJZm/AFstmqYeG5JBwAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>










</body>
</html>
