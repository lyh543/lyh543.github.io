<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>后端利用 REST API 对接 Onedrive | 小灰灰灰灰的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="后端,Microsoft">
    <meta name="description" content="最近写的后端项目需要云盘，由于各种原因，最终选择了 Onedrive。Onedrive 的一个优点是文档是中文的，但缺点是中文也看不懂。。。。 于是借助文档、博客、示例代码等等，慢慢摸索过来，并把摸索的这个过程形成一篇博文。 注册应用、用户登录授权 参考博客：zhangguanzhang’s Blog参考文档：Microsoft Graph 中的 OneDrive 授权和登录  Onedrive">
<meta property="og:type" content="article">
<meta property="og:title" content="后端利用 REST API 对接 Onedrive">
<meta property="og:url" content="https://blog.lyh543.cn/back-end/onedrive-rest-api/index.html">
<meta property="og:site_name" content="小灰灰灰灰的博客">
<meta property="og:description" content="最近写的后端项目需要云盘，由于各种原因，最终选择了 Onedrive。Onedrive 的一个优点是文档是中文的，但缺点是中文也看不懂。。。。 于是借助文档、博客、示例代码等等，慢慢摸索过来，并把摸索的这个过程形成一篇博文。 注册应用、用户登录授权 参考博客：zhangguanzhang’s Blog参考文档：Microsoft Graph 中的 OneDrive 授权和登录  Onedrive">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.lyh543.cn/images/cc719c616ef24cdf4c51997fcbf6c55edf234453c73ea79b81684c8fea1b6d8e.png">
<meta property="article:published_time" content="2021-02-25T08:41:13.000Z">
<meta property="article:modified_time" content="2021-09-11T12:19:35.007Z">
<meta property="article:author" content="lyh543">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="Microsoft">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.lyh543.cn/images/cc719c616ef24cdf4c51997fcbf6c55edf234453c73ea79b81684c8fea1b6d8e.png">
    
        <link rel="alternate" type="application/atom+xml" title="小灰灰灰灰的博客" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.png">
    <link rel="stylesheet" href="/css/style.css?v=1.7.2">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu"  >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="mdi mdi-close icon-lg"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">lyh543</h5>
          <a href="mailto:lyh543@outlook.com" title="lyh543@outlook.com" class="mail">lyh543@outlook.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg mdi mdi-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg mdi mdi-archive"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg mdi mdi-tag-multiple"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg mdi mdi-format-list-bulleted-square"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/lyh543" target="_blank" >
                <i class="icon icon-lg mdi mdi-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg mdi mdi-menu"></i>
        </a>
        <div class="flex-col header-title ellipsis">后端利用 REST API 对接 Onedrive</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg mdi mdi-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg mdi mdi-magnify"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg mdi mdi-share-variant"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">后端利用 REST API 对接 Onedrive</h1>
        <h5 class="subtitle">
            
                <time datetime="2021-02-25T08:41:13.000Z" itemprop="datePublished" class="page-time">
  2021-02-25
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#注册应用、用户登录授权"><span class="post-toc-text">注册应用、用户登录授权</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#在-Azure-创建应用"><span class="post-toc-text">在 Azure 创建应用</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#用户在浏览器登录，获取-auth-token"><span class="post-toc-text">用户在浏览器登录，获取 auth_token</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#用-auth-token-换-access-token-和-refresh-token"><span class="post-toc-text">用 auth_token 换 access_token 和 refresh_token</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#用-refresh-token-换新的-access-token-和新的-refresh-token"><span class="post-toc-text">用 refresh_token 换新的 access_token 和新的 refresh_token</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Django-实现"><span class="post-toc-text">Django 实现</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#在前后端分离的情况下使用-Onedrive-API"><span class="post-toc-text">在前后端分离的情况下使用 Onedrive API</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#上传"><span class="post-toc-text">上传</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#前端交互"><span class="post-toc-text">前端交互</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#下载"><span class="post-toc-text">下载</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#永久链接"><span class="post-toc-text">永久链接</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#临时链接"><span class="post-toc-text">临时链接</span></a></li></ol></li></ol></li></ol>
        </nav>
    </aside>


<article id="post-back-end/onedrive-rest-api"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">后端利用 REST API 对接 Onedrive</h1>
        <div class="post-meta">
            <time class="post-time" title="2021-02-25 16:41:13" datetime="2021-02-25T08:41:13.000Z"  itemprop="datePublished">2021-02-25</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>最近写的后端项目需要云盘，由于各种原因，最终选择了 Onedrive。Onedrive 的一个优点是文档是中文的，但缺点是中文也看不懂。。。。</p>
<p>于是借助文档、博客、示例代码等等，慢慢摸索过来，并把摸索的这个过程形成一篇博文。</p>
<h2 id="注册应用、用户登录授权"><a href="#注册应用、用户登录授权" class="headerlink" title="注册应用、用户登录授权"></a>注册应用、用户登录授权</h2><blockquote>
<p>参考博客：<a href="https://zhangguanzhang.github.io/2020/02/27/microsoft-graph-for-onedrive/" target="_blank" rel="noopener">zhangguanzhang’s Blog</a><br>参考文档：<a href="https://docs.microsoft.com/zh-cn/onedrive/developer/rest-api/getting-started/graph-oauth?view=odsp-graph-online" target="_blank" rel="noopener">Microsoft Graph 中的 OneDrive 授权和登录</a></p>
</blockquote>
<p>Onedrive 的认证（以及 MS 家的其他功能）都统一使用 Microsoft Graph 进行认证，而 Microsoft Graph 似乎只支持 OAuth2（必须让用户在浏览器完成登录，不能拿到密码然后在后台登录），不支持 OAuth1（可以在后台利用用户密码发起请求完成登录），所以会麻烦一些。</p>
<h3 id="在-Azure-创建应用"><a href="#在-Azure-创建应用" class="headerlink" title="在 Azure 创建应用"></a>在 Azure 创建应用</h3><p>第一件事，是按照上面的博客所说，注册应用。这个应用其实就是一个 API，以下引用并修改了 <a href="https://zhangguanzhang.github.io/2020/02/27/microsoft-graph-for-onedrive/" target="_blank" rel="noopener">zhangguanzhang’s Blog</a>：</p>
<p>我们首先要创建一个应用程序。</p>
<blockquote>
<p><a href="https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" rel="noopener">https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade</a></p>
</blockquote>
<p>到上面链接里去注册一个应用程序，属性为：</p>
<ul>
<li>受支持的帐户类型记得选 <code>任何组织目录(任何 Azure AD 目录 - 多租户)中的帐户和个人 Microsoft 帐户(例如，Skype、Xbox)</code></li>
<li>重定向 URI (可选) 我用的是 <code>http://localhost:8000/getAToken</code>，在摸索的时候这个随便写就行。另外，这个值要存在代码里，命名为 <code>redirect_uri</code>。</li>
</ul>
<p>然后设置权限。点击左边侧边栏的 “API 权限”，点击中间的“添加权限”，然后在右边点“Microsoft Graph” - “委托的权限”，搜索并找到以下三个权限，勾选上。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Files</span><span class="selector-class">.ReadWrite</span></span><br><span class="line"><span class="selector-tag">Files</span><span class="selector-class">.ReadWrite</span><span class="selector-class">.All</span></span><br><span class="line"><span class="selector-tag">offline_access</span></span><br></pre></td></tr></table></figure>

<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="../../images/cc719c616ef24cdf4c51997fcbf6c55edf234453c73ea79b81684c8fea1b6d8e.png" alt="勾选权限" title="">
                </div>
                <div class="image-caption">勾选权限</div>
            </figure>

<p>然后在侧边栏的“概述”里面，把应用程序(客户端) ID 复制下来（在代码里存为 <code>client_id</code>）。</p>
<p>然后在侧边栏“证书和密码”里面，点击“新客户端密码”，生成一个 ID 和值，把值存到代码里，命名为 <code>client_secret</code>。</p>
<h3 id="用户在浏览器登录，获取-auth-token"><a href="#用户在浏览器登录，获取-auth-token" class="headerlink" title="用户在浏览器登录，获取 auth_token"></a>用户在浏览器登录，获取 auth_token</h3><p>在 Azure 创建应用以后，就是授权直至拿到 <code>refresh_token</code> 的过程。这个过程就是参考 <a href="https://docs.microsoft.com/zh-cn/onedrive/developer/rest-api/getting-started/graph-oauth?view=odsp-graph-online" target="_blank" rel="noopener">Microsoft Graph 中的 OneDrive 授权和登录</a> 了，这里我用 Python requests 实现。</p>
<blockquote>
<p>现在文档迁移到了 <a href="https://docs.microsoft.com/zh-cn/graph/auth/" target="_blank" rel="noopener">Microsoft Graph 身份验证概述</a>而且更加详细了。而上述链接不再提供中文文档。</p>
</blockquote>
<p>首先设置上述变量：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">headers = &#123;<span class="string">'Content-Type'</span>:<span class="string">'application/x-www-form-urlencoded'</span>&#125;</span><br><span class="line">scope = <span class="string">"Files.ReadWrite offline_access"</span></span><br><span class="line"></span><br><span class="line">client_id = <span class="string">"3aea792a-f5f5-49a6-b64d-e1a45d375323"</span></span><br><span class="line">redirect_uri = <span class="string">"http://localhost:8000/getAToken"</span></span><br><span class="line">client_secret = <span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></span><br></pre></td></tr></table></figure>

<p>然后是生成登录链接。这个链接需要在浏览器里访问然后输入账号密码，于是就不用 <code>requests.get</code> 而是把链接 print 出来，我们复制到浏览器里面。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">login_link = <span class="string">f"https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=<span class="subst">&#123;client_id&#125;</span>&amp;scope=<span class="subst">&#123;scope&#125;</span>&amp;response_type=code&amp;redirect_uri=<span class="subst">&#123;redirect_uri&#125;</span>"</span></span><br><span class="line">print(login_link)</span><br></pre></td></tr></table></figure>

<p>打开 print 的链接，成功登录并授权后，跳转到 <code>localhost</code>，其中的参数的 <code>code</code> 字段就是我们需要的 <code>auth_token</code>，729个字符，有点长。</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8000/getAToken?code=0.AAAApOutbSzcpEiz8KuV1mGJ2ip56jr19aZJtk3hpF03UyM-AI4.AQABAAIAAAD--DLA3VO7QrddgJg7Wevry9C8xxU0YmDl1t3kRL1Rt8c4ZYINbxBW_X7KGMwL80bFg2I99rHKlQuC_bwGWIMjn1C4GjZg8fR2v2r<span class="string">-9</span>J6fffSYUVMmrA5tGJ<span class="string">-7</span>AUyulg076ViCOLWvtDzUh1T09f3Tt2Q8TpgCgO8P<span class="string">-0</span>PqGMPqNOivzAxQz8WH5ZKSTMaI7WeOSBGe9yrpdjskO4pJrZv62E-jl2udaTBSXJAG4hKc18feCvuhJk27gT4H1W7ZiONqwMMkpzK6nlMhBgRP7-hTBNIU82Y0ASNOsOu2aAzrCQJmmbDdPHvsEYIq5jDnlOqeoNNFh<span class="string">-0</span>v_AEbf-YfUfvIxN79eGpgrXvH19sLstDqFagJaOayNm6sf4HHuo2ikAot5kLZoBwYus57BaWeLI2IA_jDKd9T899Pv_Gfc_fwkgI9PynaHfoDRHb9A<span class="string">-6</span>fXaJYPE5IYkTEnunNDaBf6jKtoTPub5LFIZv3OP38c3zJrTBZL5Wr5dpo3-pa0FFkbYPgHGC5APlWFNiBx-OECd4OJnbdzM7hrA2YzCLa6Bwl7SG4KTVXv2fwW1gFLgCZdI_xYBEDHfYuKUnlC5eqcebWwtkfJ8roFj9p3hzJ_GQSgEKjTgrdSUMaxrYwhSnAzS06H4BqnLKL-FrKsDBWJXuAIAA&amp;session_state=697ec6eb-a4b9<span class="string">-4567</span><span class="string">-9873</span><span class="string">-6065</span>f156164b#</span><br></pre></td></tr></table></figure>

<p>在之后开发 WebApp 时，我们需要把 <code>redirect_url</code> 设置为我们能路由到的链接，在路由到的 View 中获取 uri 参数，就可以获得 <code>auth_token</code> 了。不过现在还是手动赋值吧。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 赋值</span></span><br><span class="line">auth_token = <span class="string">"0.AAAApOutbSzcpEiz8KuV1mGJ2ip56jr19aZJtk3hpF03UyM-AI4.AQABAAIAAAD--DLA3VO7QrddgJg7WevrnDiEeOedZvv94_iCOZdHtunnh-HD4-yA7CnKCnlskkTcXuD_nVujxrzDErLOPO5Kdba-gLFaUgOCxScnphpTmaR-bJbb6KCOJ6WEsecTZhdoBVvhgG8SzPAmolHemGaOOymSx1L3opaGXSo6YolsgwSCYcokocf9jl9Jq8pOAfg4tuZTYh1uX6f-IvQgLoIhUhE8i7GoaLIFhel9ICjiWgO9imtgNiLIjMX-MMRxqEKbcvbjVi9vnat1LE29v7uX_0Ogs6feGFzKEZOvT8pNlbm1t0frSwSIktQeIELEU3kzbDX7TEp1b_Cguj2u7wqF-kLv3P9w2_Gzhi-lzdRph1h9SW-RFYyWtdoCfhQgFf5m8K7aUGUEKgDK0RomoPvuZ1jfoNxe5JWQdcHqNo-LcHblYGRI1azy-p1fp28aBB6qKZ_0pcRTb4BrU5qLi9ze4RJ5kPajodTSSloUSVkf64B9OEdPeBvT8XU8_to0aVeHXOUTlsgVSlliatLPx9pFhsOZ4ec2-7fQMr8_CBhPlY4rjMfl8plefsfwcIsDBc0PRPITcsxA7OYSxZXvSchHA6XmCSzdl1413mTh7d0cvLYnBmzJm1tc6z6PEW270mtL_enHuzbtZpK9D1Epu0HIIAA"</span></span><br></pre></td></tr></table></figure>

<h3 id="用-auth-token-换-access-token-和-refresh-token"><a href="#用-auth-token-换-access-token-和-refresh-token" class="headerlink" title="用 auth_token 换 access_token 和 refresh_token"></a>用 auth_token 换 access_token 和 refresh_token</h3><p>赋值以后，就可以请求拿 <code>access_token</code> 和 <code>refresh_token</code> 了。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">headers=&#123;<span class="string">'Content-Type'</span>:<span class="string">'application/x-www-form-urlencoded'</span>&#125;</span><br><span class="line">response = requests.post(</span><br><span class="line">    <span class="string">'https://login.microsoftonline.com/common/oauth2/v2.0/token'</span>,</span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">'client_id'</span>: client_id,</span><br><span class="line">        <span class="string">'redirect_uri'</span>: redirect_uri,</span><br><span class="line">        <span class="string">'client_secret'</span>: client_secret,</span><br><span class="line">        <span class="string">'code'</span>: auth_token,</span><br><span class="line">        <span class="string">'grant_type'</span>: <span class="string">'authorization_code'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    headers=headers)</span><br><span class="line"></span><br><span class="line">response                <span class="comment"># &lt;Response [200]&gt;</span></span><br><span class="line">eval(response.content)</span><br><span class="line"><span class="comment"># &#123;'token_type': 'Bearer',</span></span><br><span class="line"><span class="comment">#  'scope': 'Files.ReadWrite profile openid email',</span></span><br><span class="line"><span class="comment">#  'expires_in': 3599,</span></span><br><span class="line"><span class="comment">#  'ext_expires_in': 3599,</span></span><br><span class="line"><span class="comment">#  'access_token': 'eyJ0eXAiOiJKV1QiLCJub25jZSI6ImZCREdZc3JfSzVYLXBkU2o5ZWotUUJMc2JGRGFDVGFBQ0lvSk90T3I2UlEiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiIwMDAwMDAwMy0wMDAwLTAwMDAtYzAwMC0wMDAwMDAwMDAwMDAiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC82ZGFkZWJhNC1kYzJjLTQ4YTQtYjNmMC1hYjk1ZDY2MTg5ZGEvIiwiaWF0IjoxNjE0MjYyMDgzLCJuYmYiOjE2MTQyNjIwODMsImV4cCI6MTYxNDI2NTk4MywiYWNjdCI6MCwiYWNyIjoiMSIsImFjcnMiOlsidXJuOnVzZXI6cmVnaXN0ZXJzZWN1cml0eWluZm8iLCJ1cm46bWljcm9zb2Z0OnJlcTEiLCJ1cm46bWljcm9zb2Z0OnJlcTIiLCJ1cm46bWljcm9zb2Z0OnJlcTMiLCJjMSIsImMyIiwiYzMiLCJjNCIsImM1IiwiYzYiLCJjNyIsImM4IiwiYzkiLCJjMTAiLCJjMTEiLCJjMTIiLCJjMTMiLCJjMTQiLCJjMTUiLCJjMTYiLCJjMTciLCJjMTgiLCJjMTkiLCJjMjAiLCJjMjEiLCJjMjIiLCJjMjMiLCJjMjQiLCJjMjUiXSwiYWlvIjoiRTJaZ1lORGY2OWJFVUxnd3BkR0FMM2J5aHZRZCsxNkg2THppdUwvNGxPejYrR25mbE1VQSIsImFtciI6WyJwd2QiXSwiYXBwX2Rpc3BsYXluYW1lIjoi6Ziu6JaH6JaH54K55ZCN5ZWmIiwiYXBwaWQiOiIzYWVhNzkyYS1mNWY1LTQ5YTYtYjY0ZC1lMWE0NWQzNzUzMjMiLCJhcHBpZGFjciI6IjEiLCJpZHR5cCI6InVzZXIiLCJpcGFkZHIiOiIxNTQuMTcuNy44NCIsIm5hbWUiOiLnlLXlrZDnp5HmioDlpKflraZNU0MiLCJvaWQiOiIyZDU1MTQyNS01Mzk2LTQxNTktOTQ1MC0wNzU2MzdiMDE2N2IiLCJwbGF0ZiI6IjMiLCJwdWlkIjoiMTAwMzIwMDA1N0RCODYzRSIsInJoIjoiMC5BQUFBcE91dGJTemNwRWl6OEt1VjFtR0oyaXA1NmpyMTlhWkp0azNocEYwM1V5TS1BSTQuIiwic2NwIjoiRmlsZXMuUmVhZFdyaXRlIHByb2ZpbGUgb3BlbmlkIGVtYWlsIiwic3ViIjoid2R3RDhmLXM0ajJDWHlmQ2phOWd1LXpVdk91V0ZUWFg2bXk1d0ZGODROcyIsInRlbmFudF9yZWdpb25fc2NvcGUiOiJBUyIsInRpZCI6IjZkYWRlYmE0LWRjMmMtNDhhNC1iM2YwLWFiOTVkNjYxODlkYSIsInVuaXF1ZV9uYW1lIjoidWVzdGNtc2NAZGVtbzRjLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6InVlc3RjbXNjQGRlbW80Yy5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJFQ0Vaei1LeEprZVhOMDRTYlVNa0FBIiwidmVyIjoiMS4wIiwid2lkcyI6WyJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX3N0Ijp7InN1YiI6Inl0WGtlTWM0dFVnV3dpMmJLbS1xc3JMazJuY3Zjc3lrYVFYcm1Zdm1lRE0ifSwieG1zX3RjZHQiOjE0OTcyNDg0OTN9.EjpbLnqwdSsjeQwy5oVWjqHfSjFyHwQHcwNNvVhq8w9J96PQEjx6xpyIc-VgrQc0h1DdfikzyOVkMEHSVifM_KZoaaUIcW3T4xgXjgZVeEtznAKEqSDB4PN5qR45hsZbJLoVFBxaRZsQrEiPK7m2F4-4_VCK-I6Dfhvhm2_XTiBXnbqSsQ87VhF01BqSVXBIlJwSS1mQKEYHJGCjKnTB5yToDzJvoh4p7GGY3SCmfWY-pDMsAvMlJbErfhXh9Hxc41eBESSEmoajZAnxFOJU5LRtVHqPQW6PwlSTHL2nlGfdXFpspTc6hy4pSyVDNq6I3HJRFXl1cW0L6DjD2FoWMw',</span></span><br><span class="line"><span class="comment">#  'refresh_token': '0.AAAApOutbSzcpEiz8KuV1mGJ2ip56jr19aZJtk3hpF03UyM-AI4.AgABAAAAAAD--DLA3VO7QrddgJg7WevrAgDs_wQA9P_bTRjPRZzMorqH901Y19Ppp0sTRQdBBKFPHBjjxCNhD6fQlBevSxmidflskapxgyxbPlJysKnmnXMvEw6oy9tTRGn5QAB6kuYsP9BVFNiEpqeyqyyABuuiZZXHfMVSiqcIuUYdC5Cbt-meckpgVSC9Dfhvr50ilZ99m5iUHDkFVJLdPQLlrgdHqV8Mhe1V6Eh7F5Mfqrg1xb-K-QLZ3EGrcBUsDarXTkKPWP_9rKgukN_PTFerEBaM90u--8iytv0RJAui31HTa4yIInU0g7vZ16fhaEvJSXQjMSc5TYeepCHkK2fi3UpJe8TOoQ-qpORU_CJl83YMF59_enWxi0f_5ouV_9CPpeZ0xReU1Nb2y4g7uBYVPPNyroVlSmU0zV9c_rgs-dkSXK3b6r-AN-c5msS_ZoGvjiL3qBevNKo3Ws4w4IBWO-wQV8arNtNSuCAv5u9z41gITSDDg1Z8EYizTjQHjVaP095n5CWcBghqboVL4H2AAzW1SIgDJIs7ybwhg0oVsjUW4s9FQguPe9lj3HrAHzk5_NMRJsuGIZpDJ3ENz2pldXaRBqk42X07_y549Aw3qmgd8UY2KqsbA0EMNharkf-3q0_4AyeyxtqSqJETF5F3wy0bQ0RViS5W5mVobaRU90ia-zHzOjvXtxvenaY-r2ANjh_yg3qiV2D8Z7ODW50YzLL9SgiFqMm7zg7RYd4jjpdTYOik2yCX7cn_sSaA29KAqkbWKZNqX2Ds_ZRyby8RYeHBOC_I0XbrngLHnTszik-eKI3rHBv7UdTXCM9PHJwl2X4pocIREzfFPOTnLauiyfAS_zpb2Lsw8exVEqIpesVZt1S8uMvaEPctk7P22myx-vdxrk937c9z368vGpN6dBS--LPq5ZaxX9TuxCRbfCesT6KpkgLMq6Ywho59Tc6cAeE18sw'&#125;</span></span><br></pre></td></tr></table></figure>

<p>好耶！</p>
<p>MS 还提供了网址对 access_token 进行解密：<code>https://jwt.ms/</code>。</p>
<h3 id="用-refresh-token-换新的-access-token-和新的-refresh-token"><a href="#用-refresh-token-换新的-access-token-和新的-refresh-token" class="headerlink" title="用 refresh_token 换新的 access_token 和新的 refresh_token"></a>用 refresh_token 换新的 access_token 和新的 refresh_token</h3><p>然后，我们把上面 response 里的 <code>refresh_token</code> 取出来，然后请求刷新 <code>access_token</code> 和 <code>refresh_token</code>：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">refresh_token = eval(response.content)[<span class="string">'refresh_token'</span>]</span><br><span class="line"></span><br><span class="line">response_refresh = requests.post(</span><br><span class="line">    <span class="string">'https://login.microsoftonline.com/common/oauth2/v2.0/token'</span>,</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'client_id'</span>: client_id,</span><br><span class="line">        <span class="string">'redirect_uri'</span>: redirect_uri,</span><br><span class="line">        <span class="string">'client_secret'</span>: client_secret,</span><br><span class="line">        <span class="string">'refresh_token'</span>: refresh_token,</span><br><span class="line">        <span class="string">'grant_type'</span>: <span class="string">'refresh_token'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    headers = headers)</span><br><span class="line"></span><br><span class="line">response        <span class="comment"># &lt;Response [200]&gt;</span></span><br><span class="line">eval(response.content)</span><br><span class="line"><span class="comment"># &#123;'token_type': 'Bearer',</span></span><br><span class="line"><span class="comment">#  'scope': 'Files.ReadWrite profile openid email',</span></span><br><span class="line"><span class="comment">#  'expires_in': 3599,</span></span><br><span class="line"><span class="comment">#  'ext_expires_in': 3599,</span></span><br><span class="line"><span class="comment">#  'access_token': 'eyJ0eXAiOiJKV1QiLCJub25jZSI6ImhFSy1UT0xyZC1WZVNQOGVCU3plTURzeW1EODk5RWdlMEJzVDM5ak5uZEkiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiIwMDAwMDAwMy0wMDAwLTAwMDAtYzAwMC0wMDAwMDAwMDAwMDAiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC82ZGFkZWJhNC1kYzJjLTQ4YTQtYjNmMC1hYjk1ZDY2MTg5ZGEvIiwiaWF0IjoxNjE0MjYyNjg4LCJuYmYiOjE2MTQyNjI2ODgsImV4cCI6MTYxNDI2NjU4OCwiYWNjdCI6MCwiYWNyIjoiMSIsImFjcnMiOlsidXJuOnVzZXI6cmVnaXN0ZXJzZWN1cml0eWluZm8iLCJ1cm46bWljcm9zb2Z0OnJlcTEiLCJ1cm46bWljcm9zb2Z0OnJlcTIiLCJ1cm46bWljcm9zb2Z0OnJlcTMiLCJjMSIsImMyIiwiYzMiLCJjNCIsImM1IiwiYzYiLCJjNyIsImM4IiwiYzkiLCJjMTAiLCJjMTEiLCJjMTIiLCJjMTMiLCJjMTQiLCJjMTUiLCJjMTYiLCJjMTciLCJjMTgiLCJjMTkiLCJjMjAiLCJjMjEiLCJjMjIiLCJjMjMiLCJjMjQiLCJjMjUiXSwiYWlvIjoiQVNRQTIvOFRBQUFBcFB5WUtCamlUK2kxWnVaY3BLNitudHh2ektkMGovNGtvSVhGVnBwOE5vQT0iLCJhbXIiOlsicHdkIl0sImFwcF9kaXNwbGF5bmFtZSI6IumYruiWh-iWh-eCueWQjeWVpiIsImFwcGlkIjoiM2FlYTc5MmEtZjVmNS00OWE2LWI2NGQtZTFhNDVkMzc1MzIzIiwiYXBwaWRhY3IiOiIxIiwiaWR0eXAiOiJ1c2VyIiwiaXBhZGRyIjoiMTU0LjE3LjcuODQiLCJuYW1lIjoi55S15a2Q56eR5oqA5aSn5a2mTVNDIiwib2lkIjoiMmQ1NTE0MjUtNTM5Ni00MTU5LTk0NTAtMDc1NjM3YjAxNjdiIiwicGxhdGYiOiIzIiwicHVpZCI6IjEwMDMyMDAwNTdEQjg2M0UiLCJyaCI6IjAuQUFBQXBPdXRiU3pjcEVpejhLdVYxbUdKMmlwNTZqcjE5YVpKdGszaHBGMDNVeU0tQUk0LiIsInNjcCI6IkZpbGVzLlJlYWRXcml0ZSBwcm9maWxlIG9wZW5pZCBlbWFpbCIsInN1YiI6Indkd0Q4Zi1zNGoyQ1h5ZkNqYTlndS16VXZPdVdGVFhYNm15NXdGRjg0TnMiLCJ0ZW5hbnRfcmVnaW9uX3Njb3BlIjoiQVMiLCJ0aWQiOiI2ZGFkZWJhNC1kYzJjLTQ4YTQtYjNmMC1hYjk1ZDY2MTg5ZGEiLCJ1bmlxdWVfbmFtZSI6InVlc3RjbXNjQGRlbW80Yy5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJ1ZXN0Y21zY0BkZW1vNGMub25taWNyb3NvZnQuY29tIiwidXRpIjoiUjZERXd0TWlBazJsaTVXaWRIOGpBQSIsInZlciI6IjEuMCIsIndpZHMiOlsiYjc5ZmJmNGQtM2VmOS00Njg5LTgxNDMtNzZiMTk0ZTg1NTA5Il0sInhtc19zdCI6eyJzdWIiOiJ5dFhrZU1jNHRVZ1d3aTJiS20tcXNyTGsybmN2Y3N5a2FRWHJtWXZtZURNIn0sInhtc190Y2R0IjoxNDk3MjQ4NDkzfQ.GdgiFzmdXNFuBqaDSsLzalQU0QULm1fAYZw-mKw5D1KdR4j9WSl6sIa9vPcuogg1x7oLMujcgfdyY0Cf4KNLk3fQ3vzLo395R5GDbg-djBREWCBBgFvcgbu8AyH7yj6MxdXsY59U9nFqVdeIfqEZxxxFCT2F2Nc-CfrDsI8PZQL3kn0VFcvSiUwuOMlH06ydKwyyBNhCRh5yc9x32XWwlRde-GPZCd1SdyvcPvo_mUcEJxh97tRfehHNTDltXGFsAZqcYaz18iJk9MqZ4tlyOIIWPX_lXGRtNe2dUDQE6g6znWY0ClGvU3X9mdScUUtfblmnfmzMj-ECBkAjmjKBnA',</span></span><br><span class="line"><span class="comment">#  'refresh_token': '0.AAAApOutbSzcpEiz8KuV1mGJ2ip56jr19aZJtk3hpF03UyM-AI4.AgABAAAAAAD--DLA3VO7QrddgJg7WevrAgDs_wQA9P89XPzxfnsn8nWMuIFittfpaEqpEzvy5sSPvkBHSIgu_y7Ppazm1F3l2nJ6hEWraRomalXRdwDi1Y78yIC_yA1xAspMEEuoxejDjoBhcWqOWLUTfXkfKk7i6pugNA-a_GOH9-EvKc_g9NvuCK4QgK6FQadMUf62wpoCkB53kgnH8GtOYKW34AutKaFi-N3v8RstrJRtsT3ZXanWmlA_q2WbDSou3-L_H6MS62u3Fr_mxnaKx4lKyy4cXaWbb_29dbx_yVO4zd_x5WHbcnrkfk3qoxD_b5kxHOMlKpVHtX_NthQvg8ZekDZ0pLawRsCDhJ8NFGwJvIXKxaMAyCbhHsyklnw97sU3M9jg08oAbaoQ0JA7eDZ4gd4juSzvkdGVK77unbROzOC1GjR12MWd9n_lYz4KMv_ErKx8wN2MHMAVK-QBBkJUsdB4JbBzSVgneD3jaDvWQRyz4BJMMx5e8qjR-bRwCBjm4Y1aK7vYNBGl2DVR1sVbf8eRZje6AxRQYy3rjdDod_30IqjNhDzX-eILlXR570RmoOGZgaWNPf-3-_3AaDGtsBE8tlCGux8lIR7jIxIKeBjfp1S5ymiofVirYYJiAg17KHy_W9FHUHS9CIs6CrKEvPesjDuFmerE14hzmJ4LCJarZSy2AsV6XiTMmamzaKX-WwFSzGXpipOwPbcO4tjcq5tFWz7-1TzDKsaAyvvh-K3fQiD2GUAv4v9zgRVczUQXN0Z37RULpnSGhj2eXaOenNXl9EoIgBLKXpj-lOshEyRbL2P3WzgvS1MUaXH31IHt-NiQuMpmeBfGg-gxrc9inQ0n7ATfD0T5vZ8YodjccP_rJvzI1Ntfl1yQs0g2h2JyZp694MOqc7Clv8W0P8F-uJIVWK2yv3iPRz-_nBM3im0A9OrCaugArHGPJ9gRt03nHzUHeJIAMc2Xqg'&#125;</span></span><br></pre></td></tr></table></figure>

<p>至此，关于 token 的申请方法就讲完了。</p>
<h3 id="Django-实现"><a href="#Django-实现" class="headerlink" title="Django 实现"></a>Django 实现</h3><p>我把上面的过程改成了一个 <code>OnedriveAuthentication</code> 类（代码见 <a href="https://github.com/uestc-msc/uestcmsc_webapp_backend/blob/cc3c03b8e6526b73f40c0b1f1a7d182a8d318689/cloud/onedrive/auth.py" target="_blank" rel="noopener">GitHub</a>，views 部分在 <a href="https://github.com/uestc-msc/uestcmsc_webapp_backend/blob/cc3c03b8e6526b73f40c0b1f1a7d182a8d318689/cloud/views/login.py" target="_blank" rel="noopener">views.py</a> 中）。</p>
<p>另外，MS 也给了一个利用 <code>requests_oauthlib.OAuth2Session</code> 封装的<a href="https://github.com/microsoftgraph/python-sample-auth/blob/master/sample_requests.py" target="_blank" rel="noopener">示例</a>，也可以参考。</p>
<hr>
<p>另外需要注意的是，如果在 Django 后端中使用 <code>requests</code> 请求 Onedrive，会使得线程等待，在 Onedrive 相关请求并发量高的时候很容易造成数秒甚至数十秒的延迟。</p>
<p>可以在部署的时候使用更多线程缓解这个症状。想要根本改变这个问题，就不得不提到异步了。</p>
<p>异步请求可以使用 <code>aiohttp</code> 库。Django 3.1 也提供了异步视图的支持（但没有提供异步数据库访问的支持，不过也提供了临时解决办法）。但是，Django REST Framework 3.2.3 还不支持异步视图，想要使用异步视图，还得使用纯 Django 视图。</p>
<p>所以，目前我的解决办法，是把并发最高的一个 API 改写为纯 Django 视图然后异步化，并对该视图用到的 <code>requests</code> 请求改为 <code>aiohttp</code> 请求。</p>
<h2 id="在前后端分离的情况下使用-Onedrive-API"><a href="#在前后端分离的情况下使用-Onedrive-API" class="headerlink" title="在前后端分离的情况下使用 Onedrive API"></a>在前后端分离的情况下使用 Onedrive API</h2><p>完成登录授权，拿到 Access Token 以后，就可以用 MS Graph 的 API 进行操作了。可以在 <a href="https://developer.microsoft.com/zh-cn/graph/graph-explorer?request=me/drive/root/children&method=GET&version=v1.0" target="_blank" rel="noopener">Graph Explorer</a> 进行测试。</p>
<p>而具体使用方法，就直接看<a href="https://docs.microsoft.com/zh-cn/onedrive/developer/rest-api/?view=odsp-graph-online" target="_blank" rel="noopener">文档</a>啦。这文档蛮详细的，边写边看就行。</p>
<p>由于 REST API 的寻址部分比较麻烦，我使用 Python 对 API 进行了简单封装，代码在 <a href="https://github.com/uestc-msc/uestcmsc_webapp_backend/tree/master/cloud/onedrive/api" target="_blank" rel="noopener">GitHub</a>。</p>
<p>这里只写了自己在开发过程中遇到的一些场景，以及解决方案。</p>
<p>项目的场景是使用一个账户的云盘作为整个项目的共有云盘，文件上传、删除等操作全部交给后端完成。后端判断前端登录的用户权限后，使用该账户的 access_token 执行操作。</p>
<h3 id="上传"><a href="#上传" class="headerlink" title="上传"></a>上传</h3><p>为了省去文件经过后端服务器的流量，后端可以使用 Onedrive 的<a href="https://docs.microsoft.com/zh-cn/graph/api/driveitem-createuploadsession" target="_blank" rel="noopener">通过上传会话上传大文件</a> 方案上传文件。前后端和 Onedrive 的交互过程如下：</p>
<ol>
<li>在登陆状态下，前端向后端 <code>POST /api/cloud/file</code> 发起请求，后端请求 Onedrive 生成一个临时上传对话，并将 Onedrive 的应答（格式见上面的链接）转发给前端；</li>
<li>前端按照上面链接所述方法，直接向 Onedrive 上传文件。上传完成后，Onedrive 返回文件的 id 等信息，文件将位于 <code>/(应用文件夹)/temp/{userid}/</code> 文件夹；</li>
<li>前端根据需求（如上传沙龙相关文件、沙龙照片）向对应接口发起请求（请求需包含文件 id），后端将文件移动至每个功能对应的文件夹，并完成后续操作（录入数据库等）。</li>
</ol>
<h4 id="前端交互"><a href="#前端交互" class="headerlink" title="前端交互"></a>前端交互</h4><p>前端交互原理<del>很简单</del>好像也不简单，对于错误处理就更麻烦了，虽然 MS Graph 最后给了对各种错误处理的详细策略，但是没有示例代码还是很麻烦。</p>
<p>因此，这里放一个我的 JavaScript 实现，其中 <code>createUploadSession</code> 是创建上传会话的接口。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用后端接口，将文件上传至 onedrive。</span></span><br><span class="line"><span class="comment">// 参考文档：https://docs.microsoft.com/zh-cn/graph/api/driveitem-createuploadsession</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> res = <span class="keyword">await</span> createUploadSession(&#123;<span class="string">"filename"</span>: file.name&#125;);</span><br><span class="line">  <span class="keyword">const</span> uploadUrl = <span class="built_in">JSON</span>.parse(res.data).uploadUrl;</span><br><span class="line">  <span class="keyword">let</span> size = file.size;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> totalRetryTimes = <span class="number">5</span>;  <span class="comment">// 4xx 导致的上传失败的重试次数</span></span><br><span class="line">  <span class="keyword">const</span> firstDelay = <span class="number">1000</span>;    <span class="comment">// 5xx 导致的上传失败的第一次等待时间（之后采用 * 2 的指数退避策略）</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// MS 直接给了上传时错误处理的策略，nb！</span></span><br><span class="line">  <span class="comment">// https://docs.microsoft.com/zh-cn/graph/api/driveitem-createuploadsession#best-practices</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadPart</span>(<span class="params">start, end, retryTimes = <span class="number">0</span>, nextDelay = firstDelay</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// console.log(`uploadPart: start=$&#123;start&#125;, end=$&#123;end&#125;, retryTimes=$&#123;retryTimes&#125;, nextDelay=$&#123;nextDelay&#125;`);</span></span><br><span class="line">    <span class="keyword">let</span> headers = &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> status = <span class="number">0</span>;</span><br><span class="line">    headers[<span class="string">'Content-Range'</span>] = <span class="string">`bytes <span class="subst">$&#123;start&#125;</span>-<span class="subst">$&#123;end - <span class="number">1</span>&#125;</span>/<span class="subst">$&#123;size&#125;</span>`</span>;</span><br><span class="line">    headers[<span class="string">'Content-Type'</span>] = file.type;</span><br><span class="line">    <span class="keyword">let</span> config = &#123;</span><br><span class="line">      withCredentials: <span class="literal">false</span>,</span><br><span class="line">      timeout: <span class="number">0</span>,</span><br><span class="line">      headers</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      res = <span class="keyword">await</span> axios.put(uploadUrl, file.slice(start, end), config);</span><br><span class="line">      status = res.status;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      status = <span class="number">500</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status &gt;= <span class="number">500</span>) &#123;</span><br><span class="line">      <span class="comment">// 继续或重试由于连接中断或任意 5xx 错误而失败的上载</span></span><br><span class="line">      <span class="comment">// 请使用指数退避战略</span></span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">`上传失败，等待 <span class="subst">$&#123;nextDelay <span class="regexp">/ 1000&#125;s 后上传...`);</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">      await sleep(nextDelay);</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">      return await uploadPart(start, end, retryTimes, nextDelay * 2);</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">    &#125; else if (status &gt;= 200 &amp;&amp; status &lt; 300) &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">      /</span><span class="regexp">/ 成功上传该段，返回</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">      return res;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">    &#125; else &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">      /</span><span class="regexp">/ 对于其他错误，不应使用指数退避战略，而应限制尝试重试的次数</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">      if (retryTimes &gt; 0) &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">        if (retryTimes &gt; totalRetryTimes) &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">          console.warn(`上传失败 $&#123;retryTimes&#125; 次，取消上传`);</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">          throw res;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">        &#125; else &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">          console.warn(`上传失败 $&#123;retryTimes&#125; 次，重试中...`);</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">          return await uploadPart(start, end, retryTimes+1, nextDelay);</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">        &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">      &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">    &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp"></span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  let status = 0;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  let start = 0;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  /</span><span class="regexp">/ 200 为上传成功（覆盖），201 为上传成功（新建）</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  while (status !== 200 &amp;&amp; status !== 201) &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">    let end = Math.min(start + maxFileContentLength, file.size);</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">    res = await uploadPart(start, end);</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">    start = end;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">    status = res.status;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">  return res.data.id;</span></span></span></span><br><span class="line"><span class="string"><span class="subst"><span class="regexp">&#125;</span></span></span></span><br></pre></td></tr></table></figure>

<p>这段代码还没有加上传进度等功能，不过上传的大体思路就是这样的。</p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>为了省去文件经过后端服务器的流量，本后端只提供下载链接。由于 Onedrive API 限制，提供两种下载链接：</p>
<ul>
<li>永久链接，但需在浏览器中访问</li>
<li>临时链接（Onedrive 链接有效期 15min，但本后端提供即时获取链接并重定向的 REST API）</li>
</ul>
<h4 id="永久链接"><a href="#永久链接" class="headerlink" title="永久链接"></a>永久链接</h4><p>有网友发现，手动或<a href="https://docs.microsoft.com/zh-cn/graph/api/driveitem-createlink?view=graph-rest-1.0" target="_blank" rel="noopener">利用 Onedrive API</a> 生成分享链接后，在分享链接后追加 <code>?download=1</code> 参数，在浏览器访问该链接即可自动下载文件。</p>
<p>但该链接对应的 html 需要运行 JavaScript，因此不能通过 Python <code>requests</code> 或 JavaScript <code>XMLHTTPRequest</code> 直接下载。推荐使用后面的 API，或者在 JavaScript 使用 <code>window.open()</code> 在新窗口打开这个链接。</p>
<h4 id="临时链接"><a href="#临时链接" class="headerlink" title="临时链接"></a>临时链接</h4><p><a href="https://docs.microsoft.com/zh-cn/graph/api/driveitem-get-content" target="_blank" rel="noopener">利用 Onedrive API 下载文件</a> 时，响应报文为 <code>302 Found</code>，<code>Location</code> 为一个下载 URL。该 URL 仅在较短的一段时间 （几分钟后）内有效，不需要认证即可下载。</p>
<p>本后端提供 <code>/cloud/file/{id}/download/</code> API，该 API 调用上述 API 后将报文返回给前端。</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2021-09-11T12:19:35.007Z" itemprop="dateUpdated">2021-09-11 20:19:35</time>
</span><br>


        
    </div>
    
    <footer>
        <a href="https://blog.lyh543.cn">
            <img src="/img/avatar.png" alt="lyh543">
            lyh543
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Microsoft/" rel="tag">Microsoft</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.lyh543.cn/back-end/onedrive-rest-api/&title=《后端利用 REST API 对接 Onedrive》 — 小灰灰灰灰的博客&pic=https://blog.lyh543.cn/img/avatar.png" data-title="微博">
          <i class="icon mdi mdi-sina-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.lyh543.cn/back-end/onedrive-rest-api/&title=《后端利用 REST API 对接 Onedrive》 — 小灰灰灰灰的博客&source=" data-title=" QQ">
          <i class="icon mdi mdi-qqchat"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.lyh543.cn/back-end/onedrive-rest-api/" data-title=" Facebook">
          <i class="icon mdi mdi-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《后端利用 REST API 对接 Onedrive》 — 小灰灰灰灰的博客&url=https://blog.lyh543.cn/back-end/onedrive-rest-api/&via=https://blog.lyh543.cn" data-title=" Twitter">
          <i class="icon mdi mdi-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.lyh543.cn/back-end/onedrive-rest-api/" data-title=" Google+">
          <i class="icon mdi mdi-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-lg mdi mdi-share-variant"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/computer-science/computer-architecture/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon mdi mdi-chevron-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">计算机系统结构 复习笔记</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/back-end/handle-cors-and-csrf/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-lg icon-pl mdi mdi-chevron-right"></i></div>
        <h4 class="title">和 CSRF 与 CORS 斗智斗勇</h4>
      </a>
    </div>
  
</nav>



    

















<section class="comments" id="comments">
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>
        var id = location.pathname
        if (location.pathname.length > 50) {
          id = location.pathname.replace(/\/\d+\/\d+\/\d+\//, '').replace('/', '').substring(0, 50)
        }
        const gitalk = new Gitalk({
          clientID: 'ec7daa4e047c3c30570d',
          clientSecret: '025a9e40a1d101f28fd1a945d286a819e9fa1c3d',
          repo: 'lyh543.github.io',
          owner: 'lyh543',
          admin: ['lyh543'],
          id: id,      // Ensure uniqueness and length less than 50
          title: document.title.split('|')[0],
          distractionFreeMode: false  // Facebook-like distraction free mode
        })

        gitalk.render('gitalk-container')
    </script>
</section>




</article>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg mdi mdi-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>lyh543 &copy; 2019 - 2021</span>
            <span>
                
                <a href="http://www.miitbeian.gov.cn/" target="_blank">蜀ICP备19034464号</a><br>
                
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg mdi mdi-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.lyh543.cn/back-end/onedrive-rest-api/&title=《后端利用 REST API 对接 Onedrive》 — 小灰灰灰灰的博客&pic=https://blog.lyh543.cn/img/avatar.png" data-title="微博">
          <i class="icon mdi mdi-sina-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.lyh543.cn/back-end/onedrive-rest-api/&title=《后端利用 REST API 对接 Onedrive》 — 小灰灰灰灰的博客&source=" data-title=" QQ">
          <i class="icon mdi mdi-qqchat"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.lyh543.cn/back-end/onedrive-rest-api/" data-title=" Facebook">
          <i class="icon mdi mdi-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《后端利用 REST API 对接 Onedrive》 — 小灰灰灰灰的博客&url=https://blog.lyh543.cn/back-end/onedrive-rest-api/&via=https://blog.lyh543.cn" data-title=" Twitter">
          <i class="icon mdi mdi-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.lyh543.cn/back-end/onedrive-rest-api/" data-title=" Google+">
          <i class="icon mdi mdi-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACI0lEQVR42u3aS27DMAxF0ex/0y7QUSdW7iOTAiavRoW/Oi7ASCRfLzyu33E+8vf43dnzk9N74yFDhozHMq7jSF/G7737NOfrb98uQ4aMBQweCvkU+dnze8kPgAwZMmSQ8Jpew4/IkCFDRhpw+RaXBFkSxGXIkCGDb2LJ4ImzznJThgwZ2xi19P3//P3F+oYMGTIewrjCUSsA1JL+waxkyJAxmtFvpOBBs19OeBOOZciQMZSRFinTxog4ZYY/622olSFDxjhGWoYkO0dyfWfP/eZ3Q4YMGUMZnbBYa7DgxYP4LhkyZAxldBL0n03Vkemi/4MMGTKGMmotDrzxogNAJBkyZAxl1NLxaXitLRmDBaIMGTLWMGobyPiVgJd2gsmQIWMDgzyOU/uTi58sQ4aMZQySgOMLSl7ybMFkyJAxmsEXarV2Ch7K+fPjxgsZMmSMYPD0GZ8EP9vZDMuQIWMPo9PO1a+gpm+JfzFkyJAxgvGp5VoKq7WLyZAhYxujtgTkpNrSk7eUyZAhYw8jTbrx5No38oIyZMjYxuCTq5E6qbq4CCpDhoyhjCscaW9Dv+UL4WXIkDGawQdftNU2q+lmOG4RkyFDxsMZ/TaLNMVWK0u8Ce4yZMhYwKi1ZPWLkZ2gj07LkCFjGSNNhHE8D/dxIVOGDBkrGWk6rPY54vAtQ4aMBYxagiwtIZw/TWtzK0OGjNGMTmEgfVxtiZmWS2XIkDGI8QOvHqh2HQn3JwAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.7.2"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.7.2" async></script>










</body>
</html>
