<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>后端利用 REST API 对接 Onedrive | 小灰灰灰灰的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/theme/favicon.png">
    <link rel="alternate" type="application/rss+xml" href="https://blog.lyh543.cn/rss.xml" title="小灰灰灰灰的博客 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.lyh543.cn/feed.atom" title="小灰灰灰灰的博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.lyh543.cn/feed.json" title="小灰灰灰灰的博客 JSON Feed">
    <meta name="description" content="最近写的后端项目需要云盘，由于各种原因，最终选择了 Onedrive。Onedrive 的一个优点是文档是中文的，但缺点是中文也看不懂。。。。

于是借助文档、博客、示例代码等等，慢慢摸索过来，并把摸索的这个过程形成一篇博文。

注册应用、用户登录授权

> 参考博客：[zhangguanzhang's Blog](https://zhangguanzhang.github.io/2020/ ...">
    
    <link rel="preload" href="/assets/css/0.styles.ba65f1a6.css" as="style"><link rel="preload" href="/assets/js/app.0b99cce4.js" as="script"><link rel="preload" href="/assets/js/20.13b73a09.js" as="script"><link rel="preload" href="/assets/js/4.c36cbde9.js" as="script"><link rel="prefetch" href="/assets/js/10.a62f879a.js"><link rel="prefetch" href="/assets/js/100.f253d3ab.js"><link rel="prefetch" href="/assets/js/101.db9fdebc.js"><link rel="prefetch" href="/assets/js/102.94f7cb67.js"><link rel="prefetch" href="/assets/js/103.09ac970a.js"><link rel="prefetch" href="/assets/js/104.b87e924f.js"><link rel="prefetch" href="/assets/js/105.bc00ec5a.js"><link rel="prefetch" href="/assets/js/106.b5ff4964.js"><link rel="prefetch" href="/assets/js/107.49c6cbd2.js"><link rel="prefetch" href="/assets/js/108.54168938.js"><link rel="prefetch" href="/assets/js/109.4d3197d1.js"><link rel="prefetch" href="/assets/js/11.d0645d4b.js"><link rel="prefetch" href="/assets/js/110.ee7d3d2e.js"><link rel="prefetch" href="/assets/js/111.4a27bdba.js"><link rel="prefetch" href="/assets/js/112.1b359da8.js"><link rel="prefetch" href="/assets/js/113.9f2ff65f.js"><link rel="prefetch" href="/assets/js/114.ab50f1be.js"><link rel="prefetch" href="/assets/js/115.1393f63d.js"><link rel="prefetch" href="/assets/js/116.da021730.js"><link rel="prefetch" href="/assets/js/117.98911950.js"><link rel="prefetch" href="/assets/js/118.dcb3799b.js"><link rel="prefetch" href="/assets/js/119.a4cc65da.js"><link rel="prefetch" href="/assets/js/12.e112a51d.js"><link rel="prefetch" href="/assets/js/120.f59fc715.js"><link rel="prefetch" href="/assets/js/121.f4e86ccb.js"><link rel="prefetch" href="/assets/js/122.f8e7957a.js"><link rel="prefetch" href="/assets/js/123.db077df7.js"><link rel="prefetch" href="/assets/js/124.169c0316.js"><link rel="prefetch" href="/assets/js/125.e6cc5a9b.js"><link rel="prefetch" href="/assets/js/126.28ffbbaf.js"><link rel="prefetch" href="/assets/js/127.48ca18c4.js"><link rel="prefetch" href="/assets/js/128.07e0655e.js"><link rel="prefetch" href="/assets/js/129.9669580d.js"><link rel="prefetch" href="/assets/js/13.a4aa4b07.js"><link rel="prefetch" href="/assets/js/130.5c64476d.js"><link rel="prefetch" href="/assets/js/131.5f7d6fae.js"><link rel="prefetch" href="/assets/js/132.7fcabb3d.js"><link rel="prefetch" href="/assets/js/133.55bb2572.js"><link rel="prefetch" href="/assets/js/134.d5a2fe3c.js"><link rel="prefetch" href="/assets/js/135.6ba5e906.js"><link rel="prefetch" href="/assets/js/136.52dce3ff.js"><link rel="prefetch" href="/assets/js/137.8f57365f.js"><link rel="prefetch" href="/assets/js/138.3215298f.js"><link rel="prefetch" href="/assets/js/139.80e04f34.js"><link rel="prefetch" href="/assets/js/14.d4d5df77.js"><link rel="prefetch" href="/assets/js/140.cb983c47.js"><link rel="prefetch" href="/assets/js/141.417655d8.js"><link rel="prefetch" href="/assets/js/142.9970fd47.js"><link rel="prefetch" href="/assets/js/143.b103a1ef.js"><link rel="prefetch" href="/assets/js/144.b04e7ef5.js"><link rel="prefetch" href="/assets/js/145.16985066.js"><link rel="prefetch" href="/assets/js/146.f912cdb8.js"><link rel="prefetch" href="/assets/js/147.40289cfe.js"><link rel="prefetch" href="/assets/js/148.43eb1f09.js"><link rel="prefetch" href="/assets/js/149.f9cc9962.js"><link rel="prefetch" href="/assets/js/15.cc89af4d.js"><link rel="prefetch" href="/assets/js/150.68588e72.js"><link rel="prefetch" href="/assets/js/151.db3a6c9d.js"><link rel="prefetch" href="/assets/js/152.72fdd972.js"><link rel="prefetch" href="/assets/js/153.30173a79.js"><link rel="prefetch" href="/assets/js/154.c5ed4bdc.js"><link rel="prefetch" href="/assets/js/155.5ffdfe14.js"><link rel="prefetch" href="/assets/js/156.5ed4b558.js"><link rel="prefetch" href="/assets/js/157.d24f4a7a.js"><link rel="prefetch" href="/assets/js/158.24ef0663.js"><link rel="prefetch" href="/assets/js/159.3ea83287.js"><link rel="prefetch" href="/assets/js/16.4b276a96.js"><link rel="prefetch" href="/assets/js/160.9db43791.js"><link rel="prefetch" href="/assets/js/161.938902b6.js"><link rel="prefetch" href="/assets/js/162.d16f2fc3.js"><link rel="prefetch" href="/assets/js/163.6fd3ba21.js"><link rel="prefetch" href="/assets/js/164.fa9d3964.js"><link rel="prefetch" href="/assets/js/165.5de5ab73.js"><link rel="prefetch" href="/assets/js/166.9f4b9563.js"><link rel="prefetch" href="/assets/js/167.a362c23e.js"><link rel="prefetch" href="/assets/js/168.670bc35b.js"><link rel="prefetch" href="/assets/js/169.d95910be.js"><link rel="prefetch" href="/assets/js/17.a8a828a3.js"><link rel="prefetch" href="/assets/js/170.c0ef053c.js"><link rel="prefetch" href="/assets/js/171.0ed237bb.js"><link rel="prefetch" href="/assets/js/172.d0e5012b.js"><link rel="prefetch" href="/assets/js/173.1d8cc7d1.js"><link rel="prefetch" href="/assets/js/174.c91f556b.js"><link rel="prefetch" href="/assets/js/175.81876b8d.js"><link rel="prefetch" href="/assets/js/176.f36a741d.js"><link rel="prefetch" href="/assets/js/177.b033cb94.js"><link rel="prefetch" href="/assets/js/178.ca334264.js"><link rel="prefetch" href="/assets/js/179.893f60eb.js"><link rel="prefetch" href="/assets/js/18.f84f174d.js"><link rel="prefetch" href="/assets/js/180.5efbffdb.js"><link rel="prefetch" href="/assets/js/181.288239bd.js"><link rel="prefetch" href="/assets/js/182.b3905349.js"><link rel="prefetch" href="/assets/js/183.373cb444.js"><link rel="prefetch" href="/assets/js/184.12fd4616.js"><link rel="prefetch" href="/assets/js/185.812849ea.js"><link rel="prefetch" href="/assets/js/186.d589acbe.js"><link rel="prefetch" href="/assets/js/187.d25e399d.js"><link rel="prefetch" href="/assets/js/188.4c7e4ffe.js"><link rel="prefetch" href="/assets/js/189.64f1b4e6.js"><link rel="prefetch" href="/assets/js/19.56a49ab6.js"><link rel="prefetch" href="/assets/js/190.4c0b9fa1.js"><link rel="prefetch" href="/assets/js/191.f93996d6.js"><link rel="prefetch" href="/assets/js/192.402a3bfa.js"><link rel="prefetch" href="/assets/js/193.a82e5391.js"><link rel="prefetch" href="/assets/js/194.026efdd4.js"><link rel="prefetch" href="/assets/js/195.7ab4336a.js"><link rel="prefetch" href="/assets/js/196.21dbd3c6.js"><link rel="prefetch" href="/assets/js/197.20392bfc.js"><link rel="prefetch" href="/assets/js/198.52e96c44.js"><link rel="prefetch" href="/assets/js/199.acd8cf2a.js"><link rel="prefetch" href="/assets/js/200.02905654.js"><link rel="prefetch" href="/assets/js/201.14232d54.js"><link rel="prefetch" href="/assets/js/202.b3194b95.js"><link rel="prefetch" href="/assets/js/203.0576a6ff.js"><link rel="prefetch" href="/assets/js/204.749c9329.js"><link rel="prefetch" href="/assets/js/205.1906aba0.js"><link rel="prefetch" href="/assets/js/206.d8a36df1.js"><link rel="prefetch" href="/assets/js/207.3f8e6993.js"><link rel="prefetch" href="/assets/js/208.a4765767.js"><link rel="prefetch" href="/assets/js/209.bfb30db0.js"><link rel="prefetch" href="/assets/js/21.c0dcf3ee.js"><link rel="prefetch" href="/assets/js/210.505f1386.js"><link rel="prefetch" href="/assets/js/211.a6a3f994.js"><link rel="prefetch" href="/assets/js/212.03de808c.js"><link rel="prefetch" href="/assets/js/213.aa209737.js"><link rel="prefetch" href="/assets/js/214.6634cea2.js"><link rel="prefetch" href="/assets/js/215.f5a5ed4e.js"><link rel="prefetch" href="/assets/js/216.d0eeac14.js"><link rel="prefetch" href="/assets/js/217.7e8194a2.js"><link rel="prefetch" href="/assets/js/218.1b595673.js"><link rel="prefetch" href="/assets/js/219.af780d21.js"><link rel="prefetch" href="/assets/js/22.73ba2b1e.js"><link rel="prefetch" href="/assets/js/220.305a5658.js"><link rel="prefetch" href="/assets/js/221.1ea134ef.js"><link rel="prefetch" href="/assets/js/222.ab0f01d5.js"><link rel="prefetch" href="/assets/js/223.ff336f34.js"><link rel="prefetch" href="/assets/js/224.8cc51dd1.js"><link rel="prefetch" href="/assets/js/225.2c39b9e9.js"><link rel="prefetch" href="/assets/js/226.16b84fb6.js"><link rel="prefetch" href="/assets/js/227.c1cc46bc.js"><link rel="prefetch" href="/assets/js/228.5f5930db.js"><link rel="prefetch" href="/assets/js/229.f785a101.js"><link rel="prefetch" href="/assets/js/23.62be8cdb.js"><link rel="prefetch" href="/assets/js/230.c793f181.js"><link rel="prefetch" href="/assets/js/231.2c708fd2.js"><link rel="prefetch" href="/assets/js/232.0d9ef57f.js"><link rel="prefetch" href="/assets/js/233.9b1a2c1e.js"><link rel="prefetch" href="/assets/js/234.54f6e632.js"><link rel="prefetch" href="/assets/js/235.3f54ca46.js"><link rel="prefetch" href="/assets/js/236.fc6793b8.js"><link rel="prefetch" href="/assets/js/237.ba68bf7a.js"><link rel="prefetch" href="/assets/js/238.d8422cf6.js"><link rel="prefetch" href="/assets/js/239.8857147a.js"><link rel="prefetch" href="/assets/js/24.c703d2ff.js"><link rel="prefetch" href="/assets/js/240.066a0059.js"><link rel="prefetch" href="/assets/js/241.fec3de3e.js"><link rel="prefetch" href="/assets/js/242.9afd9863.js"><link rel="prefetch" href="/assets/js/25.e4b5d9cd.js"><link rel="prefetch" href="/assets/js/26.09f6f933.js"><link rel="prefetch" href="/assets/js/27.3760bee1.js"><link rel="prefetch" href="/assets/js/28.6bd50d59.js"><link rel="prefetch" href="/assets/js/29.ff459390.js"><link rel="prefetch" href="/assets/js/3.b0f49fb4.js"><link rel="prefetch" href="/assets/js/30.4ab05e0e.js"><link rel="prefetch" href="/assets/js/31.a3c1c2d9.js"><link rel="prefetch" href="/assets/js/32.539d90dc.js"><link rel="prefetch" href="/assets/js/33.ad77dc14.js"><link rel="prefetch" href="/assets/js/34.8c22bea6.js"><link rel="prefetch" href="/assets/js/35.100ca257.js"><link rel="prefetch" href="/assets/js/36.d9f27094.js"><link rel="prefetch" href="/assets/js/37.3f37cd4c.js"><link rel="prefetch" href="/assets/js/38.eb4282ed.js"><link rel="prefetch" href="/assets/js/39.523656b2.js"><link rel="prefetch" href="/assets/js/40.50993bef.js"><link rel="prefetch" href="/assets/js/41.762cf1ff.js"><link rel="prefetch" href="/assets/js/42.43bd336c.js"><link rel="prefetch" href="/assets/js/43.fd543ff1.js"><link rel="prefetch" href="/assets/js/44.80337699.js"><link rel="prefetch" href="/assets/js/45.bff8d08f.js"><link rel="prefetch" href="/assets/js/46.576a5a29.js"><link rel="prefetch" href="/assets/js/47.c21081db.js"><link rel="prefetch" href="/assets/js/48.0caefca2.js"><link rel="prefetch" href="/assets/js/49.bf865d97.js"><link rel="prefetch" href="/assets/js/5.e6e166e1.js"><link rel="prefetch" href="/assets/js/50.e10eb3ba.js"><link rel="prefetch" href="/assets/js/51.39d80954.js"><link rel="prefetch" href="/assets/js/52.b9019938.js"><link rel="prefetch" href="/assets/js/53.4e06c9c8.js"><link rel="prefetch" href="/assets/js/54.c235e49a.js"><link rel="prefetch" href="/assets/js/55.991000be.js"><link rel="prefetch" href="/assets/js/56.50cadecf.js"><link rel="prefetch" href="/assets/js/57.5bed2a47.js"><link rel="prefetch" href="/assets/js/58.da30e00a.js"><link rel="prefetch" href="/assets/js/59.c5e08f26.js"><link rel="prefetch" href="/assets/js/6.ad6534dc.js"><link rel="prefetch" href="/assets/js/60.433f1820.js"><link rel="prefetch" href="/assets/js/61.6d075d0e.js"><link rel="prefetch" href="/assets/js/62.03b0219a.js"><link rel="prefetch" href="/assets/js/63.2633a3c1.js"><link rel="prefetch" href="/assets/js/64.e99468ca.js"><link rel="prefetch" href="/assets/js/65.092aeb48.js"><link rel="prefetch" href="/assets/js/66.72f625cb.js"><link rel="prefetch" href="/assets/js/67.1e99003d.js"><link rel="prefetch" href="/assets/js/68.aa32a97f.js"><link rel="prefetch" href="/assets/js/69.d61a684f.js"><link rel="prefetch" href="/assets/js/7.4cd823a4.js"><link rel="prefetch" href="/assets/js/70.84a4a860.js"><link rel="prefetch" href="/assets/js/71.1cf60181.js"><link rel="prefetch" href="/assets/js/72.f50524b9.js"><link rel="prefetch" href="/assets/js/73.2bce7cb6.js"><link rel="prefetch" href="/assets/js/74.e460a0bb.js"><link rel="prefetch" href="/assets/js/75.0dd3fda6.js"><link rel="prefetch" href="/assets/js/76.2cbfb6ab.js"><link rel="prefetch" href="/assets/js/77.c5759bc7.js"><link rel="prefetch" href="/assets/js/78.22ed93ee.js"><link rel="prefetch" href="/assets/js/79.7dd8116a.js"><link rel="prefetch" href="/assets/js/8.00003564.js"><link rel="prefetch" href="/assets/js/80.9f1d3631.js"><link rel="prefetch" href="/assets/js/81.e43dcdc5.js"><link rel="prefetch" href="/assets/js/82.d61e7077.js"><link rel="prefetch" href="/assets/js/83.6ea15e57.js"><link rel="prefetch" href="/assets/js/84.ac1a1613.js"><link rel="prefetch" href="/assets/js/85.db0b5853.js"><link rel="prefetch" href="/assets/js/86.19fe0d35.js"><link rel="prefetch" href="/assets/js/87.0de56400.js"><link rel="prefetch" href="/assets/js/88.57b2e4ba.js"><link rel="prefetch" href="/assets/js/89.339850f9.js"><link rel="prefetch" href="/assets/js/9.4fd6de62.js"><link rel="prefetch" href="/assets/js/90.a4a402a4.js"><link rel="prefetch" href="/assets/js/91.da9e7e18.js"><link rel="prefetch" href="/assets/js/92.0b30be51.js"><link rel="prefetch" href="/assets/js/93.7fdcff6e.js"><link rel="prefetch" href="/assets/js/94.1afeae11.js"><link rel="prefetch" href="/assets/js/95.9de51638.js"><link rel="prefetch" href="/assets/js/96.dd2ea4f6.js"><link rel="prefetch" href="/assets/js/97.9e2d8992.js"><link rel="prefetch" href="/assets/js/98.3471026e.js"><link rel="prefetch" href="/assets/js/99.11633d17.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.2e9b600e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ba65f1a6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="v-application v-application--is-ltr theme--light"><div class="v-application--wrap"><!----> <main id="main-content" class="v-main" style="padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-main__wrap"><div><div class="container"><div class="row justify-center"><div class="col-sm-9 col-12"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div class="v-card v-sheet theme--light"><div class="container"><div itemprop="articleBody" class="markdown-body content__default"><p>最近写的后端项目需要云盘，由于各种原因，最终选择了 Onedrive。Onedrive 的一个优点是文档是中文的，但缺点是中文也看不懂。。。。</p> <p>于是借助文档、博客、示例代码等等，慢慢摸索过来，并把摸索的这个过程形成一篇博文。</p> <h2 id="注册应用、用户登录授权"><a href="#注册应用、用户登录授权" class="header-anchor">#</a> 注册应用、用户登录授权</h2> <blockquote><p>参考博客：<a href="https://zhangguanzhang.github.io/2020/02/27/microsoft-graph-for-onedrive/" target="_blank" rel="noopener noreferrer">zhangguanzhang's Blog<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
参考文档：<a href="https://docs.microsoft.com/zh-cn/onedrive/developer/rest-api/getting-started/graph-oauth?view=odsp-graph-online" target="_blank" rel="noopener noreferrer">Microsoft Graph 中的 OneDrive 授权和登录<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>Onedrive 的认证（以及 MS 家的其他功能）都统一使用 Microsoft Graph 进行认证，而 Microsoft Graph 似乎只支持 OAuth2（必须让用户在浏览器完成登录，不能拿到密码然后在后台登录），不支持 OAuth1（可以在后台利用用户密码发起请求完成登录），所以会麻烦一些。</p> <h3 id="在-azure-创建应用"><a href="#在-azure-创建应用" class="header-anchor">#</a> 在 Azure 创建应用</h3> <p>第一件事，是按照上面的博客所说，注册应用。这个应用其实就是一个 API，以下引用并修改了 <a href="https://zhangguanzhang.github.io/2020/02/27/microsoft-graph-for-onedrive/" target="_blank" rel="noopener noreferrer">zhangguanzhang's Blog<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <p>我们首先要创建一个应用程序。</p> <blockquote><p>https://portal.azure.com/#blade/Microsoft_AAD_RegisteredApps/ApplicationsListBlade</p></blockquote> <p>到上面链接里去注册一个应用程序，属性为：</p> <ul><li>受支持的帐户类型记得选 <code>任何组织目录(任何 Azure AD 目录 - 多租户)中的帐户和个人 Microsoft 帐户(例如，Skype、Xbox)</code></li> <li>重定向 URI (可选) 我用的是 <code>http://localhost:8000/getAToken</code>，在摸索的时候这个随便写就行。另外，这个值要存在代码里，命名为 <code>redirect_uri</code>。</li></ul> <p>然后设置权限。点击左边侧边栏的 “API 权限”，点击中间的“添加权限”，然后在右边点“Microsoft Graph” - “委托的权限”，搜索并找到以下三个权限，勾选上。</p> <div class="language- extra-class"><pre class="language-text"><code>Files.ReadWrite
Files.ReadWrite.All
offline_access
</code></pre></div><p><img src="/images/cc719c616ef24cdf4c51997fcbf6c55edf234453c73ea79b81684c8fea1b6d8e.png" alt="勾选权限"></p> <p>然后在侧边栏的“概述”里面，把应用程序(客户端) ID 复制下来（在代码里存为 <code>client_id</code>）。</p> <p>然后在侧边栏“证书和密码”里面，点击“新客户端密码”，生成一个 ID 和值，把值存到代码里，命名为 <code>client_secret</code>。</p> <h3 id="用户在浏览器登录-获取-auth-token"><a href="#用户在浏览器登录-获取-auth-token" class="header-anchor">#</a> 用户在浏览器登录，获取 auth_token</h3> <p>在 Azure 创建应用以后，就是授权直至拿到 <code>refresh_token</code> 的过程。这个过程就是参考 <a href="https://docs.microsoft.com/zh-cn/onedrive/developer/rest-api/getting-started/graph-oauth?view=odsp-graph-online" target="_blank" rel="noopener noreferrer">Microsoft Graph 中的 OneDrive 授权和登录<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 了，这里我用 Python requests 实现。</p> <blockquote><p>现在文档迁移到了 <a href="https://docs.microsoft.com/zh-cn/graph/auth/" target="_blank" rel="noopener noreferrer">Microsoft Graph 身份验证概述<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>而且更加详细了。而上述链接不再提供中文文档。</p></blockquote> <p>首先设置上述变量：</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> requests
headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token punctuation">:</span><span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">}</span>
scope <span class="token operator">=</span> <span class="token string">&quot;Files.ReadWrite offline_access&quot;</span>

client_id <span class="token operator">=</span> <span class="token string">&quot;3aea792a-f5f5-49a6-b64d-e1a45d375323&quot;</span>
redirect_uri <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8000/getAToken&quot;</span>
client_secret <span class="token operator">=</span> <span class="token string">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span>
</code></pre></div><p>然后是生成登录链接。这个链接需要在浏览器里访问然后输入账号密码，于是就不用 <code>requests.get</code> 而是把链接 print 出来，我们复制到浏览器里面。</p> <div class="language-py extra-class"><pre class="language-py"><code>login_link <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f&quot;https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=</span><span class="token interpolation"><span class="token punctuation">{</span>client_id<span class="token punctuation">}</span></span><span class="token string">&amp;scope=</span><span class="token interpolation"><span class="token punctuation">{</span>scope<span class="token punctuation">}</span></span><span class="token string">&amp;response_type=code&amp;redirect_uri=</span><span class="token interpolation"><span class="token punctuation">{</span>redirect_uri<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
<span class="token keyword">print</span><span class="token punctuation">(</span>login_link<span class="token punctuation">)</span>
</code></pre></div><p>打开 print 的链接，成功登录并授权后，跳转到 <code>localhost</code>，其中的参数的 <code>code</code> 字段就是我们需要的 <code>auth_token</code>，729个字符，有点长。</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:8000/getAToken?code=0.AAAApOutbSzcpEiz8KuV1mGJ2ip56jr19aZJtk3hpF03UyM-AI4.AQABAAIAAAD--DLA3VO7QrddgJg7Wevry9C8xxU0YmDl1t3kRL1Rt8c4ZYINbxBW_X7KGMwL80bFg2I99rHKlQuC_bwGWIMjn1C4GjZg8fR2v2r-9J6fffSYUVMmrA5tGJ-7AUyulg076ViCOLWvtDzUh1T09f3Tt2Q8TpgCgO8P-0PqGMPqNOivzAxQz8WH5ZKSTMaI7WeOSBGe9yrpdjskO4pJrZv62E-jl2udaTBSXJAG4hKc18feCvuhJk27gT4H1W7ZiONqwMMkpzK6nlMhBgRP7-hTBNIU82Y0ASNOsOu2aAzrCQJmmbDdPHvsEYIq5jDnlOqeoNNFh-0v_AEbf-YfUfvIxN79eGpgrXvH19sLstDqFagJaOayNm6sf4HHuo2ikAot5kLZoBwYus57BaWeLI2IA_jDKd9T899Pv_Gfc_fwkgI9PynaHfoDRHb9A-6fXaJYPE5IYkTEnunNDaBf6jKtoTPub5LFIZv3OP38c3zJrTBZL5Wr5dpo3-pa0FFkbYPgHGC5APlWFNiBx-OECd4OJnbdzM7hrA2YzCLa6Bwl7SG4KTVXv2fwW1gFLgCZdI_xYBEDHfYuKUnlC5eqcebWwtkfJ8roFj9p3hzJ_GQSgEKjTgrdSUMaxrYwhSnAzS06H4BqnLKL-FrKsDBWJXuAIAA&amp;session_state=697ec6eb-a4b9-4567-9873-6065f156164b#
</code></pre></div><p>在之后开发 WebApp 时，我们需要把 <code>redirect_url</code> 设置为我们能路由到的链接，在路由到的 View 中获取 uri 参数，就可以获得 <code>auth_token</code> 了。不过现在还是手动赋值吧。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token comment"># 赋值</span>
auth_token <span class="token operator">=</span> <span class="token string">&quot;0.AAAApOutbSzcpEiz8KuV1mGJ2ip56jr19aZJtk3hpF03UyM-AI4.AQABAAIAAAD--DLA3VO7QrddgJg7WevrnDiEeOedZvv94_iCOZdHtunnh-HD4-yA7CnKCnlskkTcXuD_nVujxrzDErLOPO5Kdba-gLFaUgOCxScnphpTmaR-bJbb6KCOJ6WEsecTZhdoBVvhgG8SzPAmolHemGaOOymSx1L3opaGXSo6YolsgwSCYcokocf9jl9Jq8pOAfg4tuZTYh1uX6f-IvQgLoIhUhE8i7GoaLIFhel9ICjiWgO9imtgNiLIjMX-MMRxqEKbcvbjVi9vnat1LE29v7uX_0Ogs6feGFzKEZOvT8pNlbm1t0frSwSIktQeIELEU3kzbDX7TEp1b_Cguj2u7wqF-kLv3P9w2_Gzhi-lzdRph1h9SW-RFYyWtdoCfhQgFf5m8K7aUGUEKgDK0RomoPvuZ1jfoNxe5JWQdcHqNo-LcHblYGRI1azy-p1fp28aBB6qKZ_0pcRTb4BrU5qLi9ze4RJ5kPajodTSSloUSVkf64B9OEdPeBvT8XU8_to0aVeHXOUTlsgVSlliatLPx9pFhsOZ4ec2-7fQMr8_CBhPlY4rjMfl8plefsfwcIsDBc0PRPITcsxA7OYSxZXvSchHA6XmCSzdl1413mTh7d0cvLYnBmzJm1tc6z6PEW270mtL_enHuzbtZpK9D1Epu0HIIAA&quot;</span>
</code></pre></div><h3 id="用-auth-token-换-access-token-和-refresh-token"><a href="#用-auth-token-换-access-token-和-refresh-token" class="header-anchor">#</a> 用 auth_token 换 access_token 和 refresh_token</h3> <p>赋值以后，就可以请求拿 <code>access_token</code> 和 <code>refresh_token</code> 了。</p> <div class="language-py extra-class"><pre class="language-py"><code>headers<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token punctuation">:</span><span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">}</span>
response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
    <span class="token string">'https://login.microsoftonline.com/common/oauth2/v2.0/token'</span><span class="token punctuation">,</span>
    data<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">'client_id'</span><span class="token punctuation">:</span> client_id<span class="token punctuation">,</span>
        <span class="token string">'redirect_uri'</span><span class="token punctuation">:</span> redirect_uri<span class="token punctuation">,</span>
        <span class="token string">'client_secret'</span><span class="token punctuation">:</span> client_secret<span class="token punctuation">,</span>
        <span class="token string">'code'</span><span class="token punctuation">:</span> auth_token<span class="token punctuation">,</span>
        <span class="token string">'grant_type'</span><span class="token punctuation">:</span> <span class="token string">'authorization_code'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>

response                <span class="token comment"># &lt;Response [200]&gt;</span>
<span class="token builtin">eval</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
<span class="token comment"># {'token_type': 'Bearer',</span>
<span class="token comment">#  'scope': 'Files.ReadWrite profile openid email',</span>
<span class="token comment">#  'expires_in': 3599,</span>
<span class="token comment">#  'ext_expires_in': 3599,</span>
<span class="token comment">#  'access_token': 'eyJ0eXAiOiJKV1QiLCJub25jZSI6ImZCREdZc3JfSzVYLXBkU2o5ZWotUUJMc2JGRGFDVGFBQ0lvSk90T3I2UlEiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiIwMDAwMDAwMy0wMDAwLTAwMDAtYzAwMC0wMDAwMDAwMDAwMDAiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC82ZGFkZWJhNC1kYzJjLTQ4YTQtYjNmMC1hYjk1ZDY2MTg5ZGEvIiwiaWF0IjoxNjE0MjYyMDgzLCJuYmYiOjE2MTQyNjIwODMsImV4cCI6MTYxNDI2NTk4MywiYWNjdCI6MCwiYWNyIjoiMSIsImFjcnMiOlsidXJuOnVzZXI6cmVnaXN0ZXJzZWN1cml0eWluZm8iLCJ1cm46bWljcm9zb2Z0OnJlcTEiLCJ1cm46bWljcm9zb2Z0OnJlcTIiLCJ1cm46bWljcm9zb2Z0OnJlcTMiLCJjMSIsImMyIiwiYzMiLCJjNCIsImM1IiwiYzYiLCJjNyIsImM4IiwiYzkiLCJjMTAiLCJjMTEiLCJjMTIiLCJjMTMiLCJjMTQiLCJjMTUiLCJjMTYiLCJjMTciLCJjMTgiLCJjMTkiLCJjMjAiLCJjMjEiLCJjMjIiLCJjMjMiLCJjMjQiLCJjMjUiXSwiYWlvIjoiRTJaZ1lORGY2OWJFVUxnd3BkR0FMM2J5aHZRZCsxNkg2THppdUwvNGxPejYrR25mbE1VQSIsImFtciI6WyJwd2QiXSwiYXBwX2Rpc3BsYXluYW1lIjoi6Ziu6JaH6JaH54K55ZCN5ZWmIiwiYXBwaWQiOiIzYWVhNzkyYS1mNWY1LTQ5YTYtYjY0ZC1lMWE0NWQzNzUzMjMiLCJhcHBpZGFjciI6IjEiLCJpZHR5cCI6InVzZXIiLCJpcGFkZHIiOiIxNTQuMTcuNy44NCIsIm5hbWUiOiLnlLXlrZDnp5HmioDlpKflraZNU0MiLCJvaWQiOiIyZDU1MTQyNS01Mzk2LTQxNTktOTQ1MC0wNzU2MzdiMDE2N2IiLCJwbGF0ZiI6IjMiLCJwdWlkIjoiMTAwMzIwMDA1N0RCODYzRSIsInJoIjoiMC5BQUFBcE91dGJTemNwRWl6OEt1VjFtR0oyaXA1NmpyMTlhWkp0azNocEYwM1V5TS1BSTQuIiwic2NwIjoiRmlsZXMuUmVhZFdyaXRlIHByb2ZpbGUgb3BlbmlkIGVtYWlsIiwic3ViIjoid2R3RDhmLXM0ajJDWHlmQ2phOWd1LXpVdk91V0ZUWFg2bXk1d0ZGODROcyIsInRlbmFudF9yZWdpb25fc2NvcGUiOiJBUyIsInRpZCI6IjZkYWRlYmE0LWRjMmMtNDhhNC1iM2YwLWFiOTVkNjYxODlkYSIsInVuaXF1ZV9uYW1lIjoidWVzdGNtc2NAZGVtbzRjLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6InVlc3RjbXNjQGRlbW80Yy5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJFQ0Vaei1LeEprZVhOMDRTYlVNa0FBIiwidmVyIjoiMS4wIiwid2lkcyI6WyJiNzlmYmY0ZC0zZWY5LTQ2ODktODE0My03NmIxOTRlODU1MDkiXSwieG1zX3N0Ijp7InN1YiI6Inl0WGtlTWM0dFVnV3dpMmJLbS1xc3JMazJuY3Zjc3lrYVFYcm1Zdm1lRE0ifSwieG1zX3RjZHQiOjE0OTcyNDg0OTN9.EjpbLnqwdSsjeQwy5oVWjqHfSjFyHwQHcwNNvVhq8w9J96PQEjx6xpyIc-VgrQc0h1DdfikzyOVkMEHSVifM_KZoaaUIcW3T4xgXjgZVeEtznAKEqSDB4PN5qR45hsZbJLoVFBxaRZsQrEiPK7m2F4-4_VCK-I6Dfhvhm2_XTiBXnbqSsQ87VhF01BqSVXBIlJwSS1mQKEYHJGCjKnTB5yToDzJvoh4p7GGY3SCmfWY-pDMsAvMlJbErfhXh9Hxc41eBESSEmoajZAnxFOJU5LRtVHqPQW6PwlSTHL2nlGfdXFpspTc6hy4pSyVDNq6I3HJRFXl1cW0L6DjD2FoWMw',</span>
<span class="token comment">#  'refresh_token': '0.AAAApOutbSzcpEiz8KuV1mGJ2ip56jr19aZJtk3hpF03UyM-AI4.AgABAAAAAAD--DLA3VO7QrddgJg7WevrAgDs_wQA9P_bTRjPRZzMorqH901Y19Ppp0sTRQdBBKFPHBjjxCNhD6fQlBevSxmidflskapxgyxbPlJysKnmnXMvEw6oy9tTRGn5QAB6kuYsP9BVFNiEpqeyqyyABuuiZZXHfMVSiqcIuUYdC5Cbt-meckpgVSC9Dfhvr50ilZ99m5iUHDkFVJLdPQLlrgdHqV8Mhe1V6Eh7F5Mfqrg1xb-K-QLZ3EGrcBUsDarXTkKPWP_9rKgukN_PTFerEBaM90u--8iytv0RJAui31HTa4yIInU0g7vZ16fhaEvJSXQjMSc5TYeepCHkK2fi3UpJe8TOoQ-qpORU_CJl83YMF59_enWxi0f_5ouV_9CPpeZ0xReU1Nb2y4g7uBYVPPNyroVlSmU0zV9c_rgs-dkSXK3b6r-AN-c5msS_ZoGvjiL3qBevNKo3Ws4w4IBWO-wQV8arNtNSuCAv5u9z41gITSDDg1Z8EYizTjQHjVaP095n5CWcBghqboVL4H2AAzW1SIgDJIs7ybwhg0oVsjUW4s9FQguPe9lj3HrAHzk5_NMRJsuGIZpDJ3ENz2pldXaRBqk42X07_y549Aw3qmgd8UY2KqsbA0EMNharkf-3q0_4AyeyxtqSqJETF5F3wy0bQ0RViS5W5mVobaRU90ia-zHzOjvXtxvenaY-r2ANjh_yg3qiV2D8Z7ODW50YzLL9SgiFqMm7zg7RYd4jjpdTYOik2yCX7cn_sSaA29KAqkbWKZNqX2Ds_ZRyby8RYeHBOC_I0XbrngLHnTszik-eKI3rHBv7UdTXCM9PHJwl2X4pocIREzfFPOTnLauiyfAS_zpb2Lsw8exVEqIpesVZt1S8uMvaEPctk7P22myx-vdxrk937c9z368vGpN6dBS--LPq5ZaxX9TuxCRbfCesT6KpkgLMq6Ywho59Tc6cAeE18sw'}</span>
</code></pre></div><p>好耶！</p> <p>MS 还提供了网址对 access_token 进行解密：<code>https://jwt.ms/</code>。</p> <h3 id="用-refresh-token-换新的-access-token-和新的-refresh-token"><a href="#用-refresh-token-换新的-access-token-和新的-refresh-token" class="header-anchor">#</a> 用 refresh_token 换新的 access_token 和新的 refresh_token</h3> <p>然后，我们把上面 response 里的 <code>refresh_token</code> 取出来，然后请求刷新 <code>access_token</code> 和 <code>refresh_token</code>：</p> <div class="language-py extra-class"><pre class="language-py"><code>refresh_token <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'refresh_token'</span><span class="token punctuation">]</span>

response_refresh <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
    <span class="token string">'https://login.microsoftonline.com/common/oauth2/v2.0/token'</span><span class="token punctuation">,</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'client_id'</span><span class="token punctuation">:</span> client_id<span class="token punctuation">,</span>
        <span class="token string">'redirect_uri'</span><span class="token punctuation">:</span> redirect_uri<span class="token punctuation">,</span>
        <span class="token string">'client_secret'</span><span class="token punctuation">:</span> client_secret<span class="token punctuation">,</span>
        <span class="token string">'refresh_token'</span><span class="token punctuation">:</span> refresh_token<span class="token punctuation">,</span>
        <span class="token string">'grant_type'</span><span class="token punctuation">:</span> <span class="token string">'refresh_token'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    headers <span class="token operator">=</span> headers<span class="token punctuation">)</span>

response        <span class="token comment"># &lt;Response [200]&gt;</span>
<span class="token builtin">eval</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
<span class="token comment"># {'token_type': 'Bearer',</span>
<span class="token comment">#  'scope': 'Files.ReadWrite profile openid email',</span>
<span class="token comment">#  'expires_in': 3599,</span>
<span class="token comment">#  'ext_expires_in': 3599,</span>
<span class="token comment">#  'access_token': 'eyJ0eXAiOiJKV1QiLCJub25jZSI6ImhFSy1UT0xyZC1WZVNQOGVCU3plTURzeW1EODk5RWdlMEJzVDM5ak5uZEkiLCJhbGciOiJSUzI1NiIsIng1dCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyIsImtpZCI6Im5PbzNaRHJPRFhFSzFqS1doWHNsSFJfS1hFZyJ9.eyJhdWQiOiIwMDAwMDAwMy0wMDAwLTAwMDAtYzAwMC0wMDAwMDAwMDAwMDAiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC82ZGFkZWJhNC1kYzJjLTQ4YTQtYjNmMC1hYjk1ZDY2MTg5ZGEvIiwiaWF0IjoxNjE0MjYyNjg4LCJuYmYiOjE2MTQyNjI2ODgsImV4cCI6MTYxNDI2NjU4OCwiYWNjdCI6MCwiYWNyIjoiMSIsImFjcnMiOlsidXJuOnVzZXI6cmVnaXN0ZXJzZWN1cml0eWluZm8iLCJ1cm46bWljcm9zb2Z0OnJlcTEiLCJ1cm46bWljcm9zb2Z0OnJlcTIiLCJ1cm46bWljcm9zb2Z0OnJlcTMiLCJjMSIsImMyIiwiYzMiLCJjNCIsImM1IiwiYzYiLCJjNyIsImM4IiwiYzkiLCJjMTAiLCJjMTEiLCJjMTIiLCJjMTMiLCJjMTQiLCJjMTUiLCJjMTYiLCJjMTciLCJjMTgiLCJjMTkiLCJjMjAiLCJjMjEiLCJjMjIiLCJjMjMiLCJjMjQiLCJjMjUiXSwiYWlvIjoiQVNRQTIvOFRBQUFBcFB5WUtCamlUK2kxWnVaY3BLNitudHh2ektkMGovNGtvSVhGVnBwOE5vQT0iLCJhbXIiOlsicHdkIl0sImFwcF9kaXNwbGF5bmFtZSI6IumYruiWh-iWh-eCueWQjeWVpiIsImFwcGlkIjoiM2FlYTc5MmEtZjVmNS00OWE2LWI2NGQtZTFhNDVkMzc1MzIzIiwiYXBwaWRhY3IiOiIxIiwiaWR0eXAiOiJ1c2VyIiwiaXBhZGRyIjoiMTU0LjE3LjcuODQiLCJuYW1lIjoi55S15a2Q56eR5oqA5aSn5a2mTVNDIiwib2lkIjoiMmQ1NTE0MjUtNTM5Ni00MTU5LTk0NTAtMDc1NjM3YjAxNjdiIiwicGxhdGYiOiIzIiwicHVpZCI6IjEwMDMyMDAwNTdEQjg2M0UiLCJyaCI6IjAuQUFBQXBPdXRiU3pjcEVpejhLdVYxbUdKMmlwNTZqcjE5YVpKdGszaHBGMDNVeU0tQUk0LiIsInNjcCI6IkZpbGVzLlJlYWRXcml0ZSBwcm9maWxlIG9wZW5pZCBlbWFpbCIsInN1YiI6Indkd0Q4Zi1zNGoyQ1h5ZkNqYTlndS16VXZPdVdGVFhYNm15NXdGRjg0TnMiLCJ0ZW5hbnRfcmVnaW9uX3Njb3BlIjoiQVMiLCJ0aWQiOiI2ZGFkZWJhNC1kYzJjLTQ4YTQtYjNmMC1hYjk1ZDY2MTg5ZGEiLCJ1bmlxdWVfbmFtZSI6InVlc3RjbXNjQGRlbW80Yy5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJ1ZXN0Y21zY0BkZW1vNGMub25taWNyb3NvZnQuY29tIiwidXRpIjoiUjZERXd0TWlBazJsaTVXaWRIOGpBQSIsInZlciI6IjEuMCIsIndpZHMiOlsiYjc5ZmJmNGQtM2VmOS00Njg5LTgxNDMtNzZiMTk0ZTg1NTA5Il0sInhtc19zdCI6eyJzdWIiOiJ5dFhrZU1jNHRVZ1d3aTJiS20tcXNyTGsybmN2Y3N5a2FRWHJtWXZtZURNIn0sInhtc190Y2R0IjoxNDk3MjQ4NDkzfQ.GdgiFzmdXNFuBqaDSsLzalQU0QULm1fAYZw-mKw5D1KdR4j9WSl6sIa9vPcuogg1x7oLMujcgfdyY0Cf4KNLk3fQ3vzLo395R5GDbg-djBREWCBBgFvcgbu8AyH7yj6MxdXsY59U9nFqVdeIfqEZxxxFCT2F2Nc-CfrDsI8PZQL3kn0VFcvSiUwuOMlH06ydKwyyBNhCRh5yc9x32XWwlRde-GPZCd1SdyvcPvo_mUcEJxh97tRfehHNTDltXGFsAZqcYaz18iJk9MqZ4tlyOIIWPX_lXGRtNe2dUDQE6g6znWY0ClGvU3X9mdScUUtfblmnfmzMj-ECBkAjmjKBnA',</span>
<span class="token comment">#  'refresh_token': '0.AAAApOutbSzcpEiz8KuV1mGJ2ip56jr19aZJtk3hpF03UyM-AI4.AgABAAAAAAD--DLA3VO7QrddgJg7WevrAgDs_wQA9P89XPzxfnsn8nWMuIFittfpaEqpEzvy5sSPvkBHSIgu_y7Ppazm1F3l2nJ6hEWraRomalXRdwDi1Y78yIC_yA1xAspMEEuoxejDjoBhcWqOWLUTfXkfKk7i6pugNA-a_GOH9-EvKc_g9NvuCK4QgK6FQadMUf62wpoCkB53kgnH8GtOYKW34AutKaFi-N3v8RstrJRtsT3ZXanWmlA_q2WbDSou3-L_H6MS62u3Fr_mxnaKx4lKyy4cXaWbb_29dbx_yVO4zd_x5WHbcnrkfk3qoxD_b5kxHOMlKpVHtX_NthQvg8ZekDZ0pLawRsCDhJ8NFGwJvIXKxaMAyCbhHsyklnw97sU3M9jg08oAbaoQ0JA7eDZ4gd4juSzvkdGVK77unbROzOC1GjR12MWd9n_lYz4KMv_ErKx8wN2MHMAVK-QBBkJUsdB4JbBzSVgneD3jaDvWQRyz4BJMMx5e8qjR-bRwCBjm4Y1aK7vYNBGl2DVR1sVbf8eRZje6AxRQYy3rjdDod_30IqjNhDzX-eILlXR570RmoOGZgaWNPf-3-_3AaDGtsBE8tlCGux8lIR7jIxIKeBjfp1S5ymiofVirYYJiAg17KHy_W9FHUHS9CIs6CrKEvPesjDuFmerE14hzmJ4LCJarZSy2AsV6XiTMmamzaKX-WwFSzGXpipOwPbcO4tjcq5tFWz7-1TzDKsaAyvvh-K3fQiD2GUAv4v9zgRVczUQXN0Z37RULpnSGhj2eXaOenNXl9EoIgBLKXpj-lOshEyRbL2P3WzgvS1MUaXH31IHt-NiQuMpmeBfGg-gxrc9inQ0n7ATfD0T5vZ8YodjccP_rJvzI1Ntfl1yQs0g2h2JyZp694MOqc7Clv8W0P8F-uJIVWK2yv3iPRz-_nBM3im0A9OrCaugArHGPJ9gRt03nHzUHeJIAMc2Xqg'}</span>
</code></pre></div><p>至此，关于 token 的申请方法就讲完了。</p> <h3 id="django-实现"><a href="#django-实现" class="header-anchor">#</a> Django 实现</h3> <p>我把上面的过程改成了一个 <code>OnedriveAuthentication</code> 类（代码见 <a href="https://github.com/uestc-msc/uestcmsc_webapp_backend/blob/cc3c03b8e6526b73f40c0b1f1a7d182a8d318689/cloud/onedrive/auth.py" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，views 部分在 <a href="https://github.com/uestc-msc/uestcmsc_webapp_backend/blob/cc3c03b8e6526b73f40c0b1f1a7d182a8d318689/cloud/views/login.py" target="_blank" rel="noopener noreferrer">views.py<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中）。</p> <p>另外，MS 也给了一个利用 <code>requests_oauthlib.OAuth2Session</code> 封装的<a href="https://github.com/microsoftgraph/python-sample-auth/blob/master/sample_requests.py" target="_blank" rel="noopener noreferrer">示例<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，也可以参考。</p> <hr> <p>另外需要注意的是，如果在 Django 后端中使用 <code>requests</code> 请求 Onedrive，会使得线程等待，在 Onedrive 相关请求并发量高的时候很容易造成数秒甚至数十秒的延迟。</p> <p>可以在部署的时候使用更多线程缓解这个症状。想要根本改变这个问题，就不得不提到异步了。</p> <p>异步请求可以使用 <code>aiohttp</code> 库。Django 3.1 也提供了异步视图的支持（但没有提供异步数据库访问的支持，不过也提供了临时解决办法）。但是，Django REST Framework 3.2.3 还不支持异步视图，想要使用异步视图，还得使用纯 Django 视图。</p> <p>所以，目前我的解决办法，是把并发最高的一个 API 改写为纯 Django 视图然后异步化，并对该视图用到的 <code>requests</code> 请求改为 <code>aiohttp</code> 请求。</p> <h2 id="在前后端分离的情况下使用-onedrive-api"><a href="#在前后端分离的情况下使用-onedrive-api" class="header-anchor">#</a> 在前后端分离的情况下使用 Onedrive API</h2> <p>完成登录授权，拿到 Access Token 以后，就可以用 MS Graph 的 API 进行操作了。可以在 <a href="https://developer.microsoft.com/zh-cn/graph/graph-explorer?request=me%2Fdrive%2Froot%2Fchildren&amp;method=GET&amp;version=v1.0" target="_blank" rel="noopener noreferrer">Graph Explorer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 进行测试。</p> <p>而具体使用方法，就直接看<a href="https://docs.microsoft.com/zh-cn/onedrive/developer/rest-api/?view=odsp-graph-online" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>啦。这文档蛮详细的，边写边看就行。</p> <p>由于 REST API 的寻址部分比较麻烦，我使用 Python 对 API 进行了简单封装，代码在 <a href="https://github.com/uestc-msc/uestcmsc_webapp_backend/tree/master/cloud/onedrive/api" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>这里只写了自己在开发过程中遇到的一些场景，以及解决方案。</p> <p>项目的场景是使用一个账户的云盘作为整个项目的共有云盘，文件上传、删除等操作全部交给后端完成。后端判断前端登录的用户权限后，使用该账户的 access_token 执行操作。</p> <h3 id="上传"><a href="#上传" class="header-anchor">#</a> 上传</h3> <p>为了省去文件经过后端服务器的流量，后端可以使用 Onedrive 的<a href="https://docs.microsoft.com/zh-cn/graph/api/driveitem-createuploadsession" target="_blank" rel="noopener noreferrer">通过上传会话上传大文件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方案上传文件。前后端和 Onedrive 的交互过程如下：</p> <ol><li>在登陆状态下，前端向后端 <code>POST /api/cloud/file</code> 发起请求，后端请求 Onedrive 生成一个临时上传对话，并将 Onedrive 的应答（格式见上面的链接）转发给前端；</li> <li>前端按照上面链接所述方法，直接向 Onedrive 上传文件。上传完成后，Onedrive 返回文件的 id 等信息，文件将位于 <code>/(应用文件夹)/temp/{userid}/</code> 文件夹；</li> <li>前端根据需求（如上传沙龙相关文件、沙龙照片）向对应接口发起请求（请求需包含文件 id），后端将文件移动至每个功能对应的文件夹，并完成后续操作（录入数据库等）。</li></ol> <h4 id="前端交互"><a href="#前端交互" class="header-anchor">#</a> 前端交互</h4> <p>前端交互原理<s>很简单</s>好像也不简单，对于错误处理就更麻烦了，虽然 MS Graph 最后给了对各种错误处理的详细策略，但是没有示例代码还是很麻烦。</p> <p>因此，这里放一个我的 JavaScript 实现，其中 <code>createUploadSession</code> 是创建上传会话的接口。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 调用后端接口，将文件上传至 onedrive。</span>
<span class="token comment">// 参考文档：https://docs.microsoft.com/zh-cn/graph/api/driveitem-createuploadsession</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadFile</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createUploadSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;filename&quot;</span><span class="token operator">:</span> file<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> uploadUrl <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>uploadUrl<span class="token punctuation">;</span>
  <span class="token keyword">let</span> size <span class="token operator">=</span> file<span class="token punctuation">.</span>size<span class="token punctuation">;</span>

  <span class="token keyword">const</span> totalRetryTimes <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">// 4xx 导致的上传失败的重试次数</span>
  <span class="token keyword">const</span> firstDelay <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>    <span class="token comment">// 5xx 导致的上传失败的第一次等待时间（之后采用 * 2 的指数退避策略）</span>

  <span class="token comment">// MS 直接给了上传时错误处理的策略，nb！</span>
  <span class="token comment">// https://docs.microsoft.com/zh-cn/graph/api/driveitem-createuploadsession#best-practices</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">uploadPart</span><span class="token punctuation">(</span><span class="token parameter">start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> retryTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> nextDelay <span class="token operator">=</span> firstDelay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.log(`uploadPart: start=${start}, end=${end}, retryTimes=${retryTimes}, nextDelay=${nextDelay}`);</span>
    <span class="token keyword">let</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    headers<span class="token punctuation">[</span><span class="token string">'Content-Range'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bytes </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>end <span class="token operator">-</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>size<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    headers<span class="token punctuation">[</span><span class="token string">'Content-Type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> file<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
      withCredentials<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      timeout<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      headers
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      res <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>uploadUrl<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
      status <span class="token operator">=</span> res<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      status <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&gt;=</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 继续或重试由于连接中断或任意 5xx 错误而失败的上载</span>
      <span class="token comment">// 请使用指数退避战略</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">上传失败，等待 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextDelay <span class="token operator">/</span> <span class="token number">1000</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">s 后上传...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">await</span> <span class="token function">sleep</span><span class="token punctuation">(</span>nextDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">uploadPart</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> retryTimes<span class="token punctuation">,</span> nextDelay <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 成功上传该段，返回</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对于其他错误，不应使用指数退避战略，而应限制尝试重试的次数</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTimes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTimes <span class="token operator">&gt;</span> totalRetryTimes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">上传失败 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>retryTimes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 次，取消上传</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">throw</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">上传失败 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>retryTimes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 次，重试中...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">uploadPart</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> retryTimes<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> nextDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 200 为上传成功（覆盖），201 为上传成功（新建）</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>status <span class="token operator">!==</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> status <span class="token operator">!==</span> <span class="token number">201</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>start <span class="token operator">+</span> maxFileContentLength<span class="token punctuation">,</span> file<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">uploadPart</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    start <span class="token operator">=</span> end<span class="token punctuation">;</span>
    status <span class="token operator">=</span> res<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段代码还没有加上传进度等功能，不过上传的大体思路就是这样的。</p> <h3 id="下载"><a href="#下载" class="header-anchor">#</a> 下载</h3> <p>为了省去文件经过后端服务器的流量，本后端只提供下载链接。由于 Onedrive API 限制，提供两种下载链接：</p> <ul><li>永久链接，但需在浏览器中访问</li> <li>临时链接（Onedrive 链接有效期 15min，但本后端提供即时获取链接并重定向的 REST API）</li></ul> <h4 id="永久链接"><a href="#永久链接" class="header-anchor">#</a> 永久链接</h4> <p>有网友发现，手动或<a href="https://docs.microsoft.com/zh-cn/graph/api/driveitem-createlink?view=graph-rest-1.0" target="_blank" rel="noopener noreferrer">利用 Onedrive API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 生成分享链接后，在分享链接后追加 <code>?download=1</code> 参数，在浏览器访问该链接即可自动下载文件。</p> <p>但该链接对应的 html 需要运行 JavaScript，因此不能通过 Python <code>requests</code> 或 JavaScript <code>XMLHTTPRequest</code> 直接下载。推荐使用后面的 API，或者在 JavaScript 使用 <code>window.open()</code> 在新窗口打开这个链接。</p> <h4 id="临时链接"><a href="#临时链接" class="header-anchor">#</a> 临时链接</h4> <p><a href="https://docs.microsoft.com/zh-cn/graph/api/driveitem-get-content" target="_blank" rel="noopener noreferrer">利用 Onedrive API 下载文件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 时，响应报文为 <code>302 Found</code>，<code>Location</code> 为一个下载 URL。该 URL 仅在较短的一段时间 （几分钟后）内有效，不需要认证即可下载。</p> <p>本后端提供 <code>/cloud/file/{id}/download/</code> API，该 API 调用上述 API 后将报文返回给前端。</p></div> <hr role="separator" aria-orientation="horizontal" class="ma-4 v-divider theme--light"> <!----></div></div></article></div> <!----></div></div> <div role="dialog" class="v-dialog__container"><button type="button" role="button" aria-haspopup="true" aria-expanded="false" class="v-btn v-btn--bottom v-btn--is-elevated v-btn--fab v-btn--fixed v-btn--has-bg v-btn--right v-btn--round theme--dark v-size--default primary"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-information-variant theme--dark"></i></span></button><!----></div></div></div></main> <footer id="footer" class="v-footer v-sheet theme--light v-footer--absolute v-footer--padless v-footer--inset" style="left:0px;right:0px;bottom:0px;"><div class="lighten-1 text-center v-card v-sheet theme--light rounded-0" style="width:100%;"><div class="v-card__text"><a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" style="font-size:24px;"></i></span></a><a href="https://blog.lyh543.cn/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-web theme--light" style="font-size:24px;"></i></span></a><a href="mailto:lyh543@outlook.com" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-email theme--light" style="font-size:24px;"></i></span></a><a href="https://weibo.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-sina-weibo theme--light" style="font-size:24px;"></i></span></a><a href="https://weixin.qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-wechat theme--light" style="font-size:24px;"></i></span></a><a href="https://qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-qqchat theme--light" style="font-size:24px;"></i></span></a><a href="https://bilibili.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><div class="v-image v-responsive theme--light" style="max-width:24px;"><div class="v-image__image v-image__image--preload v-image__image--cover" style="background-image:;background-position:center center;"></div><div class="v-responsive__content"></div></div></span></a></div> <hr role="separator" aria-orientation="horizontal" class="v-divider theme--light"> <div class="v-card__text"><span class="footer-text">lyh543 © 2019 - 2021</span>
        |
      <a href="https://beian.miit.gov.cn/" target="_blank" class="footer-link">蜀ICP备19034464号</a>
        |
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" class="footer-link">署名 - 非商业性 - 相同方式共享 4.0 国际协议</a>
        |
       <span class="footer-text">
        Theme
        <a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="footer-link">
          vuepress-theme-blog-material
        </a></span></div></div></footer></div></div><div class="global-ui"><div id="pwa-snackbar" class="v-snack v-snack--bottom v-snack--has-background v-snack--right v-snack--vertical" style="padding-bottom:0px;padding-top:0px;" data-v-fec8b358><div class="v-snack__wrapper v-sheet theme--dark" style="display:none;"><div role="status" aria-live="polite" class="v-snack__content">
    博客已更新！
    </div><div class="v-snack__action "><button type="button" id="pwa-button" class="v-btn v-btn--has-bg theme--dark v-size--default v-snack__btn"><span class="v-btn__content">
        刷新
      </span></button></div></div></div></div></div>
    <script src="/assets/js/app.0b99cce4.js" defer></script><script src="/assets/js/20.13b73a09.js" defer></script><script src="/assets/js/4.c36cbde9.js" defer></script>
  </body>
</html>
