<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>FFmpeg （萌新向） | 小灰灰灰灰的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/theme/favicon.png">
    <link rel="alternate" type="application/rss+xml" href="https://blog.lyh543.cn/rss.xml" title="小灰灰灰灰的博客 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.lyh543.cn/feed.atom" title="小灰灰灰灰的博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.lyh543.cn/feed.json" title="小灰灰灰灰的博客 JSON Feed">
    <meta name="description" content="

操作|参数|示例
-|-|-
基本命令|ffmpeg -i  |ffmpeg -i input.mp4 output.mp4
自动覆盖/自动不覆盖|-y / -n|ffmpeg -y -i input.mp4 output.mp4
裁剪视频|-ss  -to |`ffmpeg -i input.mp4 -ss 00:01:00 - ...">
    
    <link rel="preload" href="/assets/css/0.styles.832ac33f.css" as="style"><link rel="preload" href="/assets/js/app.e233a8ab.js" as="script"><link rel="preload" href="/assets/js/151.21d32f8d.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.832ac33f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="v-application v-application--is-ltr theme--light"><div class="v-application--wrap"><!----> <main id="main-content" class="v-main" style="padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-main__wrap"><div><container class="article-column-container"><div class="article-column"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div class="v-card v-sheet theme--light"><div class="container"><div itemprop="articleBody" class="markdown-body content__default"><h2 id="cheatsheet"><a href="#cheatsheet" class="header-anchor">#</a> CheatSheet</h2> <table><thead><tr><th>操作</th> <th>参数</th> <th>示例</th></tr></thead> <tbody><tr><td>基本命令</td> <td><code>ffmpeg -i &lt;输入&gt; &lt;输出&gt;</code></td> <td><code>ffmpeg -i input.mp4 output.mp4</code></td></tr> <tr><td>自动覆盖/自动不覆盖</td> <td><code>-y</code> / <code>-n</code></td> <td><code>ffmpeg -y -i input.mp4 output.mp4</code></td></tr> <tr><td>裁剪视频</td> <td><code>-ss &lt;开始时间&gt; -to &lt;结束时间&gt;</code></td> <td><code>ffmpeg -i input.mp4 -ss 00:01:00 -to 01:01:00 -c copy output.mp4</code></td></tr> <tr><td>改变视频码率、分辨率</td> <td><code>-b &lt;码率&gt; -vf scale=&lt;宽&gt;:&lt;高&gt;</code></td> <td><code>ffmpeg -i input.mp4 -b:v 2M -vf scale=1280:720 output.mp4</code></td></tr> <tr><td>添加字幕流</td> <td><code>-i &lt;字幕&gt;.srt -c:s mov_text</code></td> <td><code>ffmpeg -i input.mp4 -i infile.srt -c:v copy -c:s mov_text output.mp4</code></td></tr> <tr><td>将字幕编码进视频</td> <td><code>-vf subtitles=&lt;字幕&gt;.srt</code></td> <td><code>ffmpeg -i input.mp4 -vf subtitles=infile.srt output.mp4</code></td></tr> <tr><td>查询当前 ffmpeg 支持的硬件加速</td> <td><code>ffmpeg -hwaccels</code></td> <td></td></tr> <tr><td>查询编码格式和解码、编器</td> <td><code>ffmpeg -codecs</code></td> <td></td></tr> <tr><td>不重新编码</td> <td><code>-c copy</code></td> <td><code>ffmpeg -i input.mp4 -ss 00:01:00 -to 01:00:00 -c copy output.mp4</code></td></tr> <tr><td>使用 Nvidia 显卡加速，编码为 H.265</td> <td><code>-hwaccel cuda -c:v hevc_nvenc</code></td> <td><code>ffmpeg -hwaccel cuda -i input.mp4 -b 2M -c:v hevc_nvenc -vf 'scale=-1:720' output.mp4</code></td></tr> <tr><td>使用 AMD 显卡加速，编码为 H.265（Windows）</td> <td><code>-hwaccel amf -c:v hevc_amf</code></td> <td><code>ffmpeg -hwaccel amf -i input.mp4 -b 2M -c:v hevc_amf -vf 'scale=-1:720' output.mp4</code></td></tr> <tr><td>使用 AMD 显卡加速，编码为 H.265（Linux）</td> <td><code>-hwaccel vaapi -c:v hevc_vaapi -vf 'format=nv12, hwupload'</code></td> <td><code>ffmpeg -hwaccel vaapi -i input.mp4 -b:v 2M -c:v hevc_vaapi -vf 'scale=-1:720, format=nv12, hwupload' output.mp4</code></td></tr></tbody></table> <h2 id="视频处理"><a href="#视频处理" class="header-anchor">#</a> 视频处理</h2> <h3 id="裁剪视频-不重新编码"><a href="#裁剪视频-不重新编码" class="header-anchor">#</a> 裁剪视频（不重新编码）</h3> <p>开始接触 ffmpeg 就是在裁剪视频长度的时候。Premier、格式工厂、Windows 照片自带的裁剪等软件都需要对视频进行重新编码。而 ffmpeg 则可以通过设置参数 <code>-c copy</code>，在创建视频流的时候不重新编码，这样的好处是<strong>裁剪的过程基本就是文件复制的过程</strong>，CPU 不再成为性能瓶颈，SSD 上速度是真滴快。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ffmpeg -i input.mp4 -ss 00:01:00 -to 01:01:00 -c copy output.mp4
</code></pre></div><p><code>-i</code> 参数指定输入文件，<code>-ss</code> 指定开始裁剪的时间，<code>-to</code> 指定结束裁剪的时间（也可以使用 <code>-t</code> 指定裁剪总长度），<code>-c</code> 指定编码格式。</p> <h3 id="改变码率和分辨率"><a href="#改变码率和分辨率" class="header-anchor">#</a> 改变码率和分辨率</h3> <ul><li>限制码率：使用参数 <code>-b 2M</code> 将视频和音频的总平均码率限制在 2Mbps。</li> <li>修改视频分辨率：使用参数 <code>-vf scale=640:480</code>，或省略一个参数 <code>-vf scale=-1:480</code>，程序将自动按比例缩放。</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>ffmpeg -i input.mp4 -b 2M -vf <span class="token assign-left variable">scale</span><span class="token operator">=</span>-1:720 output.mp4
</code></pre></div><p>需要注意的是，高分辨率对应低码率，会导致画质变低，甚至出现花屏（b 站现状）。</p> <h3 id="添加字幕"><a href="#添加字幕" class="header-anchor">#</a> 添加字幕</h3> <p>添加字幕有两种方案。</p> <p>一种是把将字幕作为视频流、音频流以外的第三种流：字幕流，传进去。这种方案的兼容性完全取决于播放器能否支持，不过好处是可以不重新编码视频。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ffmpeg -i infile.mp4 -i infile.srt -c copy -c:s mov_text outfile.mp4
</code></pre></div><p>第二种方案是将字幕写到视频上，这种兼容性好，不过默认的字体似乎比较丑。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ffmpeg -i infile.mp4 -vf <span class="token assign-left variable">subtitles</span><span class="token operator">=</span>infile.srt outfile.mp4
</code></pre></div><p>调整字幕的格式可以参考<a href="https://ffmpeg.org/ffmpeg-all.html#subtitles-1" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>如果不支持非 srt 格式的字幕，ffmpeg 也提供了将 ass 字幕转换为 srt 的命令：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ffmpeg -i subs.ass -c:s srt output.srt
</code></pre></div><h2 id="加速-ffmpeg"><a href="#加速-ffmpeg" class="header-anchor">#</a> 加速 ffmpeg</h2> <h3 id="不重新编码"><a href="#不重新编码" class="header-anchor">#</a> 不重新编码</h3> <p>ffmpeg 则可以通过设置参数 <code>-c copy</code>，在创建视频流的时候不重新编码，这样的好处是<strong>裁剪的过程基本就是文件复制的过程</strong>，CPU 不再成为性能瓶颈，SSD 上速度是真滴快。</p> <p>当然这里仅适用于于不改变视频编码格式和内容的情况（如修改音频流、字幕流、裁剪视频），如果要修改视频分辨率、码率等，当然需要重新编码。</p> <p>下面是裁剪视频的例子：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ffmpeg -i input.mp4 -ss 00:01:00 -to 01:00:00 -c copy output.mp4
</code></pre></div><h3 id="使用-gpu-加速-ffmpeg-编码"><a href="#使用-gpu-加速-ffmpeg-编码" class="header-anchor">#</a> 使用 GPU 加速 ffmpeg 编码</h3> <h4 id="理论知识"><a href="#理论知识" class="header-anchor">#</a> 理论知识</h4> <p>ffmpeg 有<a href="https://trac.ffmpeg.org/wiki/HWAccelIntro" target="_blank" rel="noopener noreferrer">介绍硬件加速的 wiki<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，包括各方法在平台上的兼容性、各方法支持的功能等。</p> <p><img src="/images/1b4899f4d614f1dee1f4c357560ebc2169b38a22103e4b6a1bd1c5dfce89494b.png" alt="各方法在平台上的兼容性（字典序）"></p> <p><img src="/images/38e4449ffdc6a093a33303a5b6740d7e8db4be5f88798917f034934274343c25.png" alt="ffmpeg 使用各方法实现的 API 完整度"></p> <p>可以看到虽然 OpenCL 在各平台上的兼容性非常好，但是它压根不支持编、解码。<code>Direct3D 11</code> 和 <code>Direct3D 9</code> 虽然支持 Windows 平台的所有显卡，但同样不支持编、解码。</p> <p>总结下来，根据显卡和操作系统，推荐如下：</p> <ul><li>Nvidia 显卡 -&gt; 无脑 <code>CUDA (NVENC/NVDEC/CUVID)</code>；</li> <li>Intel 显卡 -&gt; <code>libmfx</code>；</li> <li>AMD 显卡 + Windows -&gt; <code>AMF</code>；</li> <li>AMD 显卡 + Linux -&gt; <code>VAAPI</code>；</li> <li>macOS / iOS -&gt; <code>VideoToolbox</code>。</li></ul> <h4 id="实践-nvidia-windows"><a href="#实践-nvidia-windows" class="header-anchor">#</a> 实践：Nvidia + Windows</h4> <p>查看当前 ffmpeg 支持的硬件加速方法：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token operator">&gt;</span> ffmpeg -hwaccels
ffmpeg version <span class="token number">5.0</span>.1-essentials_build-www.gyan.dev Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>-2022 the FFmpeg developers
  built with gcc <span class="token number">11.2</span>.0 <span class="token punctuation">(</span>Rev7, Built by MSYS2 project<span class="token punctuation">)</span>
  configuration: --enable-gpl --enable-version3 --enable-static --disable-w32threads --disable-autodetect --enable-fontconfig --enable-iconv --enable-gnutls --enable-libxml2 --enable-gmp --enable-lzma --enable-zlib --enable-libsrt --enable-libssh --enable-libzmq --enable-avisynth --enable-sdl2 --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxvid --enable-libaom --enable-libopenjpeg --enable-libvpx --enable-libass --enable-libfreetype --enable-libfribidi --enable-libvidstab --enable-libvmaf --enable-libzimg --enable-amf --enable-cuda-llvm --enable-cuvid --enable-ffnvcodec --enable-nvdec --enable-nvenc --enable-d3d11va --enable-dxva2 --enable-libmfx --enable-libgme --enable-libopenmpt --enable-libopencore-amrwb --enable-libmp3lame --enable-libtheora --enable-libvo-amrwbenc --enable-libgsm --enable-libopencore-amrnb --enable-libopus --enable-libspeex --enable-libvorbis --enable-librubberband
  libavutil      <span class="token number">57</span>. <span class="token number">17.100</span> / <span class="token number">57</span>. <span class="token number">17.100</span>
  libavcodec     <span class="token number">59</span>. <span class="token number">18.100</span> / <span class="token number">59</span>. <span class="token number">18.100</span>
  libavformat    <span class="token number">59</span>. <span class="token number">16.100</span> / <span class="token number">59</span>. <span class="token number">16.100</span>
  libavdevice    <span class="token number">59</span>.  <span class="token number">4.100</span> / <span class="token number">59</span>.  <span class="token number">4.100</span>
  libavfilter     <span class="token number">8</span>. <span class="token number">24.100</span> /  <span class="token number">8</span>. <span class="token number">24.100</span>
  libswscale      <span class="token number">6</span>.  <span class="token number">4.100</span> /  <span class="token number">6</span>.  <span class="token number">4.100</span>
  libswresample   <span class="token number">4</span>.  <span class="token number">3.100</span> /  <span class="token number">4</span>.  <span class="token number">3.100</span>
  libpostproc    <span class="token number">56</span>.  <span class="token number">3.100</span> / <span class="token number">56</span>.  <span class="token number">3.100</span>
Hardware acceleration methods:
cuda
dxva2
qsv
d3d11va
</code></pre></div><p>这里由于使用的是 N 卡，于是确定使用 <code>cuda</code>。</p> <p>选择编码格式和对应的编码器：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token operator">&gt;</span> ffmpeg -codecs
<span class="token comment"># 略过一堆输出</span>
 DEV.L. h261                 H.261
 DEV.L. h263                 H.263 / H.263-1996, H.263+ / H.263-1998 / H.263 version <span class="token number">2</span>
 D.V.L. h263i                Intel H.263
 DEV.L. h263p                H.263+ / H.263-1998 / H.263 version <span class="token number">2</span>
 DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part <span class="token number">10</span> <span class="token punctuation">(</span>decoders: h264 h264_qsv h264_cuvid <span class="token punctuation">)</span> <span class="token punctuation">(</span>encoders: libx264 libx264rgb h264_amf h264_nvenc h264_qsv <span class="token punctuation">)</span>
 D.VIL. hap                  Vidvox Hap
 DEV.L. hevc                 H.265 / HEVC <span class="token punctuation">(</span>High Efficiency Video Coding<span class="token punctuation">)</span> <span class="token punctuation">(</span>decoders: hevc hevc_qsv hevc_cuvid <span class="token punctuation">)</span> <span class="token punctuation">(</span>encoders: libx265 hevc_amf hevc_nvenc hevc_qsv <span class="token punctuation">)</span>
</code></pre></div><p>我们使用 <code>H.265</code>(<code>HEVC</code>) 格式编码，用 CUDA 加速编码过程。对应的编码器为 <code>hevc_nvenc</code>。（解码器似乎会根据硬件加速 + 输入文件格式自动选择，不需要指定）</p> <p>最后写命令：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>ffmpeg -hwaccel cuda -i input.mp4 -c:v hevc_nvenc -c:a copy output.mp4
</code></pre></div><p>其中 <code>-c</code> 参数放在 <code>-i</code> 后，表示修改编码格式（在 <code>-i</code> 前则是解码格式）；<code>-c:v</code> 是修改视频编码格式，<code>-c:a</code> 是修改音频编码格式。</p> <p>如果提示 Nvidia 驱动版本太低，需要更新驱动。</p> <h4 id="实践-amd-linux"><a href="#实践-amd-linux" class="header-anchor">#</a> 实践：AMD + Linux</h4> <p>这里使用的是 AMD Ryzen 4600U 的核显。</p> <p>查看当前 ffmpeg 支持的硬件加速方法：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token operator">&gt;</span> ffmpeg -hwaccels
ffmpeg version n5.0 Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2000</span>-2022 the FFmpeg developers
  built with gcc <span class="token number">11.2</span>.0 <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span>
  configuration: --prefix<span class="token operator">=</span>/usr --disable-debug --disable-static --disable-stripping --enable-amf --enable-avisynth --enable-cuda-llvm --enable-lto --enable-fontconfig --enable-gmp --enable-gnutls --enable-gpl --enable-ladspa --enable-libaom --enable-libass --enable-libbluray --enable-libdav1d --enable-libdrm --enable-libfreetype --enable-libfribidi --enable-libgsm --enable-libiec61883 --enable-libjack --enable-libmfx --enable-libmodplug --enable-libmp3lame --enable-libopencore_amrnb --enable-libopencore_amrwb --enable-libopenjpeg --enable-libopus --enable-libpulse --enable-librav1e --enable-librsvg --enable-libsoxr --enable-libspeex --enable-libsrt --enable-libssh --enable-libsvtav1 --enable-libtheora --enable-libv4l2 --enable-libvidstab --enable-libvmaf --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxcb --enable-libxml2 --enable-libxvid --enable-libzimg --enable-nvdec --enable-nvenc --enable-shared --enable-version3
  libavutil      <span class="token number">57</span>. <span class="token number">17.100</span> / <span class="token number">57</span>. <span class="token number">17.100</span>
  libavcodec     <span class="token number">59</span>. <span class="token number">18.100</span> / <span class="token number">59</span>. <span class="token number">18.100</span>
  libavformat    <span class="token number">59</span>. <span class="token number">16.100</span> / <span class="token number">59</span>. <span class="token number">16.100</span>
  libavdevice    <span class="token number">59</span>.  <span class="token number">4.100</span> / <span class="token number">59</span>.  <span class="token number">4.100</span>
  libavfilter     <span class="token number">8</span>. <span class="token number">24.100</span> /  <span class="token number">8</span>. <span class="token number">24.100</span>
  libswscale      <span class="token number">6</span>.  <span class="token number">4.100</span> /  <span class="token number">6</span>.  <span class="token number">4.100</span>
  libswresample   <span class="token number">4</span>.  <span class="token number">3.100</span> /  <span class="token number">4</span>.  <span class="token number">3.100</span>
  libpostproc    <span class="token number">56</span>.  <span class="token number">3.100</span> / <span class="token number">56</span>.  <span class="token number">3.100</span>
Hardware acceleration methods:
vdpau
cuda
vaapi
qsv
drm
</code></pre></div><p>这里由于使用的是 A 卡，于是确定使用 <code>vaapi</code>。</p> <p>选择编码格式和对应的编码器：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token operator">&gt;</span> ffmpeg -codecs
<span class="token comment"># 略过一堆输出</span>
 DEV.L. h261                 H.261
 DEV.L. h263                 H.263 / H.263-1996, H.263+ / H.263-1998 / H.263 version <span class="token number">2</span> <span class="token punctuation">(</span>decoders: h263 h263_v4l2m2m <span class="token punctuation">)</span> <span class="token punctuation">(</span>encoders: h263 h263_v4l2m2m <span class="token punctuation">)</span>
 D.V.L. h263i                Intel H.263
 DEV.L. h263p                H.263+ / H.263-1998 / H.263 version <span class="token number">2</span>
 DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part <span class="token number">10</span> <span class="token punctuation">(</span>decoders: h264 h264_v4l2m2m h264_qsv h264_cuvid <span class="token punctuation">)</span> <span class="token punctuation">(</span>encoders: libx264 libx264rgb h264_amf h264_nvenc h264_qsv h264_v4l2m2m h264_vaapi <span class="token punctuation">)</span>
 D.VIL. hap                  Vidvox Hap
 DEV.L. hevc                 H.265 / HEVC <span class="token punctuation">(</span>High Efficiency Video Coding<span class="token punctuation">)</span> <span class="token punctuation">(</span>decoders: hevc hevc_qsv hevc_v4l2m2m hevc_cuvid <span class="token punctuation">)</span> <span class="token punctuation">(</span>encoders: libx265 hevc_amf hevc_nvenc hevc_qsv hevc_v4l2m2m hevc_vaapi <span class="token punctuation">)</span>
</code></pre></div><p>我们使用 <code>H.265</code>(<code>HEVC</code>) 格式编码，用 CUDA 加速编码过程。对应的编码器为 <code>hevc_vaapi</code>。（解码器似乎会根据硬件加速 + 输入文件格式自动选择，不需要指定）</p> <p>最后写命令，但是报错了：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token operator">&gt;</span> ffmpeg -hwaccel vaapi -i input.mp4 -c:v hevc_vaapi output.mp4
<span class="token comment"># 略过一堆输出</span>
Impossible to convert between the formats supported by the filter <span class="token string">'Parsed_null_0'</span> and the filter <span class="token string">'auto_scale_0'</span>
Error reinitializing filters<span class="token operator">!</span>
Failed to inject frame into filter network: Function not implemented
Error <span class="token keyword">while</span> processing the decoded data <span class="token keyword">for</span> stream <span class="token comment">#0:0</span>
</code></pre></div><p>搜索<a href="https://superuser.com/questions/1633883/ffmpeg-hevc-vaapi-impossible-to-convert-between-the-formats-supported-by-the-fi" target="_blank" rel="noopener noreferrer">相关回答<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以后，加入 <code>-vf 'format=nv12,hwupload'</code>，成功解决。</p> <div class="language- extra-class"><pre class="language-text"><code>&gt; ffmpeg -hwaccel vaapi -i input.mp4 -c:v hevc_vaapi -vf &quot;format=nv12, hwupload&quot; output.mp4
</code></pre></div><p>核显相较 CPU 还是能有一倍的提升。不过看 <code>radeontop</code> 还是没有占满，估计瓶颈是在内存速度上。</p> <h2 id="其他魔法"><a href="#其他魔法" class="header-anchor">#</a> 其他魔法</h2> <h3 id="下载-m3u8"><a href="#下载-m3u8" class="header-anchor">#</a> 下载 m3u8</h3> <blockquote><p>省流：ffmpeg 自带的有 bug，可以使用封装过的 <a href="https://github.com/HeiSir2014/M3U8-Downloader" target="_blank" rel="noopener noreferrer">HeiSir2014/M3U8-Downloader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></blockquote> <p>m3u8 是一种流媒体格式，常用于在线观看、直播等。如腾讯课堂的回看就是以这个格式提供的。</p> <p>网上有不少 m3u8 下载器，我一直使用的是 <a href="https://github.com/nilaoda/M3U8-Downloader" target="_blank" rel="noopener noreferrer">nilaoda/M3U8-Downloader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。我也知道它用到了 <code>ffmpeg</code>，不过一直以为它只是做了视频合并。</p> <p>今天使用某 APP 时，刚开始没有找到现成的将加密 m3u8 转为 mp4 的轮子，于是自己想按照<a href="https://www.jianshu.com/p/1b0adcc7b426" target="_blank" rel="noopener noreferrer">博客<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 手写一个 shell 脚本实现。但看到最后，没想到 ffmpeg 还能一行（从网络或从本地）下载 m3u8 并转为单文件！nb！</p> <p>下面给出三个版本的用法（一般采用第一个就行，最快）：</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 不重新编码</span>
ffmpeg -allowed_extensions ALL -i <span class="token string">&quot;URL&quot;</span> -c:v copy output.mp4

<span class="token comment"># 使用默认编码进行编码（应该是 h264 吧）</span>
ffmpeg -allowed_extensions ALL -i <span class="token string">&quot;URL&quot;</span> output.mp4

<span class="token comment"># 使用 CUDA 编码为 h265</span>
ffmpeg -allowed_extensions ALL -hwaccel cuda -i <span class="token string">&quot;URL&quot;</span> -c:v hevc_nvenc output.mp4
</code></pre></div><ul><li><code>-allowed_extensions ALL</code>：m3u8 可能涉及到加密，需要读取 <code>.key</code> 秘钥文件；而 <code>ffmpeg</code> 默认不让读取媒体格式以外的格式，所以需要加这个参数允许读取所有格式；</li> <li><code>&quot;URL&quot;</code>：替换为本地路径或 HTTP URL 均可。也可以用 <code>wget</code> 或 <code>curl</code> 将 URL 中的 m3u8 源文件下载下来，再运行 <code>ffmpeg</code>；</li> <li><code>output.mp4</code>：输出文件，没什么好说的。</li></ul> <p>但是如果下载片段中有失败的，ffmpeg 不会重复请求，而是直接忽略错误，导致下载下来效果不是很好。可以使用 <a href="https://github.com/HeiSir2014/M3U8-Downloader" target="_blank" rel="noopener noreferrer">HeiSir2014/M3U8-Downloader<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来替代，这个插件是下载和合并分开实现，因此不会出现这个问题。</p></div> <hr role="separator" aria-orientation="horizontal" class="ma-4 v-divider theme--light"> <div data-v-54a1e472><script src="https://giscus.app/client.js" async="async" service="giscus" data-repo="lyh543/blog-comments" data-repo-id="R_kgDOHIb2Zg" data-category="Announcements" data-category-id="DIC_kwDOHIb2Zs4COh2z" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" data-v-54a1e472></script></div></div></div></article></div> <!----></container> <div class="v-dialog__container"><button type="button" role="button" aria-haspopup="true" aria-expanded="false" class="v-btn v-btn--bottom v-btn--is-elevated v-btn--fab v-btn--fixed v-btn--has-bg v-btn--right v-btn--round theme--dark v-size--default primary"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-information-variant theme--dark"></i></span></button><!----></div></div></div></main> <footer id="footer" class="v-footer v-sheet theme--light v-footer--absolute v-footer--padless v-footer--inset" style="left:0px;right:0px;bottom:0px;"><div class="lighten-1 text-center v-card v-sheet theme--light rounded-0" style="width:100%;"><div class="v-card__text"><a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" style="font-size:24px;"></i></span></a><a href="https://blog.lyh543.cn/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-web theme--light" style="font-size:24px;"></i></span></a><a href="mailto:lyh543@outlook.com" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-email theme--light" style="font-size:24px;"></i></span></a><a href="https://weibo.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-sina-weibo theme--light" style="font-size:24px;"></i></span></a><a href="https://weixin.qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-wechat theme--light" style="font-size:24px;"></i></span></a><a href="https://qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-qqchat theme--light" style="font-size:24px;"></i></span></a><a href="https://bilibili.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><div class="v-image v-responsive theme--light" style="max-width:24px;"><div class="v-image__image v-image__image--preload v-image__image--cover" style="background-image:;background-position:center center;"></div><div class="v-responsive__content"></div></div></span></a></div> <hr role="separator" aria-orientation="horizontal" class="v-divider theme--light"> <div class="v-card__text"><span class="footer-text">lyh543 © 2019 - 2024</span>
        |
      <a href="https://beian.miit.gov.cn/" target="_blank" class="footer-link">蜀ICP备19034464号</a>
        |
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" class="footer-link">署名 - 非商业性 - 相同方式共享 4.0 国际协议</a>
        |
       <span class="footer-text">
        Theme
        <a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="footer-link">
          vuepress-theme-blog-material
        </a></span></div></div></footer></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e233a8ab.js" defer></script><script src="/assets/js/151.21d32f8d.js" defer></script>
  </body>
</html>
