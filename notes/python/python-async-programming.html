<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python 异步编程 | 小灰灰灰灰的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/theme/favicon.png">
    <link rel="alternate" type="application/rss+xml" href="https://blog.lyh543.cn/rss.xml" title="小灰灰灰灰的博客 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.lyh543.cn/feed.atom" title="小灰灰灰灰的博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.lyh543.cn/feed.json" title="小灰灰灰灰的博客 JSON Feed">
    <meta name="description" content="所有异步函数在主线程里使用，所有耗时的同步函数在子线程里使用
Django ASGIHandler 自动区分了这一点，因此不用担心同步 View 和异步 View 混用的问题
Python 异步模型类似于 JavaScript 的 Promise 模型（调用异步函数返回一个对象，可以向对象查询执行结果、或者 await），但有一点区别是，Python 创建的 `coroutine ...">
    
    <link rel="preload" href="/assets/css/0.styles.832ac33f.css" as="style"><link rel="preload" href="/assets/js/app.f9276a7f.js" as="script"><link rel="preload" href="/assets/js/157.316d41bf.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.832ac33f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="v-application v-application--is-ltr theme--light"><div class="v-application--wrap"><!----> <main id="main-content" class="v-main" style="padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-main__wrap"><div><container class="article-column-container"><div class="article-column"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div class="v-card v-sheet theme--light"><div class="container"><div itemprop="articleBody" class="markdown-body content__default"><ol><li>所有异步函数在主线程里使用，所有耗时的同步函数在子线程里使用</li> <li>Django ASGIHandler 自动区分了这一点，因此不用担心同步 View 和异步 View 混用的问题</li> <li>Python 异步模型类似于 JavaScript 的 Promise 模型（调用异步函数返回一个对象，可以向对象查询执行结果、或者 await），但有一点区别是，Python 创建的 <code>coroutine</code> 对象只有在被 <code>await</code> 或 <code>create_task</code> 调用时才会被执行，而 JavaScript 的 Promise 对象在创建时就会立即执行。</li></ol> <h2 id="为什么异步卡住了"><a href="#为什么异步卡住了" class="header-anchor">#</a> 为什么异步卡住了</h2> <p>大概率是主线程在运行 I/O 阻塞的代码（如 <code>time.sleep()</code>、<code>requests.get()</code>、大文件 <code>f.read()</code>）。因为 Python 兼容性问题，还有大量代码是使用阻塞 I/O 的。</p> <p>注意一个坑点：<code>asgiref.sync.sync_to_async</code> 这个函数可以把同步函数转换为异步函数，但它有一个参数 <code>thread_sensitive</code>，默认值为 <code>True</code>，表示如果同步函数是线程敏感的（如使用了线程锁、Django ORM），则会在子线程中运行，否则会在主线程中运行。这个参数的默认值可能会导致异步函数卡住。所以如果同步函数有 I/O 阻塞的代码，需要调用 <code>sync_to_async(func, thread_sensitive=False)</code> 来确保它在子线程中运行，这样就等价于 <code>loop.run_in_executor(None, func)</code>。</p> <p>现在事件循环被同步函数卡住的问题还是很麻烦，没有显式的警告或错误提示，只能靠开发者的经验和对代码的熟悉程度来判断。</p> <h2 id="异步的好处"><a href="#异步的好处" class="header-anchor">#</a> 异步的好处</h2> <p>Async IO doesn't necessarily speeds up your code, it just reduces the server resources usage for concurrent tasks by leveraging concurrent network IO in a single-threaded application.</p> <hr> <p>I think this misses the main appeal of async. It's not about speed but about the programming model. Async makes it much easier to work with and compose concurrency compared to the thread based model. Just the fact that you can cancel tasks makes it trivial to do proper timeouts, which nobody gets right in sync applications, for example.
我认为这忽略了异步的主要吸引力。异步的魅力不在于速度，而在于编程模型。与基于线程的模型相比，异步使得并发处理和编写更加容易。仅仅因为可以取消任务，就使得实现适当的超时变得轻而易举，而这在同步应用程序中是很难做到的。</p> <p>It also allows things like structured concurrency.
它还允许诸如结构化并发之类的事情。</p> <p>https://www.reddit.com/r/Python/comments/x9x8pb/comment/inqvsi0/?utm_source=share&amp;utm_medium=web3x&amp;utm_name=web3xcss&amp;utm_term=1&amp;utm_content=share_button</p></div> <hr role="separator" aria-orientation="horizontal" class="ma-4 v-divider theme--light"> <div data-v-54a1e472><script src="https://giscus.app/client.js" async="async" service="giscus" data-repo="lyh543/blog-comments" data-repo-id="R_kgDOHIb2Zg" data-category="Announcements" data-category-id="DIC_kwDOHIb2Zs4COh2z" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" data-v-54a1e472></script></div></div></div></article></div> <!----></container> <div class="v-dialog__container"><button type="button" role="button" aria-haspopup="true" aria-expanded="false" class="v-btn v-btn--bottom v-btn--is-elevated v-btn--fab v-btn--fixed v-btn--has-bg v-btn--right v-btn--round theme--dark v-size--default primary"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-information-variant theme--dark"></i></span></button><!----></div></div></div></main> <footer id="footer" class="v-footer v-sheet theme--light v-footer--absolute v-footer--padless v-footer--inset" style="left:0px;right:0px;bottom:0px;"><div class="lighten-1 text-center v-card v-sheet theme--light rounded-0" style="width:100%;"><div class="v-card__text"><a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" style="font-size:24px;"></i></span></a><a href="https://blog.lyh543.cn/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-web theme--light" style="font-size:24px;"></i></span></a><a href="mailto:lyh543@outlook.com" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-email theme--light" style="font-size:24px;"></i></span></a><a href="https://weibo.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-sina-weibo theme--light" style="font-size:24px;"></i></span></a><a href="https://weixin.qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-wechat theme--light" style="font-size:24px;"></i></span></a><a href="https://qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-qqchat theme--light" style="font-size:24px;"></i></span></a><a href="https://bilibili.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><div class="v-image v-responsive theme--light" style="max-width:24px;"><div class="v-image__image v-image__image--preload v-image__image--cover" style="background-image:;background-position:center center;"></div><div class="v-responsive__content"></div></div></span></a></div> <hr role="separator" aria-orientation="horizontal" class="v-divider theme--light"> <div class="v-card__text"><span class="footer-text">lyh543 © 2019 - 2024</span>
        |
      <a href="https://beian.miit.gov.cn/" target="_blank" class="footer-link">蜀ICP备19034464号</a>
        |
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" class="footer-link">署名 - 非商业性 - 相同方式共享 4.0 国际协议</a>
        |
       <span class="footer-text">
        Theme
        <a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="footer-link">
          vuepress-theme-blog-material
        </a></span></div></div></footer></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f9276a7f.js" defer></script><script src="/assets/js/157.316d41bf.js" defer></script>
  </body>
</html>
