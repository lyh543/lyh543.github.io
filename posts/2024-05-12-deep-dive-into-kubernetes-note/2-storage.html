<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《深入剖析 Kubernetes》 笔记 - 存储 | 小灰灰灰灰的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/theme/favicon.png">
    <link rel="alternate" type="application/rss+xml" href="https://blog.lyh543.cn/rss.xml" title="小灰灰灰灰的博客 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.lyh543.cn/feed.atom" title="小灰灰灰灰的博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.lyh543.cn/feed.json" title="小灰灰灰灰的博客 JSON Feed">
    <meta name="description" content="本篇是《深入剖析 Kubernetes》 的读书笔记，作者为张磊老师。

PersistentVolumeClaim &amp; PersistentVolume

Pod 一章讲过了这两个概念，这里再复制一遍。

&gt; Pod -&gt; PVC -&gt; PV
&gt;
&gt; PVC 是定义接口（大小、AccessModes 等），PV 是实现（实际存储位置、认证信息等）。而 Pod 只需要在配置里面把 PVC ...">
    
    <link rel="preload" href="/assets/css/0.styles.832ac33f.css" as="style"><link rel="preload" href="/assets/js/app.dba1c184.js" as="script"><link rel="preload" href="/assets/js/221.3847b2aa.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.832ac33f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="v-application v-application--is-ltr theme--light"><div class="v-application--wrap"><!----> <main id="main-content" class="v-main" style="padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-main__wrap"><div><container class="article-column-container"><div class="article-column"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div class="v-card v-sheet theme--light"><div class="container"><div itemprop="articleBody" class="markdown-body content__default"><p>本篇是《深入剖析 Kubernetes》 的读书笔记，作者为张磊老师。</p> <h2 id="persistentvolumeclaim-persistentvolume"><a href="#persistentvolumeclaim-persistentvolume" class="header-anchor">#</a> PersistentVolumeClaim &amp; PersistentVolume</h2> <p>Pod 一章讲过了这两个概念，这里再复制一遍。</p> <blockquote><p>Pod -&gt; PVC -&gt; PV</p> <p>PVC 是定义接口（大小、AccessModes 等），PV 是实现（实际存储位置、认证信息等）。而 Pod 只需要在配置里面把 PVC 挂载到指定路径就行。</p></blockquote> <h2 id="kubernetes-处理-pv-的流程"><a href="#kubernetes-处理-pv-的流程" class="header-anchor">#</a> Kubernetes 处理 PV 的流程</h2> <ol><li><strong>Attach</strong>（将存储块连接到 k8s）操作，其控制循环的名字为 AttachDetachController，由位于 Master 结点的 Volume Controller 负责。</li> <li><strong>Mount</strong>（将存储块挂载到容器）操作，其控制循环的名字为 VolumeManagerReconciler，由位于 Node 结点的 kubelet 负责。</li></ol> <p>在删除 PV 时，反序执行这两个操作，即 Unmount 然后 Detach 即可。</p> <h2 id="storageclass"><a href="#storageclass" class="header-anchor">#</a> StorageClass</h2> <p>StorageClass 是一个资源，用来定义 PV 的属性（比如存储类型、存储大小、存储位置等）。StorageClass 也可以定义 Provisioner（提供者），用来动态创建 PV。</p> <h2 id="自定义存储插件"><a href="#自定义存储插件" class="header-anchor">#</a> 自定义存储插件</h2> <p>K8s 开发存储插件的方式有两种：<strong>FlexVolume</strong> 和 <strong>CSI</strong>。前者更轻量级、编写简单，后者更强大、支持更多功能。</p> <h3 id="flexvolume"><a href="#flexvolume" class="header-anchor">#</a> FlexVolume</h3> <p>编写一个 FlexVolume 插件，只需要提供一个可执行文件（shell 或者二进制文件均可）。这个可执行文件需要支持几条命令：<code>/path/to/binary mount &lt;mount_dir&gt; &lt;json_params&gt;</code>，以及对应的 <code>unmount</code>、<code>attach</code>、<code>detach</code> 等命令即可。Kubernetes 在创建/删除 PV 时，会按照 Attach、Mount / Unmount、Detach 的顺序调用这些命令。</p> <p>FlexVolume 的缺点也很明显：不支持动态创建 PV、快照、克隆等功能；Attach、Mount、Unmount、Detach 的操作也是独立的，换句话说，无法将 Mount 时产生的上下文存储起来，供 Unmount 时使用。</p> <h3 id="csi-volume"><a href="#csi-volume" class="header-anchor">#</a> CSI Volume</h3> <p>而 CSI 则是一个更复杂的规范，需要实现一堆接口，Attach、Detach、Mount、Unmount 等步骤都得自己造轮子。不过造轮子的好处就是有更大的自定义空间；除此之外，CSI 还支持更多的功能，比如动态创建 PV、快照、克隆等。</p> <p>以及，CSI（容器存储接口）的定义和实现是通用的、独立于 K8s 的。这意味着 CSI 的实现会和 K8s 资源的实现（控制循环等）不太一样，CSI API 里也不会使用 Kubernetes 里的 PV 概念，而是用自己定义的 CSI Volume 概念。</p> <p><img src="/images/k8s-csi-framework.jpg" alt="K8s CSI Framework"></p> <p>K8s 使用 CSI 的架构下，涉及到更多的组件。</p> <p>有三个外部组件：Driver Registrar、External Provisioner、External Attacher，对应从 K8s 那层剥离出来负责 Amount、Detach 的功能。外部组件是相较于 K8s 核心组件而言的，它们仍然由 K8s 团队维护，这三个组件的作用就是让 K8s 能够对接、调用 CSI 插件的接口。</p> <p>右边三个组件：CSI Identity、CSI Controller、CSI Node，就是纯 CSI 实现的代码，是 CSI 插件开发者需要实现的部分。可以参考 <a href="https://github.com/kubernetes-csi/csi-driver-nfs/tree/master/pkg/nfs" target="_blank" rel="noopener noreferrer">csi-driver-nfs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的源码。</p> <table><thead><tr><th>组件</th> <th>部署位置</th> <th>作用</th></tr></thead> <tbody><tr><td>Driver Registrar</td> <td>Master 节点</td> <td>负责注册 CSI 插件</td></tr> <tr><td>External Provisioner</td> <td>Master 节点</td> <td>负责从 kube-apiserver 监听 PVC 对象，然后调用 CSI Controller 动态创建 CSI Volume</td></tr> <tr><td>External Attacher</td> <td>Master 节点</td> <td>负责从 kube-apiserver 监听 VolumeAttachment 对象，然后调用 CSI Controller Attach/Detach</td></tr> <tr><td><code>kubelet</code> (on Worker Node)</td> <td>Worker 节点</td> <td>负责 Mount/Unmount CSI Volume</td></tr> <tr><td>-</td> <td>-</td> <td>-</td></tr> <tr><td>CSI Identity</td> <td>Master &amp; Worker 节点</td> <td>负责暴露插件的元信息</td></tr> <tr><td>CSI Controller</td> <td>Master 节点</td> <td>负责动态创建 CSI Volume、快照、克隆、Attach/Detach CSI Volume 等</td></tr> <tr><td>CSI Node</td> <td>Worker 节点</td> <td>负责 Mount/Unmount CSI Volume</td></tr></tbody></table> <p>书里也讲解了 DigitalOcean 的 CSI 插件的实现，可以参考 <a href="https://github.com/digitalocean/csi-digitalocean/tree/master/driver" target="_blank" rel="noopener noreferrer">digitalocean/csi-digitalocean<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的源码。</p></div> <hr role="separator" aria-orientation="horizontal" class="ma-4 v-divider theme--light"> <div data-v-54a1e472><script src="https://giscus.app/client.js" async="async" service="giscus" data-repo="lyh543/blog-comments" data-repo-id="R_kgDOHIb2Zg" data-category="Announcements" data-category-id="DIC_kwDOHIb2Zs4COh2z" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" data-v-54a1e472></script></div></div></div></article></div> <!----></container> <div class="v-dialog__container"><button type="button" role="button" aria-haspopup="true" aria-expanded="false" class="v-btn v-btn--bottom v-btn--is-elevated v-btn--fab v-btn--fixed v-btn--has-bg v-btn--right v-btn--round theme--dark v-size--default primary"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-information-variant theme--dark"></i></span></button><!----></div></div></div></main> <footer id="footer" class="v-footer v-sheet theme--light v-footer--absolute v-footer--padless v-footer--inset" style="left:0px;right:0px;bottom:0px;"><div class="lighten-1 text-center v-card v-sheet theme--light rounded-0" style="width:100%;"><div class="v-card__text"><a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" style="font-size:24px;"></i></span></a><a href="https://blog.lyh543.cn/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-web theme--light" style="font-size:24px;"></i></span></a><a href="mailto:lyh543@outlook.com" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-email theme--light" style="font-size:24px;"></i></span></a><a href="https://weibo.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-sina-weibo theme--light" style="font-size:24px;"></i></span></a><a href="https://weixin.qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-wechat theme--light" style="font-size:24px;"></i></span></a><a href="https://qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-qqchat theme--light" style="font-size:24px;"></i></span></a><a href="https://bilibili.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><div class="v-image v-responsive theme--light" style="max-width:24px;"><div class="v-image__image v-image__image--preload v-image__image--cover" style="background-image:;background-position:center center;"></div><div class="v-responsive__content"></div></div></span></a></div> <hr role="separator" aria-orientation="horizontal" class="v-divider theme--light"> <div class="v-card__text"><span class="footer-text">lyh543 © 2019 - 2024</span>
        |
      <a href="https://beian.miit.gov.cn/" target="_blank" class="footer-link">蜀ICP备19034464号</a>
        |
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" class="footer-link">署名 - 非商业性 - 相同方式共享 4.0 国际协议</a>
        |
       <span class="footer-text">
        Theme
        <a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="footer-link">
          vuepress-theme-blog-material
        </a></span></div></div></footer></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.dba1c184.js" defer></script><script src="/assets/js/221.3847b2aa.js" defer></script>
  </body>
</html>
