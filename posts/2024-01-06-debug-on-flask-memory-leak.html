<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>调试 Flask 服务超时问题 | 小灰灰灰灰的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/theme/favicon.png">
    <link rel="alternate" type="application/rss+xml" href="https://blog.lyh543.cn/rss.xml" title="小灰灰灰灰的博客 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.lyh543.cn/feed.atom" title="小灰灰灰灰的博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.lyh543.cn/feed.json" title="小灰灰灰灰的博客 JSON Feed">
    <meta name="description" content="最近在项目里遇到个 Flask 内存泄漏的问题，前前后后 debug 了几天。

起因是有人报错，发现某个 Flask 服务出现了请求超过 3 分钟还没有返回结果。查服务日志有很多的 WORKER TIMEOUT，是 gunicorn 的进程超时后 kill 的机制。但是日志只能看到超时的进程 id，看不到是哪个请求超时了。正好这个服务上有一个比较耗时的 API（下称 API A），平均耗时在 ...">
    
    <link rel="preload" href="/assets/css/0.styles.832ac33f.css" as="style"><link rel="preload" href="/assets/js/app.99c64d5c.js" as="script"><link rel="preload" href="/assets/js/215.0f3bb6d0.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.832ac33f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="v-application v-application--is-ltr theme--light"><div class="v-application--wrap"><!----> <main id="main-content" class="v-main" style="padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-main__wrap"><div><container class="article-column-container"><div class="article-column"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div class="v-card v-sheet theme--light"><div class="container"><div itemprop="articleBody" class="markdown-body content__default"><p>最近在项目里遇到个 Flask 内存泄漏的问题，前前后后 debug 了几天。</p> <p>起因是有人报错，发现某个 Flask 服务出现了请求超过 3 分钟还没有返回结果。查服务日志有很多的 <code>WORKER TIMEOUT</code>，是 gunicorn 的进程超时后 kill 的机制。但是日志只能看到超时的进程 id，看不到是哪个请求超时了。正好这个服务上有一个比较耗时的 API（下称 API A），平均耗时在 1-2 分钟，因此我们<strong>初步怀疑是 API A 最近变慢了</strong>，超过了 3 分钟触发了超时。至于为什么其它服务超时，一种合理的解释是前端的重试机制使得多次请求了 API A，导致 gunicorn 的 8 个进程都在处理这个 API，没有多的进程处理其它 API，别的 API 也就一起跟着超时了。</p> <p>我们这样怀疑，但是并没有证据就是 API A 导致的超时。因此简单写了一个中间件来在每个请求开始和结束的时候输出一条日志，记录每个 API 是由哪个进程处理。同时为了缓解超时的问题，把 WORKER 数量翻倍到 16，避免 API A 把服务的所有进程一下子打满。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">class</span> <span class="token class-name">LoggingMiddleware</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>app <span class="token operator">=</span> app

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        process_id <span class="token operator">=</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span>
        http_method <span class="token operator">=</span> environ<span class="token punctuation">[</span><span class="token string">'REQUEST_METHOD'</span><span class="token punctuation">]</span>
        http_path <span class="token operator">=</span> environ<span class="token punctuation">[</span><span class="token string">'PATH_INFO'</span><span class="token punctuation">]</span>
        start <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'[LoggingMiddleware] [</span><span class="token interpolation"><span class="token punctuation">{</span>process_id<span class="token punctuation">}</span></span><span class="token string">] starts </span><span class="token interpolation"><span class="token punctuation">{</span>http_method<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>http_path<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>app<span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span>
        end <span class="token operator">=</span> time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'[LoggingMiddleware] [</span><span class="token interpolation"><span class="token punctuation">{</span>process_id<span class="token punctuation">}</span></span><span class="token string">] finishes </span><span class="token interpolation"><span class="token punctuation">{</span>http_method<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>http_path<span class="token punctuation">}</span></span><span class="token string"> in </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">round</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">s'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response


app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>APP_NAME<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>wsgi_app <span class="token operator">=</span> LoggingMiddleware<span class="token punctuation">(</span>app<span class="token punctuation">.</span>wsgi_app<span class="token punctuation">)</span>
</code></pre></div><hr> <p>如此设置并上线后，一两天以后又出现了超时。这也合理，毕竟我们只是加了日志，改了一下配置，并没有从根本解决问题。不过至少我们有日志了。</p> <p>分析日志以后发现，<strong>不少 API 都出现了超时，并且是随机出现的</strong>。比如另一个查询数据库的 API 某次耗时 150s，而我们再调用相同的 API 时，都只耗时 0.1s 左右。上面的推测解释不了这个现象。</p> <p>我们考虑从新的方向来追查。之前有同事搭建了 Grafana 服务，并导入了 k8s 集群的数据，可以方便地查看每个 pod 的 CPU、内存占用等数据。我们发现此时<strong>这个服务的 pod 的 CPU 和内存都满了，占用 90% 以上</strong>。重启服务后 CPU 和内存占用均正常。因此新的推测是应用出现了<strong>内存泄漏</strong>，长时间运行后内存占用就满了，进而触发频繁的交换和 gc，导致 CPU 也跟着满了。也有一种可能是，<strong>服务确实需要 4 GB 以上的内存来作缓存和其它用途</strong>，只给 4GB 就会 OOM。</p> <p>因此，我们将 pod 的内存翻倍到 8GB，同时将 WORKER 数量调回到 8（更多的 WORKER 会占用更高的内存），尝试缓解这个问题。除此以外没有做更多操作，观察服务是否能够把 8GB 吃满，如果吃满了，内存泄漏的嫌疑就很大了；反之如果内存稳定在一个数，可能是服务的确需要这么多内存。</p> <hr> <p>再次上线后，过了几天，8GB 也被占满了。这下<strong>内存泄漏石锤了</strong>。</p> <p>确认是内存泄漏以后，就需要定位内存泄漏的地方了。对于一般的 Python 脚本，可以使用 <a href="https://pypi.org/project/memory-profiler/" target="_blank" rel="noopener noreferrer">memory_profiler<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来查询运行一次的内存占用，或者内存占用随时间的变化。但是这个工具对于一个 Flask 服务不太好用，一是 Flask 服务需要长期运行，二是这个服务上有很多 API，需要确定到具体哪个 API 有内存泄漏。</p> <p>于是又手搓了一个中间件，用于输出 API 开始和结束时的内存占用差，看有没有什么 API 是在持续增加内存使用的。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> logging
<span class="token keyword">import</span> os

<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">import</span> humanfriendly
<span class="token keyword">import</span> psutil


<span class="token keyword">class</span> <span class="token class-name">MemoryMonitorMiddleware</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>app <span class="token operator">=</span> app

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        http_method <span class="token operator">=</span> environ<span class="token punctuation">[</span><span class="token string">'REQUEST_METHOD'</span><span class="token punctuation">]</span>
        http_path <span class="token operator">=</span> environ<span class="token punctuation">[</span><span class="token string">'PATH_INFO'</span><span class="token punctuation">]</span>
        process_id <span class="token operator">=</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span>
        process <span class="token operator">=</span> psutil<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        mem_before <span class="token operator">=</span> process<span class="token punctuation">.</span>memory_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rss
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>app<span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span>
        mem_after <span class="token operator">=</span> process<span class="token punctuation">.</span>memory_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rss
        mem_diff <span class="token operator">=</span> mem_after <span class="token operator">-</span> mem_before
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'[MemoryMonitorMiddleware] pid:</span><span class="token interpolation"><span class="token punctuation">{</span>process_id<span class="token punctuation">}</span></span><span class="token string">, '</span></span>
                     <span class="token string-interpolation"><span class="token string">f'method:</span><span class="token interpolation"><span class="token punctuation">{</span>http_method<span class="token punctuation">}</span></span><span class="token string">, url:</span><span class="token interpolation"><span class="token punctuation">{</span>http_path<span class="token punctuation">}</span></span><span class="token string">, '</span></span>
                     <span class="token string-interpolation"><span class="token string">f'mem_before: </span><span class="token interpolation"><span class="token punctuation">{</span>humanfriendly<span class="token punctuation">.</span>format_size<span class="token punctuation">(</span>mem_before<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{</span>mem_before<span class="token punctuation">}</span></span><span class="token string">), '</span></span>
                     <span class="token string-interpolation"><span class="token string">f'mem_after: </span><span class="token interpolation"><span class="token punctuation">{</span>humanfriendly<span class="token punctuation">.</span>format_size<span class="token punctuation">(</span>mem_after<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{</span>mem_after<span class="token punctuation">}</span></span><span class="token string">), '</span></span>
                     <span class="token string-interpolation"><span class="token string">f'mem_diff: </span><span class="token interpolation"><span class="token punctuation">{</span>humanfriendly<span class="token punctuation">.</span>format_size<span class="token punctuation">(</span>mem_diff<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{</span>mem_diff<span class="token punctuation">}</span></span><span class="token string">)'</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response


app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>APP_NAME<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>wsgi_app <span class="token operator">=</span> MemoryMonitorMiddleware<span class="token punctuation">(</span>app<span class="token punctuation">.</span>wsgi_app<span class="token punctuation">)</span>
</code></pre></div><p>部署了一段时间以后看看日志，并按进程 ID 筛选（<code>grep &quot;pid:116&quot;</code>）。果然<strong>有一个 API，每次调用时都会占用更多内存，且后续没有因为 gc 等原因释放过这部分内存</strong>。</p> <div class="language-log extra-class"><pre class="language-log"><code><span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>MemoryMonitorMiddleware<span class="token punctuation">]</span> pid<span class="token operator">:</span><span class="token number">116</span><span class="token punctuation">,</span> method<span class="token operator">:</span>GET<span class="token punctuation">,</span> url<span class="token operator">:</span><span class="token file-path string">/api/v1/a</span><span class="token punctuation">,</span> mem_before<span class="token operator">:</span> <span class="token number">345.42</span> MB <span class="token operator">(</span><span class="token number">345419776</span><span class="token operator">)</span><span class="token punctuation">,</span> mem_after<span class="token operator">:</span> <span class="token number">345.16</span> MB <span class="token operator">(</span><span class="token number">345157632</span><span class="token operator">)</span><span class="token punctuation">,</span> mem_diff<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">262144</span> bytes <span class="token operator">(</span><span class="token operator">-</span><span class="token number">262144</span><span class="token operator">)</span>
<span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>MemoryMonitorMiddleware<span class="token punctuation">]</span> pid<span class="token operator">:</span><span class="token number">116</span><span class="token punctuation">,</span> method<span class="token operator">:</span>HEAD<span class="token punctuation">,</span> url<span class="token operator">:</span><span class="token file-path string">/api/v1/b</span><span class="token punctuation">,</span> mem_before<span class="token operator">:</span> <span class="token number">345.16</span> MB <span class="token operator">(</span><span class="token number">345157632</span><span class="token operator">)</span><span class="token punctuation">,</span> mem_after<span class="token operator">:</span> <span class="token number">407.2</span> MB <span class="token operator">(</span><span class="token number">407195648</span><span class="token operator">)</span><span class="token punctuation">,</span> mem_diff<span class="token operator">:</span> <span class="token number">62.04</span> MB <span class="token operator">(</span><span class="token number">62038016</span><span class="token operator">)</span>
<span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>MemoryMonitorMiddleware<span class="token punctuation">]</span> pid<span class="token operator">:</span><span class="token number">116</span><span class="token punctuation">,</span> method<span class="token operator">:</span>HEAD<span class="token punctuation">,</span> url<span class="token operator">:</span><span class="token file-path string">/api/v1/b</span><span class="token punctuation">,</span> mem_before<span class="token operator">:</span> <span class="token number">407.2</span> MB <span class="token operator">(</span><span class="token number">407195648</span><span class="token operator">)</span><span class="token punctuation">,</span> mem_after<span class="token operator">:</span> <span class="token number">443.36</span> MB <span class="token operator">(</span><span class="token number">443359232</span><span class="token operator">)</span><span class="token punctuation">,</span> mem_diff<span class="token operator">:</span> <span class="token number">36.16</span> MB <span class="token operator">(</span><span class="token number">36163584</span><span class="token operator">)</span>
<span class="token punctuation">[</span><span class="token level info keyword">INFO</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>MemoryMonitorMiddleware<span class="token punctuation">]</span> pid<span class="token operator">:</span><span class="token number">116</span><span class="token punctuation">,</span> method<span class="token operator">:</span>GET<span class="token punctuation">,</span> url<span class="token operator">:</span><span class="token file-path string">/api/v2/c</span><span class="token punctuation">,</span> mem_before<span class="token operator">:</span> <span class="token number">443.36</span> MB <span class="token operator">(</span><span class="token number">443359232</span><span class="token operator">)</span><span class="token punctuation">,</span> mem_after<span class="token operator">:</span> <span class="token number">443.36</span> MB <span class="token operator">(</span><span class="token number">443359232</span><span class="token operator">)</span><span class="token punctuation">,</span> mem_diff<span class="token operator">:</span> <span class="token number">0</span> bytes <span class="token operator">(</span><span class="token number">0</span><span class="token operator">)</span>
</code></pre></div><p>于是问题再次缩小到这一个 API 里。</p> <hr> <p>这个 API 里做了两个事情：一是从对象存储中拿到一个文件并反序列化，二是用反序列化的数据绘制图表。由于第一个步骤使用的 <code>boto3</code> 框架比较成熟，我们也在很多地方用到了这个框架，没有出现内存泄漏，因此推测是<strong>绘制图表的时候出现了内存泄漏</strong>。</p> <p>为了证明这个推测，写了一个脚本，从本地读取文件并序列化，然后用相同的逻辑绘制图表。执行多次，监测每次的内存占用。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">def</span> <span class="token function">load_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>

<span class="token keyword">def</span> <span class="token function">draw</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ...</span>

<span class="token keyword">def</span> <span class="token function">get_memory_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    process <span class="token operator">=</span> psutil<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> process<span class="token punctuation">.</span>memory_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rss <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">**</span> <span class="token number">2</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> load_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
    app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
    <span class="token keyword">with</span> app<span class="token punctuation">.</span>app_context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            draw<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            <span class="token comment"># gc.collect()</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'turn </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">, current memory usage: </span><span class="token interpolation"><span class="token punctuation">{</span>get_memory_usage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> MB'</span></span><span class="token punctuation">)</span>
</code></pre></div><p>在没有主动 gc 的版本中，每次请求后增加 3-30 MB 内存，正好能和前面 API 调用前后增加的 30MB 内存对应上。</p> <div class="language-log extra-class"><pre class="language-log"><code>turn <span class="token number">1</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">352.30078125</span> MB
turn <span class="token number">2</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">394.75</span> MB
turn <span class="token number">3</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">427.73046875</span> MB
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
turn <span class="token number">19</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">601.33984375</span> MB
turn <span class="token number">20</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">621.6484375</span> MB

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>site<span class="token operator">-</span>packages<span class="token operator">/</span>seaborn<span class="token operator">/</span>axisgrid<span class="token punctuation">.</span>py<span class="token operator">:</span><span class="token number">453</span><span class="token operator">:</span> RuntimeWarning<span class="token operator">:</span>
More than <span class="token number">20</span> figures have been opened<span class="token punctuation">.</span> Figures created through the pyplot interface <span class="token operator">(</span>`matplotlib<span class="token punctuation">.</span>pyplot<span class="token punctuation">.</span>figure`<span class="token operator">)</span> are retained until explicitly closed and may consume too much memory<span class="token punctuation">.</span> <span class="token operator">(</span>To control this warning<span class="token punctuation">,</span> see the rcParam `figure<span class="token punctuation">.</span>max_open_warning`<span class="token operator">)</span><span class="token punctuation">.</span> Consider using `matplotlib<span class="token punctuation">.</span>pyplot<span class="token punctuation">.</span>close<span class="token operator">(</span><span class="token operator">)</span>`<span class="token punctuation">.</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
turn <span class="token number">35</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">762.19140625</span> MB
turn <span class="token number">36</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">765.18359375</span> MB
</code></pre></div><p>在主动 gc 的版本中，每次请求后增加 3-6 MB 内存占用。</p> <div class="language-log extra-class"><pre class="language-log"><code>turn <span class="token number">1</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">325.06640625</span> MB
turn <span class="token number">2</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">329.59765625</span> MB
turn <span class="token number">3</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">334.8203125</span> MB
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
turn <span class="token number">19</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">420.140625</span> MB
turn <span class="token number">20</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">424.09765625</span> MB

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>site<span class="token operator">-</span>packages<span class="token operator">/</span>seaborn<span class="token operator">/</span>axisgrid<span class="token punctuation">.</span>py<span class="token operator">:</span><span class="token number">453</span><span class="token operator">:</span> RuntimeWarning<span class="token operator">:</span>
More than <span class="token number">20</span> figures have been opened<span class="token punctuation">.</span> Figures created through the pyplot interface <span class="token operator">(</span>`matplotlib<span class="token punctuation">.</span>pyplot<span class="token punctuation">.</span>figure`<span class="token operator">)</span> are retained until explicitly closed and may consume too much memory<span class="token punctuation">.</span> <span class="token operator">(</span>To control this warning<span class="token punctuation">,</span> see the rcParam `figure<span class="token punctuation">.</span>max_open_warning`<span class="token operator">)</span><span class="token punctuation">.</span> Consider using `matplotlib<span class="token punctuation">.</span>pyplot<span class="token punctuation">.</span>close<span class="token operator">(</span><span class="token operator">)</span>`<span class="token punctuation">.</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
turn <span class="token number">226</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">1507.76171875</span> MB
turn <span class="token number">227</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">1512.53125</span> MB
turn <span class="token number">228</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">1518.86328125</span> MB
</code></pre></div><p>可以说明，<strong>每绘制一张图，gc 前会增加 30 MB，gc 后会增加 3-6 MB 内存占用</strong>。</p> <p>seaborn 也有 warning，提示在画完图后没有 close 掉，需要 <code>matplotlib.pyplot.close()</code>。这很可能就是内存泄漏的原因。</p> <hr> <p>修改脚本代码后再进行测试，观察内存是否持续上涨：</p> <div class="language-log extra-class"><pre class="language-log"><code>turn <span class="token number">1</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">324.60546875</span> MB
turn <span class="token number">2</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">325.01953125</span> MB
turn <span class="token number">3</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">329.30078125</span> MB
turn <span class="token number">4</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">331.84765625</span> MB
turn <span class="token number">5</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">332.09765625</span> MB
turn <span class="token number">6</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">332.34765625</span> MB
turn <span class="token number">7</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">333.359375</span> MB
turn <span class="token number">8</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">333.609375</span> MB
turn <span class="token number">9</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">333.859375</span> MB
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
turn <span class="token number">49</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">339.859375</span> MB
turn <span class="token number">50</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">339.859375</span> MB
turn <span class="token number">51</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">340.5859375</span> MB
turn <span class="token number">52</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">339.859375</span> MB
turn <span class="token number">53</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">339.859375</span> MB
turn <span class="token number">54</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">339.859375</span> MB
turn <span class="token number">55</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">339.859375</span> MB
turn <span class="token number">56</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">340.109375</span> MB
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
turn <span class="token number">658</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">341.33984375</span> MB
turn <span class="token number">659</span><span class="token punctuation">,</span> current memory usage<span class="token operator">:</span> <span class="token number">340.60546875</span> MB
</code></pre></div><p>测试结果表明，在 56 轮后内存占用趋于稳定。将代码部署上线后，内存占用也趋于稳定，说明暂时没有其它内存泄漏问题。</p> <p>如果仍存在内存泄漏问题，在将问题代码定位并抽出 Flask 框架以后，就可以借助 memory profile 工具进行分析了。</p> <hr> <p>最后简单复盘一下：</p> <ol><li>这次能快速定位到问题，很大一个原因是我们能在生产环境下进行调整配置和试错；但也许下次就不行了。完善的日志和 pod 监控对快速定位问题都很有必要，对于关键服务、可用性要求高的服务，一定要提前做好监控，还可以评估成本和收益以后考虑是否要做容灾。</li> <li>这次 debug 过程也很意思，表象是服务请求超时，根本原因却是内存泄漏。如果服务出现请求超时，可以考虑看一眼服务的 CPU 和内存，判断是服务的问题，还是 API 本身的问题。</li></ol></div> <hr role="separator" aria-orientation="horizontal" class="ma-4 v-divider theme--light"> <div data-v-54a1e472><script src="https://giscus.app/client.js" async="async" service="giscus" data-repo="lyh543/blog-comments" data-repo-id="R_kgDOHIb2Zg" data-category="Announcements" data-category-id="DIC_kwDOHIb2Zs4COh2z" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" data-v-54a1e472></script></div></div></div></article></div> <!----></container> <div class="v-dialog__container"><button type="button" role="button" aria-haspopup="true" aria-expanded="false" class="v-btn v-btn--bottom v-btn--is-elevated v-btn--fab v-btn--fixed v-btn--has-bg v-btn--right v-btn--round theme--dark v-size--default primary"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-information-variant theme--dark"></i></span></button><!----></div></div></div></main> <footer id="footer" class="v-footer v-sheet theme--light v-footer--absolute v-footer--padless v-footer--inset" style="left:0px;right:0px;bottom:0px;"><div class="lighten-1 text-center v-card v-sheet theme--light rounded-0" style="width:100%;"><div class="v-card__text"><a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" style="font-size:24px;"></i></span></a><a href="https://blog.lyh543.cn/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-web theme--light" style="font-size:24px;"></i></span></a><a href="mailto:lyh543@outlook.com" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-email theme--light" style="font-size:24px;"></i></span></a><a href="https://weibo.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-sina-weibo theme--light" style="font-size:24px;"></i></span></a><a href="https://weixin.qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-wechat theme--light" style="font-size:24px;"></i></span></a><a href="https://qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-qqchat theme--light" style="font-size:24px;"></i></span></a><a href="https://bilibili.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><div class="v-image v-responsive theme--light" style="max-width:24px;"><div class="v-image__image v-image__image--preload v-image__image--cover" style="background-image:;background-position:center center;"></div><div class="v-responsive__content"></div></div></span></a></div> <hr role="separator" aria-orientation="horizontal" class="v-divider theme--light"> <div class="v-card__text"><span class="footer-text">lyh543 © 2019 - 2024</span>
        |
      <a href="https://beian.miit.gov.cn/" target="_blank" class="footer-link">蜀ICP备19034464号</a>
        |
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" class="footer-link">署名 - 非商业性 - 相同方式共享 4.0 国际协议</a>
        |
       <span class="footer-text">
        Theme
        <a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="footer-link">
          vuepress-theme-blog-material
        </a></span></div></div></footer></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.99c64d5c.js" defer></script><script src="/assets/js/215.0f3bb6d0.js" defer></script>
  </body>
</html>
