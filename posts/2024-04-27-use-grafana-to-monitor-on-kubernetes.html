<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Grafana 监控 Kubernetes | 小灰灰灰灰的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/theme/favicon.png">
    <link rel="alternate" type="application/rss+xml" href="https://blog.lyh543.cn/rss.xml" title="小灰灰灰灰的博客 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.lyh543.cn/feed.atom" title="小灰灰灰灰的博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.lyh543.cn/feed.json" title="小灰灰灰灰的博客 JSON Feed">
    <meta name="description" content="

Grafana 收集 K8s 指标的拓扑图

上图是 Grafana 收集 Kubernetes 指标的拓扑图。

cAdvisor 和 [kube-state-metrics](https://github.com/kuber ...">
    
    <link rel="preload" href="/assets/css/0.styles.832ac33f.css" as="style"><link rel="preload" href="/assets/js/app.574161b3.js" as="script"><link rel="preload" href="/assets/js/220.2507ce62.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.832ac33f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="v-application v-application--is-ltr theme--light"><div class="v-application--wrap"><!----> <main id="main-content" class="v-main" style="padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-main__wrap"><div><container class="article-column-container"><div class="article-column"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div class="v-card v-sheet theme--light"><div class="container"><div itemprop="articleBody" class="markdown-body content__default"><h2 id="kubernetes-指标收集拓扑"><a href="#kubernetes-指标收集拓扑" class="header-anchor">#</a> Kubernetes 指标收集拓扑</h2> <p><img src="/images/grafana-collect-k8s-metric.png" alt="Grafana 收集 K8s 指标的拓扑图"></p> <p>上图是 Grafana 收集 Kubernetes 指标的拓扑图。</p> <ol><li><a href="https://github.com/google/cadvisor" target="_blank" rel="noopener noreferrer">cAdvisor<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="https://github.com/kubernetes/kube-state-metrics" target="_blank" rel="noopener noreferrer">kube-state-metrics<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 会作为 Kubernetes Daemonset 运行在 Kubernetes 的每个 Node 上，通过 Kubernetes API 收集 Node、Pod 等的实时指标，然后转换成 Prometheus 能理解的数据结构，通过 HTTP API 暴露出来。cAdvisor 和 kube-state-metrics 收集的数据有一些互补，所以推荐两个都部署。</li> <li>Prometheus 会定时拉取 cAdvisor 和 kube-state-metrics 的数据，然后存储到自己的时间序列数据库中。</li> <li>Grafana 不会持久化 metric 数据，而是持久化图表的配置，然后通过 PromQL 从 Prometheus 查询数据、展示出来。Grafana 也支持通过 SQL 和其它查询语法从 MySQL、PostgreSQL 等数据源查询数据。</li></ol> <h2 id="prometheus-graph"><a href="#prometheus-graph" class="header-anchor">#</a> Prometheus Graph</h2> <p>Prometheus Graph 是一个 Prometheus Query Playground，在浏览器访问 Prometheus 部署的地址的 <code>/graph</code> 路径就可以看到。</p> <p>Prometheus 的每条记录格式为：</p> <p><code>metric_name{metric_label1=value1, metric_label1=value2, ...} = metric_value</code></p> <p>Prometheus 会定时轮询数据源，因此还有一个隐藏的维度：时间戳。可以通过 <code>timestamp(metric &gt; 1)</code> 拿到满足 <code>metric &gt; 1</code> 时的时间序列。</p> <p>PromQL 的基本查询语法是：</p> <table><thead><tr><th></th> <th>PromQL</th> <th>SQL</th></tr></thead> <tbody><tr><td>使用 label 筛选</td> <td><code>metric_name{metric_label1=value1, metric_label2=value2}</code></td> <td><code>SELECT * FROM metric_name</code><br><code>WHERE metric_label1=value1</code><br><code>AND metric_label2=value2</code></td></tr> <tr><td>使用 value 筛选</td> <td><code>metric_name{metric_label1=value1} &gt; 1</code></td> <td><code>SELECT * FROM metric_name</code><br><code>WHERE metric_label1=value1</code><br><code>AND value &gt; 1</code></td></tr> <tr><td>聚合</td> <td><code>sum by(metric_label2) (metric_name{metric_label1=value1})</code></td> <td><code>SELECT metric_label2, sum(value)</code><br><code>FROM metric_name</code><br><code>WHERE metric_label1=value1</code><br><code>GROUP BY metric_label2</code></td></tr></tbody></table> <p>此外，可以查询 <code>container_cpu_load_average_10s</code> 来看到这个 metric_name 有哪些 metric_labels。也可以通过 <code>group ({kubernetes_io_hostname=&quot;10.240.2.255&quot;}) by (__name__)</code> 来获取哪些 metric_names 有这个 metric_label。</p> <h2 id="grafana-筛选器配置"><a href="#grafana-筛选器配置" class="header-anchor">#</a> Grafana 筛选器配置</h2> <h3 id="级联查询"><a href="#级联查询" class="header-anchor">#</a> 级联查询</h3> <p>位置：Dashboard Detail 页 - Settings - Variables。</p> <p>Grafana 的筛选器支持级联查询。</p> <p><img src="/images/grafana-cascade-filter.png" alt="Grafana 级联查询"></p> <p>在级联查询中，为了让父项全选（All）、多选（Multi-value）时，子项的筛选仍然能用，小项及 Dashboard 里的数据筛选需要使用 <code>~=</code>（正则等于）。上图中，<code>node_pool_id</code>、<code>Node</code>、<code>Pod</code> 的 Definition 中均使用了 <code>~=</code>。</p> <h3 id="级联查询的性能优化"><a href="#级联查询的性能优化" class="header-anchor">#</a> 级联查询的性能优化</h3> <p>Grafana 虽然支持级联查询，但级联查询的选项需要在前端拉取数据并计算（而非直接由后端返回）。选项更改时，需要进行多次串行的查询。过大的筛选范围和过多的级联查询会降低性能。下图中，不使用筛选器、5分钟内的数据有 ~160M（压缩后 ~7M），三次级联查询耗时共 ~18s。</p> <p><img src="/images/grafana-cascade-filter-performance-1.png" alt="不使用筛选器、5分钟内的数据有 ~160M（压缩后 ~7M），三次级联查询耗时共 ~18s"></p> <p>给筛选器设置默认选项，可以减少每次查询的数据。下图中，筛选 namespace、5分钟内的数据有 ~23M（压缩后 ~1M），三次级联查询耗时共 ~3s。</p> <p><img src="/images/grafana-cascade-filter-performance-2.png" alt="筛选 namespace、5分钟内的数据有 ~23M（压缩后 ~1M），三次级联查询耗时共 ~3s"></p> <p>减少级联查询可以减少需要串行的查询次数。但是需要注意每个级联查询的父项都需要有默认选项，否则对应的级联查询仍需要拉取全量数据。下图中，筛选了 namespace，但在查询不受 namespace 约束的 node_id 选项时，仍需要拉取全量数据。</p> <p><img src="/images/grafana-cascade-filter-performance-3.png" alt="筛选 namespace，在查询不受 namespace 约束的 node_id 选项时仍需要拉取全量数据"></p> <h2 id="grafana-panel-配置"><a href="#grafana-panel-配置" class="header-anchor">#</a> Grafana Panel 配置</h2> <p>在 Grafana 筛选器配置了级联筛选时，Grafana 计算子项的选项时会用父项的筛选进行过滤，所以 UI 上的 <code>All</code> 选项，实际查询时会转换为 <code>(option_1|option_2|option_3)</code>。在 Panel 里配置筛选条件时，只需要用正则表达式配置子项的筛选即可，不需要再配置父项的筛选。</p> <div class="language- extra-class"><pre class="language-text"><code>metric_xxx{namespace=~&quot;$NameSpace&quot;}
metric_xxx{cluster_vke_volcengine_com_machinepool_name=~&quot;$node_pool_id&quot;}
metric_xxx{kubernetes_io_hostname=~&quot;^$Node$&quot;}
metric_xxx{pod=~&quot;$Pod&quot;}

# no need to add parent filter
metric_xxx{namespace=~&quot;$NameSpace&quot;
           cluster_vke_volcengine_com_machinepool_name=~&quot;$node_pool_id&quot;,
           kubernetes_io_hostname=~&quot;^$Node$&quot;,
           pod=~&quot;$Pod&quot;}
</code></pre></div><h2 id="prometheus-kubernetes-常见指标"><a href="#prometheus-kubernetes-常见指标" class="header-anchor">#</a> Prometheus Kubernetes 常见指标</h2> <p>cAdvisor 的指标以 <code>container_</code> 和 <code>machine_</code> 开头，kube-state-metric 的指标以 <code>kube_pod_</code> 开头。</p> <h3 id="node-资源使用率"><a href="#node-资源使用率" class="header-anchor">#</a> Node 资源使用率</h3> <ul><li><p>CPU Request: <code>sum(container_spec_cpu_shares{image=&quot;&quot;,pod!=&quot;&quot;,kubernetes_io_hostname=~&quot;^$Node$&quot;})/1024</code></p></li> <li><p><s>CPU Limit（监控意义不大）</s></p></li> <li><p>CPU Usage: <code>sum (rate(container_cpu_usage_seconds_total{id=&quot;/&quot;,kubernetes_io_hostname=~&quot;^$Node$&quot;}[1m]))</code></p></li> <li><p>CPU Total: <code>machine_cpu_cores{kubernetes_io_hostname=~&quot;^$Node$&quot;}</code></p></li> <li><p>Memory Request: <code>sum(kube_pod_container_resource_requests{resource=&quot;memory&quot;, node=&quot;^$Node$&quot;} * on (container, pod) (kube_pod_container_status_running == 1)) /1024/1024/1024</code></p></li> <li><p><s>Memory Limit（监控意义不大）</s>: <code>sum(container_spec_memory_limit_bytes{kubernetes_io_hostname=&quot;^$Node$&quot;}/1024/1024/1024)</code></p></li> <li><p>Memory Usage: <code>sum(container_memory_working_set_bytes{id=&quot;/&quot;,kubernetes_io_hostname=~&quot;^$Node$&quot;})</code></p></li> <li><p>Memory Total: <code>machine_memory_bytes{kubernetes_io_hostname=~&quot;^$Node$&quot;}</code></p></li> <li><p>Storage Usage: <code>sum (container_fs_usage_bytes{device=~&quot;^/dev/[sv]d[a-z][1-9]$&quot;,id=&quot;/&quot;,kubernetes_io_hostname=~&quot;^$Node$&quot;})</code></p></li> <li><p>Storage Total: <code>sum(container_fs_limit_bytes{device=~&quot;^/dev/[sv]d[a-z][1-9]$&quot;,id=&quot;/&quot;,kubernetes_io_hostname=~&quot;^$Node$&quot;})</code></p></li></ul> <h3 id="pod-资源使用率"><a href="#pod-资源使用率" class="header-anchor">#</a> Pod 资源使用率</h3> <ul><li><p>CPU Request：<code>container_spec_cpu_shares{pod=~&quot;$Pod&quot;,image=&quot;&quot;} / 1024</code></p></li> <li><p>CPU Limit：<code>container_spec_cpu_quota{pod~=&quot;$Pod&quot;,image=&quot;&quot;}/100000</code></p></li> <li><p>CPU Usage: <code>rate(container_cpu_usage_seconds_total{pod~=&quot;$Pod&quot;,image=&quot;&quot;}[1m])</code></p></li> <li><p>Memory Request: <code>sum(kube_pod_container_resource_requests{resource=&quot;memory&quot;, pod~=&quot;$Pod&quot;} * on (container) (kube_pod_container_status_running{pod~=&quot;$Pod&quot;} == 1)) / 1024/1024/1024</code>（为了过滤不是运行状态的 pod，使用 join 操作 <code>metric_a * on(container) metric_b</code>）</p></li> <li><p>Memory Limit: <code>container_spec_memory_limit_bytes{pod~=&quot;$Pod&quot;,image=&quot;&quot;}/1024/1024/1024</code></p></li> <li><p>Memory Usage: <code>container_memory_working_set_bytes{pod~=&quot;$Pod&quot;,image=&quot;&quot;}</code></p></li></ul> <h3 id="pod-状态监控"><a href="#pod-状态监控" class="header-anchor">#</a> Pod 状态监控</h3> <ul><li>发生过重启的 pod：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">(</span>
    kube_pod_container_status_restarts_total<span class="token punctuation">{</span>namespace<span class="token operator">=</span><span class="token operator">~</span><span class="token string">&quot;$NameSpace&quot;</span><span class="token punctuation">}</span> @ $<span class="token punctuation">{</span>__to<span class="token punctuation">:</span>date<span class="token punctuation">:</span>seconds<span class="token punctuation">}</span>
    <span class="token operator">-</span>
    kube_pod_container_status_restarts_total<span class="token punctuation">{</span>namespace<span class="token operator">=</span><span class="token operator">~</span><span class="token string">&quot;$NameSpace&quot;</span><span class="token punctuation">}</span> @ $<span class="token punctuation">{</span>__from<span class="token punctuation">:</span>date<span class="token punctuation">:</span>seconds<span class="token punctuation">}</span>
<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
</code></pre></div><ul><li>Pod 上次重启的时间（此查询性能较差）：</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>last_over_time<span class="token punctuation">(</span>
    timestamp<span class="token punctuation">(</span>
        increase<span class="token punctuation">(</span>kube_pod_container_status_restarts_total<span class="token punctuation">{</span>namespace<span class="token operator">=</span><span class="token operator">~</span><span class="token string">&quot;$NameSpace&quot;</span><span class="token punctuation">}</span><span class="token punctuation">[</span>10m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
    <span class="token punctuation">)</span><span class="token punctuation">[</span>$__range<span class="token punctuation">:</span>10m<span class="token punctuation">]</span> @ $<span class="token punctuation">{</span>__to<span class="token punctuation">:</span>date<span class="token punctuation">:</span>seconds<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><ul><li>Pending 超过半个小时的 pod：<code>min_over_time(kube_pod_status_phase{phase=&quot;Pending&quot;, namespace=~&quot;$NameSpace&quot;}[30m:1m]) == 1</code></li></ul> <p><code>$__range</code> 等都是 <a href="https://grafana.com/docs/grafana/latest/dashboards/variables/add-template-variables/#global-variables" target="_blank" rel="noopener noreferrer">Grafana 变量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，<code>[a:b] @ c</code> 是 Prometheus 的 <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/#range-vector-selectors" target="_blank" rel="noopener noreferrer">Range Vector Selectors 语法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="grafana-alert"><a href="#grafana-alert" class="header-anchor">#</a> Grafana Alert</h2> <p><strong>Alert 条件</strong>：Grafana 的 Alert Condition 是：指标超过某范围（如 CPU 占用率超过 80%）。其它场景下需要将指标转化为这种格式（如 <code>pod 出现重启</code> -&gt; <code>Pod 的重启次数 &gt;= 1</code>）。</p> <p><strong>Alert 时机</strong>：Grafana 会在 Alert Condition 状态（true &lt;-&gt; false）转换时发出警告，即在 false-&gt;true 时会发 <code>Firing</code> Alert，true-&gt;false 时会发 <code>Resolved</code> Alert。</p> <p><strong>Alert 合并</strong>：批量查询的指标（如对不同的 Pod 监控的同一指标），同一时间时变为 true，Grafana 会整合为一条消息发送；Alert 也支持通过配置，将一段时间内的 Alert 合并。下图的配置 <code>evaluation every 30min for 24h</code> 是：每 30 分钟计算一次是否满足 Alert Condition，每 24h 打包发送一次结果。</p> <p><img src="/images/grafana-alert-merge.png" alt="Alert 合并"></p> <p><strong>Alert 发送方</strong>：Grafana 把 Alert 的条件和发送解耦，不直接在 Alert Rule 里配置发送方，而是在 Alert Rule 里打 label，然后通过 Notification Policy 基于 label 将对应的 Alert Rule 路由给发送方（Contact points）。</p> <p><img src="/images/grafana-alert-notification.png" alt="Alert 通知"></p></div> <hr role="separator" aria-orientation="horizontal" class="ma-4 v-divider theme--light"> <div data-v-54a1e472><script src="https://giscus.app/client.js" async="async" service="giscus" data-repo="lyh543/blog-comments" data-repo-id="R_kgDOHIb2Zg" data-category="Announcements" data-category-id="DIC_kwDOHIb2Zs4COh2z" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" data-v-54a1e472></script></div></div></div></article></div> <!----></container> <div class="v-dialog__container"><button type="button" role="button" aria-haspopup="true" aria-expanded="false" class="v-btn v-btn--bottom v-btn--is-elevated v-btn--fab v-btn--fixed v-btn--has-bg v-btn--right v-btn--round theme--dark v-size--default primary"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-information-variant theme--dark"></i></span></button><!----></div></div></div></main> <footer id="footer" class="v-footer v-sheet theme--light v-footer--absolute v-footer--padless v-footer--inset" style="left:0px;right:0px;bottom:0px;"><div class="lighten-1 text-center v-card v-sheet theme--light rounded-0" style="width:100%;"><div class="v-card__text"><a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" style="font-size:24px;"></i></span></a><a href="https://blog.lyh543.cn/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-web theme--light" style="font-size:24px;"></i></span></a><a href="mailto:lyh543@outlook.com" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-email theme--light" style="font-size:24px;"></i></span></a><a href="https://weibo.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-sina-weibo theme--light" style="font-size:24px;"></i></span></a><a href="https://weixin.qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-wechat theme--light" style="font-size:24px;"></i></span></a><a href="https://qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-qqchat theme--light" style="font-size:24px;"></i></span></a><a href="https://bilibili.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><div class="v-image v-responsive theme--light" style="max-width:24px;"><div class="v-image__image v-image__image--preload v-image__image--cover" style="background-image:;background-position:center center;"></div><div class="v-responsive__content"></div></div></span></a></div> <hr role="separator" aria-orientation="horizontal" class="v-divider theme--light"> <div class="v-card__text"><span class="footer-text">lyh543 © 2019 - 2024</span>
        |
      <a href="https://beian.miit.gov.cn/" target="_blank" class="footer-link">蜀ICP备19034464号</a>
        |
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" class="footer-link">署名 - 非商业性 - 相同方式共享 4.0 国际协议</a>
        |
       <span class="footer-text">
        Theme
        <a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="footer-link">
          vuepress-theme-blog-material
        </a></span></div></div></footer></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.574161b3.js" defer></script><script src="/assets/js/220.2507ce62.js" defer></script>
  </body>
</html>
