<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>优化 AOSP 流畅度一记 | 小灰灰灰灰的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/theme/favicon.png">
    <link rel="alternate" type="application/rss+xml" href="https://blog.lyh543.cn/rss.xml" title="小灰灰灰灰的博客 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.lyh543.cn/feed.atom" title="小灰灰灰灰的博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.lyh543.cn/feed.json" title="小灰灰灰灰的博客 JSON Feed">
    <meta name="description" content="本文基于笔者使用安卓设备的经验而来，如有理论错误请指正。

为什么要优化

大学的时候，刷完 AOSP 会装一堆 Magisk 模块、XPosed 插件。现在养老了，懒得折腾了，只要不影响到我的体验。不过最近的体验确实不太好，表现在 12 GB 内存都不够用、杀后台、卡顿；另外手机发热、耗电很严重，几乎一天 24 小时都在发热，晚上不接电源睡一觉也能掉 80% 的电，平时的续航也只有三到 ...">
    
    <link rel="preload" href="/assets/css/0.styles.94ecd5c7.css" as="style"><link rel="preload" href="/assets/js/app.1606e5e2.js" as="script"><link rel="preload" href="/assets/js/216.0c01fab5.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.94ecd5c7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="v-application v-application--is-ltr theme--light"><div class="v-application--wrap"><!----> <main id="main-content" class="v-main" style="padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-main__wrap"><div><div class="container"><div class="row justify-center"><div class="col-sm-9 col-12"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div class="v-card v-sheet theme--light"><div class="container"><div itemprop="articleBody" class="markdown-body content__default"><blockquote><p>本文基于笔者使用安卓设备的经验而来，如有理论错误请指正。</p></blockquote> <h2 id="为什么要优化"><a href="#为什么要优化" class="header-anchor">#</a> 为什么要优化</h2> <p>大学的时候，刷完 AOSP 会装一堆 Magisk 模块、XPosed 插件。现在养老了，懒得折腾了，只要不影响到我的体验。不过最近的体验确实不太好，表现在 12 GB 内存都不够用、杀后台、卡顿；另外手机发热、耗电很严重，几乎一天 24 小时都在发热，晚上不接电源睡一觉也能掉 80% 的电，平时的续航也只有三到六个小时。由于现在用的系统是 Unofficial 的，维护者似乎也没有更新，就别想等 OTA 修复了。</p> <p>虽然有句话是换手机解决 100% 问题，但是现在的这些毛病属于是优化不好也能凑合着用（罗永浩举牌：又不是不能用.jpg），不值得专门买一个新手机。也尝试过逐渐迁移到 iOS，但是侧滑返回不是系统级、也没有震动反馈这点，让我连夜回到了 AOSP。还是尝试优化一下吧。</p> <p>下面大部分的性能（CPU、内存）监控和调校都是基于 <a href="http://vtools.omarea.com/#/" target="_blank" rel="noopener noreferrer">Scene<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 6 的，这款软件确实是可以说是安卓上的神器了。不想使用 Scene 的话，<code>top</code> 等工具也能用，不过没有那么直观就是了。</p> <h2 id="优化内存使用"><a href="#优化内存使用" class="header-anchor">#</a> 优化内存使用</h2> <p>Android 上现在有两种扩大内存的方法：一种是 <a href="https://zh.wikipedia.org/wiki/Zram" target="_blank" rel="noopener noreferrer">zRAM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、另一种是 Swap（国内厂商说的扩展内存、Windows 上的虚拟内存）。ZRAM 是将内存中的数据压缩后存储，这样可以减少内存的使用，提高内存的利用率。Swap 是将内存中的数据存储到磁盘上，这样可以扩大内存的容量，但是速度会慢很多。</p> <p>由于两种方法的原理不同，它们的性能和效果有一些差异。zRAM 是把一部分内存压缩后再放到内存，它的速度是 CPU 进行压缩和解压的速度，节省的内存大小和压缩比有关。我的手机上的 zRAM 默认使用 lz4，压缩比在 33% 左右，如果我设置 zRAM 大小为 6 GB，这 6GB 内容压缩后约为 2GB，所以我可以多出 4GB 的内存。Swap 的速度是磁盘的读写速度，它多出来的空间和分配的磁盘大小有关（理论上可以无限大，但是硬盘读写一般比内存慢一到两个数量级，所以 Swap 太大能减少杀后台，但是系统会很卡），一般设置为内存的 1/4~1/2（12 GB 的话可以设置为 3-6 GB）。</p> <hr> <p>在安卓上测 lz4 的压缩速度，可以在 <a href="https://termux.dev/en/" target="_blank" rel="noopener noreferrer">termux<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 终端里安装 lz4，然后跑 lz4 自带的 benchmark：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>~ $ pkg i lz4
~ $ lz4 -b1
-Synthetic <span class="token number">50</span>%     <span class="token builtin class-name">:</span>  <span class="token number">10000000</span> -<span class="token operator">&gt;</span>   <span class="token number">5859357</span> <span class="token punctuation">(</span><span class="token number">1.707</span><span class="token punctuation">)</span>, <span class="token number">811.9</span> MB/s ,4280.8 MB/s
~ $ lz4 -b2
-Synthetic <span class="token number">50</span>%     <span class="token builtin class-name">:</span>  <span class="token number">10000000</span> -<span class="token operator">&gt;</span>   <span class="token number">5859357</span> <span class="token punctuation">(</span><span class="token number">1.707</span><span class="token punctuation">)</span>, <span class="token number">886.7</span> MB/s ,4118.5 MB/s
~ $ lz4 -b3
-Synthetic <span class="token number">50</span>%     <span class="token builtin class-name">:</span>  <span class="token number">10000000</span> -<span class="token operator">&gt;</span>   <span class="token number">4560720</span> <span class="token punctuation">(</span><span class="token number">2.193</span><span class="token punctuation">)</span>,  <span class="token number">72.8</span> MB/s ,2539.0 MB/s
</code></pre></div><p>这个速度是骁龙 865 单核的性能，比我想想得要好。ZRAM 使用的 lz4 似乎没有指定压缩级别，我猜测用的是 1 或者 2 吧，3 的性能太烂了。</p> <hr> <p>Swap 测速实际上是测 I/O 性能。可以使用 Cross Platform Disk Test (<a href="https://github.com/maxim-saplin/CrossPlatformDiskTest" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)。</p> <p>测下来我的小米 10 顺序读写 192/26 MB/s。这个速度太低了，和 app 给的小米 10 参考（顺序读写 962/444 MB/s）差了一个量级多。不知道是因为手机用太久退化了，还是我现在用的类原生（还是 Unofficial 的）优化太差的问题。总之我这部手机用 zRAM 比 Swap 好多了。</p> <hr> <p>经过上面简单的性能测试，确认了使用 zRAM 的方法。zRAM 大小推荐设置为物理内存的 30%-50%，我设置为了 12GB 的 50%，也就是 6GB。Swap 设置为 0。</p> <p>使用了两周（4.7）以后，没有再出现过杀后台，很流畅，体验还不错，内存最高占用 75%/12GB，此时 zRAM 占用 81%/6GB。看来米 10 还能钉两年。</p> <h2 id="省电、降频"><a href="#省电、降频" class="header-anchor">#</a> 省电、降频</h2> <h3 id="各种配置和模块-系统省电模式、scene-省电模式、深度-doze-模块"><a href="#各种配置和模块-系统省电模式、scene-省电模式、深度-doze-模块" class="header-anchor">#</a> 各种配置和模块：系统省电模式、Scene 省电模式、深度 Doze 模块</h3> <p>手机发热、耗电，我第一反应是内核温控比较激进，应该尝试降频。</p> <p>第一个方案是系统内置的降频，也就是省电模式。一天 24 小时开着省电模式，手机确实从烫变成温了。第二个方案是 Scene 里的温控，可以选择省电/平衡/性能/极速模式，选择省电模式也许可以降降频率。第三个方案是深度 Doze 模块（作者似乎删库了，现在只有酷安能下载），需要 Magisk，可以在手机需要休眠的时候（比如睡觉的时候）进入深度休眠，晚上确实省电多了。</p> <h3 id="debug-解决-google-play-service-cpu-占用"><a href="#debug-解决-google-play-service-cpu-占用" class="header-anchor">#</a> Debug：解决 Google Play Service CPU 占用</h3> <p>由于 Scene 里有监控各个 app 使用 CPU 的情况（<code>top</code> 命令行应该也可以看，就是没那么直观），这两天观察到我手机上 Google Play Service 一直占用了 1 个核的 100%。</p> <p>Scene 上也能进一步查看各个线程的 CPU 使用率，发现是 <code>.INSTALL_UPDATE</code> 这个线程占用了 100% 的 CPU。基于这个信息谷歌了一下，搜到 <a href="https://xdaforums.com/t/temp-fix-root-reqd-high-cpu-usage-and-battery-drain-due-to-google-play-services.4406617/page-6" target="_blank" rel="noopener noreferrer">XDA 上有人同样的现象<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，用一条命令解决了。有作业抄就是好：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>pm disable com.google.android.gms/.chimera.GmsIntentOperationService
</code></pre></div></div> <hr role="separator" aria-orientation="horizontal" class="ma-4 v-divider theme--light"> <div data-v-5794ffe6><script src="https://giscus.app/client.js" async="async" service="giscus" data-repo="lyh543/blog-comments" data-repo-id="R_kgDOHIb2Zg" data-category="Announcements" data-category-id="DIC_kwDOHIb2Zs4COh2z" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" data-v-5794ffe6></script></div></div></div></article></div> <!----></div></div> <div class="v-dialog__container"><button type="button" role="button" aria-haspopup="true" aria-expanded="false" class="v-btn v-btn--bottom v-btn--is-elevated v-btn--fab v-btn--fixed v-btn--has-bg v-btn--right v-btn--round theme--dark v-size--default primary"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-information-variant theme--dark"></i></span></button><!----></div></div></div></main> <footer id="footer" class="v-footer v-sheet theme--light v-footer--absolute v-footer--padless v-footer--inset" style="left:0px;right:0px;bottom:0px;"><div class="lighten-1 text-center v-card v-sheet theme--light rounded-0" style="width:100%;"><div class="v-card__text"><a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" style="font-size:24px;"></i></span></a><a href="https://blog.lyh543.cn/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-web theme--light" style="font-size:24px;"></i></span></a><a href="mailto:lyh543@outlook.com" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-email theme--light" style="font-size:24px;"></i></span></a><a href="https://weibo.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-sina-weibo theme--light" style="font-size:24px;"></i></span></a><a href="https://weixin.qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-wechat theme--light" style="font-size:24px;"></i></span></a><a href="https://qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-qqchat theme--light" style="font-size:24px;"></i></span></a><a href="https://bilibili.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><div class="v-image v-responsive theme--light" style="max-width:24px;"><div class="v-image__image v-image__image--preload v-image__image--cover" style="background-image:;background-position:center center;"></div><div class="v-responsive__content"></div></div></span></a></div> <hr role="separator" aria-orientation="horizontal" class="v-divider theme--light"> <div class="v-card__text"><span class="footer-text">lyh543 © 2019 - 2024</span>
        |
      <a href="https://beian.miit.gov.cn/" target="_blank" class="footer-link">蜀ICP备19034464号</a>
        |
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" class="footer-link">署名 - 非商业性 - 相同方式共享 4.0 国际协议</a>
        |
       <span class="footer-text">
        Theme
        <a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="footer-link">
          vuepress-theme-blog-material
        </a></span></div></div></footer></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1606e5e2.js" defer></script><script src="/assets/js/216.0c01fab5.js" defer></script>
  </body>
</html>
