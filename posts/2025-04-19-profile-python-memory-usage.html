<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Python 内存占用分析 | 小灰灰灰灰的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/theme/favicon.png">
    <link rel="alternate" type="application/rss+xml" href="https://blog.lyh543.cn/rss.xml" title="小灰灰灰灰的博客 RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.lyh543.cn/feed.atom" title="小灰灰灰灰的博客 Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.lyh543.cn/feed.json" title="小灰灰灰灰的博客 JSON Feed">
    <meta name="description" content="最近公司的 Python 后端服务内存占用偏高，所以花了一些时间分析后端的内存占用。也梳理了一些比较好用的工具和分析方法。

在我们的场景下，我们发现内存占用异常是在服务运行了一段时间以后，所以下面的工具链更偏向于分析应用运行时的内存占用长期持续增长趋势。

tracemalloc

提到 Python 内存分析，一定会有 tracemalloc，毕竟是内置的内存追踪工具。

但是实 ...">
    
    <link rel="preload" href="/assets/css/0.styles.832ac33f.css" as="style"><link rel="preload" href="/assets/js/app.adfd3ce4.js" as="script"><link rel="preload" href="/assets/js/230.64cc02e7.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.832ac33f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="v-application v-application--is-ltr theme--light"><div class="v-application--wrap"><!----> <main id="main-content" class="v-main" style="padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-main__wrap"><div><container class="article-column-container"><div class="article-column"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><div class="v-card v-sheet theme--light"><div class="container"><div itemprop="articleBody" class="markdown-body content__default"><p>最近公司的 Python 后端服务内存占用偏高，所以花了一些时间分析后端的内存占用。也梳理了一些比较好用的工具和分析方法。</p> <p>在我们的场景下，我们发现内存占用异常是在服务运行了一段时间以后，所以下面的工具链更偏向于分析<strong>应用运行时的内存占用长期持续增长趋势</strong>。</p> <h2 id="tracemalloc"><a href="#tracemalloc" class="header-anchor">#</a> tracemalloc</h2> <p>提到 Python 内存分析，一定会有 tracemalloc，毕竟是内置的内存追踪工具。</p> <p>但是实际体验下来比较一般，它只能追踪到 pymalloc 分配的 Python 对象，对于 C 扩展（比如 numpy、PIL）这种库申请的内存是无法追踪的。结果就是进程内存已经占用几个 GB 了，但是 tracemalloc 只追踪到了 50 MB 的内存分配。</p> <p>下面是 tracemalloc 的一个 demo。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> tracemalloc

<span class="token comment"># 开始追踪内存分配</span>
tracemalloc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">create_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建一个大的列表</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">create_dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建一个大的字典</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>i<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token comment"># 调用函数，分配内存</span>
large_list <span class="token operator">=</span> create_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
large_dict <span class="token operator">=</span> create_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 获取当前内存快照</span>
snapshot <span class="token operator">=</span> tracemalloc<span class="token punctuation">.</span>take_snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 分析内存分配</span>
top_stats <span class="token operator">=</span> snapshot<span class="token punctuation">.</span>statistics<span class="token punctuation">(</span><span class="token string">'lineno'</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;[Top 10 Memory Usage]&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> stat <span class="token keyword">in</span> top_stats<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span>

<span class="token comment"># 停止追踪内存分配</span>
tracemalloc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>对于 Django 后端项目，可以把这段代码放到中间件里。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings

<span class="token keyword">class</span> <span class="token class-name">MemoryUsageMiddleware</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response <span class="token operator">=</span> get_response

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> settings<span class="token punctuation">.</span>DEBUG<span class="token punctuation">:</span>  <span class="token comment"># 仅在 DEBUG 模式下启用</span>
            tracemalloc<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

        response <span class="token operator">=</span> self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>

        <span class="token keyword">if</span> settings<span class="token punctuation">.</span>DEBUG<span class="token punctuation">:</span>
            snapshot <span class="token operator">=</span> tracemalloc<span class="token punctuation">.</span>take_snapshot<span class="token punctuation">(</span><span class="token punctuation">)</span>
            tracemalloc<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>

            top_stats <span class="token operator">=</span> snapshot<span class="token punctuation">.</span>statistics<span class="token punctuation">(</span><span class="token string">'lineno'</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> stat <span class="token keyword">in</span> top_stats<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span>  <span class="token comment"># 或记录到日志中</span>

        <span class="token keyword">return</span> response
</code></pre></div><p>总的来说，tracemalloc 可以试试，但是效果不一定好，而且会有一定性能影响，不太好放在时延敏感的后端项目的生产环境上跑，tracemalloc 的统计数据也会占用运行内存。</p> <h2 id="psutil"><a href="#psutil" class="header-anchor">#</a> psutil</h2> <p>psutil 获取进程的信息，它拿到的数据和系统的 top 命令是一样的，不会存在 tracemalloc 这种统计偏小的问题。</p> <p>在我们的项目中，对后端和 Celery Worker（一个任务执行服务）分别做了内存分析，两者的使用方法有一点差异。</p> <h3 id="psutil-统计后端内存使用"><a href="#psutil-统计后端内存使用" class="header-anchor">#</a> psutil 统计后端内存使用</h3> <p>也是推荐把代码放到中间件里，在请求开始前后分别获取内存占用，做个减法。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> psutil
<span class="token keyword">import</span> logging

logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">MemoryUsageMiddleware</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>get_response <span class="token operator">=</span> get_response

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取当前进程的内存信息（请求开始前）</span>
        process <span class="token operator">=</span> psutil<span class="token punctuation">.</span>Process<span class="token punctuation">(</span><span class="token punctuation">)</span>
        memory_before <span class="token operator">=</span> process<span class="token punctuation">.</span>memory_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rss  <span class="token comment"># 常驻内存（单位：字节）</span>

        <span class="token comment"># 处理请求</span>
        response <span class="token operator">=</span> self<span class="token punctuation">.</span>get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>

        <span class="token comment"># 获取当前进程的内存信息（请求结束后）</span>
        memory_after <span class="token operator">=</span> process<span class="token punctuation">.</span>memory_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rss  <span class="token comment"># 常驻内存（单位：字节）</span>

        <span class="token comment"># 计算内存使用差值</span>
        memory_diff <span class="token operator">=</span> memory_after <span class="token operator">-</span> memory_before

        <span class="token comment"># 将内存使用信息记录到日志中</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;[Memory Usage] Before: </span><span class="token interpolation"><span class="token punctuation">{</span>memory_before <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> MB, &quot;</span></span>
                    <span class="token string-interpolation"><span class="token string">f&quot;After: </span><span class="token interpolation"><span class="token punctuation">{</span>memory_after <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> MB, &quot;</span></span>
                    <span class="token string-interpolation"><span class="token string">f&quot;Diff: </span><span class="token interpolation"><span class="token punctuation">{</span>memory_diff <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> MB&quot;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> response
</code></pre></div><p>正常情况下请求前后的内存值是不会有变化的，如果某个请求以后内存值<strong>总是</strong>有增加，就说明这个请求可能有内存泄漏。</p> <p>需要注意的是：</p> <ol><li>由于后端一个进程会同时处理多个请求，所以出现内存上升也需要注意是否可能是其他请求引起的。</li> <li>内存增加有可能是没有及时 GC 导致的。由于 GC 需要拿到 GIL，不建议在后端中间件里直接 GC，所以出现内存增长也不能断定一定有内存泄漏，需要结合代码逻辑综合判断。</li></ol> <p>实际业务场景下，发现有两个 <code>healthz</code> 请求之间内存上升了 200M（第一个 healthz 请求前后内存 400M，第二个 healthz 请求前后内存 600M，中间没有任何别的请求），后来发现是因为在初始化翻译模型导致的。</p> <h3 id="psutil-统计-celery-worker-内存使用"><a href="#psutil-统计-celery-worker-内存使用" class="header-anchor">#</a> psutil 统计 Celery Worker 内存使用</h3> <p>Celery Worker 中使用 psutil 的方法也一样，在任务执行前后获取内存占用，做个减法。需要基于 celery 提供的 signals 来在任务开始前和结束后插入代码。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> gc
<span class="token keyword">import</span> psutil
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> celery <span class="token keyword">import</span> signals

logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@signals<span class="token punctuation">.</span>task_prerun<span class="token punctuation">.</span>connect</span>
<span class="token keyword">def</span> <span class="token function">record_memory_before_task</span><span class="token punctuation">(</span>sender<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>extras<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    在任务开始前记录内存使用，并存储到 sender 的属性中。
    &quot;&quot;&quot;</span>
    process <span class="token operator">=</span> psutil<span class="token punctuation">.</span>Process<span class="token punctuation">(</span><span class="token punctuation">)</span>
    memory_before <span class="token operator">=</span> process<span class="token punctuation">.</span>memory_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rss  <span class="token comment"># 获取当前进程的常驻内存（字节）</span>
    
    <span class="token comment"># 将内存使用记录到 sender 的属性中</span>
    sender<span class="token punctuation">.</span>memory_before <span class="token operator">=</span> memory_before
    
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;[Task </span><span class="token interpolation"><span class="token punctuation">{</span>sender<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">] Memory before: </span><span class="token interpolation"><span class="token punctuation">{</span>memory_before <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> MB&quot;</span></span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@signals<span class="token punctuation">.</span>task_postrun<span class="token punctuation">.</span>connect</span>
<span class="token keyword">def</span> <span class="token function">record_memory_after_task</span><span class="token punctuation">(</span>sender<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task_id<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> task<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> retval<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> state<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>extras<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    在任务结束后记录内存使用，并计算差值。
    &quot;&quot;&quot;</span>
    gc<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 强制进行垃圾回收，清理内存</span>
    process <span class="token operator">=</span> psutil<span class="token punctuation">.</span>Process<span class="token punctuation">(</span><span class="token punctuation">)</span>
    memory_after <span class="token operator">=</span> process<span class="token punctuation">.</span>memory_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rss  <span class="token comment"># 获取当前进程的常驻内存（字节）</span>

    <span class="token comment"># 从 sender 的属性中读取任务开始前的内存使用</span>
    memory_before <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> <span class="token string">'memory_before'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> memory_before <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        memory_diff <span class="token operator">=</span> memory_after <span class="token operator">-</span> memory_before
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;[Task </span><span class="token interpolation"><span class="token punctuation">{</span>sender<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">] Memory after: </span><span class="token interpolation"><span class="token punctuation">{</span>memory_after <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> MB, &quot;</span></span>
                    <span class="token string-interpolation"><span class="token string">f&quot;Diff: </span><span class="token interpolation"><span class="token punctuation">{</span>memory_diff <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string"> MB&quot;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;[Task </span><span class="token interpolation"><span class="token punctuation">{</span>sender<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">] Memory usage before task not found.&quot;</span></span><span class="token punctuation">)</span>
</code></pre></div><p>Celery Worker 内存监控时需要注意几个点：</p> <ol><li>Celery Worker 可以使用 prefork 模式执行（<code>celery worker --pool=processes</code>），虽然这会带来一定内存上升（每个 worker process 都需要加载库、拥有一份全局变量），但是 prefork 模式下每个 worker process 是串行执行的，所以任务的内存使用量是隔离的，统计值不会受到其它任务的影响。</li> <li>Celery Worker 场景下时延不敏感，所以在任务执行前后直接 GC 是可以的，这样统计的内存波动更准确。</li> <li>Celery Worker 的默认并发数为 CPU 数，在 Docker 和 K8s 环境中，系统获取的 CPU 是宿主机的 CPU 数量，而非 requests 或 limit，prefork 模式下使用默认值数会创建过多的进程，导致。所以强烈建立显式执行并发数（<code>--concurrency=4</code>）。</li></ol> <p>实际业务场景中，确实有任务在处理以后多占用了 1.5G 的空间，后来分析发现是因为处理大量数据的时候没有做分批处理，改为分批处理以后内存量就下降了。</p> <h2 id="objgraph"><a href="#objgraph" class="header-anchor">#</a> objgraph</h2> <p>参考：<a href="https://zhuanlan.zhihu.com/p/436577356" target="_blank" rel="noopener noreferrer">填坑总结：python内存泄漏排查小技巧 - 知乎<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。这部分有现成的博客可以参考，就不多赘述了。</p> <p>objgraph 和 tracemalloc 类似，都是 Python 内置的内存分析工具，分析 pymalloc 分配的内存。objgraph 的好处是自带增量分析，可以分析对象之间的引用关系。</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> objgraph

objgraph<span class="token punctuation">.</span>show_growth<span class="token punctuation">(</span>limit<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
</code></pre></div><p>运行一段时间后，发现某个不常见对象的数量一直在少量增长，怀疑是这个对象造成的。</p> <p>将这些对象的引用关系输出到 dot 文件里，然后使用 graphviz 可视化。</p> <div class="language-py extra-class"><pre class="language-py"><code>gth <span class="token operator">=</span> objgraph<span class="token punctuation">.</span>growth<span class="token punctuation">(</span>limit<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> gt <span class="token keyword">in</span> gth<span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;growth type:%s, count:%s, growth:%s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>gt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> gt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> gt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> gt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">100</span> <span class="token keyword">or</span> gt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">300</span><span class="token punctuation">:</span>
        <span class="token keyword">continue</span>
    objgraph<span class="token punctuation">.</span>show_backrefs<span class="token punctuation">(</span>objgraph<span class="token punctuation">.</span>by_type<span class="token punctuation">(</span>gt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> max_depth<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> too_many<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
                           filename<span class="token operator">=</span><span class="token string">&quot;./dots/%s_backrefs.dot&quot;</span> <span class="token operator">%</span> gt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    objgraph<span class="token punctuation">.</span>show_refs<span class="token punctuation">(</span>objgraph<span class="token punctuation">.</span>by_type<span class="token punctuation">(</span>gt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> max_depth<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> too_many<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
                       filename<span class="token operator">=</span><span class="token string">&quot;./dots/%s_refs.dot&quot;</span> <span class="token operator">%</span> gt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    objgraph<span class="token punctuation">.</span>show_chain<span class="token punctuation">(</span>
        objgraph<span class="token punctuation">.</span>find_backref_chain<span class="token punctuation">(</span>objgraph<span class="token punctuation">.</span>by_type<span class="token punctuation">(</span>gt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> objgraph<span class="token punctuation">.</span>is_proper_module<span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">=</span><span class="token string">&quot;./dots/%s_chain.dot&quot;</span> <span class="token operator">%</span> gt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>dot -Tpng xxx_chain.dot -o xxx_chain.png
</code></pre></div><p>就可以定位到这个对象的引用关系了。</p> <h2 id="wss-偏高"><a href="#wss-偏高" class="header-anchor">#</a> WSS 偏高</h2> <p>WSS 也是一个很有趣的话题，之前用 K8s 的时候有注意过这个概念，但并没有太理解。最近遇到了 WSS 异常高的问题，深入了解后才明白了 WSS 和 RSS 的区别。</p> <ul><li>RSS (Resident set size): RSS 是主内存中不对应于磁盘上任何内容的物理内存。RSS 包括栈、堆和匿名内存映射。</li> <li>WSS (Working set size): WSS 是一个进程在一段时间内工作所需的内存。</li></ul> <p>初看这两个概念非常抽象。但是下面会引入两个新的概念和一个公式，两者就好理解多了。</p> <ul><li>RSS 这个值可以理解成程序申请了并且在使用的内存，不能被外界清理，等于 <code>top</code> 里的 <code>RES</code>，也等于 Python <code>psutil</code> 里的 RSS。</li> <li>除了程序申请的内存，程序还会读取文件，系统会将文件缓存到操作系统中。其中，频繁读取的（读取了两次及以上的）文件会放到 <code>active_file</code>；读取了一次，或者一段时间没有再使用的文件会放到 <code>inactive_file</code>。这个设计思想是合理的，就和 Python、JS 的多级 GC 一样，先把不常用的文件降级，GC 的时候优先清理不常用的文件。</li> <li><strong>WSS = RSS + active_file</strong>。也就是说 WSS 会把 <code>active_file</code> 也算上，但不计算 <code>inactive_file</code>。</li></ul> <p>所以，如果 RSS 正常，WSS 偏高，可以判断是 <code>active_file</code> 占用过高。</p> <p>在 Pod 里可以查询 cgroup 下 <code>rss</code> 和 <code>active_file</code> 的大小。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">cat</span> /sys/fs/cgroup/memory/memory.stat

cache <span class="token number">6980935680</span>
rss <span class="token number">3365285888</span>
rss_huge <span class="token number">0</span>
mapped_file <span class="token number">36864</span>
swap <span class="token number">0</span>
pgpgin <span class="token number">37141945</span>
pgpgout <span class="token number">34616012</span>
pgfault <span class="token number">38453850</span>
pgmajfault <span class="token number">4</span>
inactive_anon <span class="token number">45056</span>
active_anon <span class="token number">3365224448</span>
inactive_file <span class="token number">4316774400</span>
active_file <span class="token number">2664116224</span>
unevictable <span class="token number">0</span>
hierarchical_memory_limit <span class="token number">17179869184</span>
hierarchical_memsw_limit <span class="token number">17179869184</span>
total_cache <span class="token number">6980935680</span>
total_rss <span class="token number">3365285888</span>
total_rss_huge <span class="token number">0</span>
total_mapped_file <span class="token number">36864</span>
total_swap <span class="token number">0</span>
total_pgpgin <span class="token number">0</span>
total_pgpgout <span class="token number">0</span>
total_pgfault <span class="token number">0</span>
total_pgmajfault <span class="token number">0</span>
total_inactive_anon <span class="token number">45056</span>
total_active_anon <span class="token number">3365224448</span>
total_inactive_file <span class="token number">4316774400</span>
total_active_file <span class="token number">2664116224</span>
total_unevictable <span class="token number">0</span>
</code></pre></div><p>这里的 <code>rss</code> 大小为 3.1G，<code>active_file</code> 大小为 2.5G，WSS = 3.1G + 2.5G = 5.6G。可以使用 K8s 的 <code>kubectl top pod</code> 命令查看 WSS 和 RSS 的大小进行验证。</p> <hr> <p>那么下一个问题是，定位到 <code>active_file</code> 偏高后，如何定位到加载了什么文件呢？</p> <p>系统并没有提供枚举内存中 active_file 对应了哪些文件。</p> <p>有一个工具 <code>vmtouch</code> 命令可以传入文件列表，查询这里面有多少被加载进了内存，但需要我们提前知道哪些文件可能被加入到内存中。</p> <p>可以先使用 <code>lsof</code> 命令来查看当前进程打开的文件列表（部分输出已省略）。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">lsof</span> -p <span class="token number">181</span>
COMMAND PID <span class="token environment constant">USER</span> FD TYPE DEVICE SIZE/OFF NODE NAME
uvicorn <span class="token number">181</span> root cwd DIR <span class="token number">0,496</span> <span class="token number">4096</span> <span class="token number">2108472</span> /src
uvicorn <span class="token number">181</span> root rtd DIR <span class="token number">0,496</span> <span class="token number">4096</span> <span class="token number">2108464</span> /
uvicorn <span class="token number">181</span> root txt REG <span class="token number">0,496</span> <span class="token number">18400</span> <span class="token number">21366419</span> /usr/local/bin/python3.8
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">21366419</span> /usr/local/bin/python3.8 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24644260</span> /usr/local/lib/python3.8/site-packages/rpds/rpds.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24643051</span> /usr/local/lib/python3.8/site-packages/ray/thirdparty_files/setproctitle.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24515449</span> /usr/local/lib/python3.8/site-packages/ray/_raylet.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24381158</span> /usr/local/lib/python3.8/site-packages/gevent/_gevent_c_imap.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
<span class="token punctuation">..</span>.
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24381203</span> /usr/local/lib/python3.8/site-packages/gevent/libev/corecext.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24118626</span> /usr/local/lib/python3.8/site-packages/Crypto/Cipher/_raw_aesni.abi3.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
<span class="token punctuation">..</span>.
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24118635</span> /usr/local/lib/python3.8/site-packages/Crypto/Cipher/_raw_ecb.abi3.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">21367099</span> /usr/local/lib/python3.8/lib-dynload/_elementtree.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1864875</span> /usr/local/lib/python3.8/site-packages/google/_upb/_message.abi3.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24381068</span> /usr/local/lib/python3.8/site-packages/frozenlist/_frozenlist.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24120243</span> /usr/local/lib/python3.8/site-packages/aiohttp/_websocket.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24120239</span> /usr/local/lib/python3.8/site-packages/aiohttp/_http_parser.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24120241</span> /usr/local/lib/python3.8/site-packages/aiohttp/_http_writer.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24120236</span> /usr/local/lib/python3.8/site-packages/aiohttp/_helpers.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24646390</span> /usr/local/lib/python3.8/site-packages/yarl/_quoting_c.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24383932</span> /usr/local/lib/python3.8/site-packages/multidict/_multidict.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1870845</span> /usr/local/lib/python3.8/site-packages/regex/_regex.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">21367140</span> /usr/local/lib/python3.8/lib-dynload/mmap.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1869864</span> /usr/local/lib/python3.8/site-packages/psutil/_psutil_posix.abi3.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">20709986</span> /lib/x86_64-linux-gnu/libnss_dns-2.31.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">20709988</span> /lib/x86_64-linux-gnu/libnss_files-2.31.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">21106628</span> /usr/lib/x86_64-linux-gnu/libmariadb.so.3 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1869863</span> /usr/local/lib/python3.8/site-packages/psutil/_psutil_linux.abi3.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1854269</span> /usr/local/lib/python3.8/site-packages/MySQLdb/_mysql.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1871693</span> /usr/local/lib/python3.8/site-packages/safetensors/_safetensors_rust.abi3.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1879741</span> /usr/local/lib/python3.8/site-packages/tokenizers/tokenizers.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1871713</span> /usr/local/lib/python3.8/site-packages/sentencepiece/_sentencepiece.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">21367136</span> /usr/local/lib/python3.8/lib-dynload/cmath.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1869171</span> /usr/local/lib/python3.8/site-packages/nvidia/nvjitlink/lib/libnvJitLink.so.12 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1869157</span> /usr/local/lib/python3.8/site-packages/nvidia/nccl/lib/libnccl.so.2 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1868850</span> /usr/local/lib/python3.8/site-packages/nvidia/cublas/lib/libcublasLt.so.12 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1868849</span> /usr/local/lib/python3.8/site-packages/nvidia/cublas/lib/libcublas.so.12 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1869107</span> /usr/local/lib/python3.8/site-packages/nvidia/curand/lib/libcurand.so.10 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1890830</span> /usr/local/lib/python3.8/site-packages/torch/lib/libcusparseLt-f8b4a9fb.so.0 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1869076</span> /usr/local/lib/python3.8/site-packages/nvidia/cufft/lib/libcufft.so.11 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1869142</span> /usr/local/lib/python3.8/site-packages/nvidia/cusparse/lib/libcusparse.so.12 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1868898</span> /usr/local/lib/python3.8/site-packages/nvidia/cuda_cupti/lib/libcupti.so.12 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1869053</span> /usr/local/lib/python3.8/site-packages/nvidia/cudnn/lib/libcudnn.so.8 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1890827</span> /usr/local/lib/python3.8/site-packages/torch/lib/libc10.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1890828</span> /usr/local/lib/python3.8/site-packages/torch/lib/libc10_cuda.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1890835</span> /usr/local/lib/python3.8/site-packages/torch/lib/libtorch_cuda.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1890834</span> /usr/local/lib/python3.8/site-packages/torch/lib/libtorch_cpu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1890833</span> /usr/local/lib/python3.8/site-packages/torch/lib/libtorch.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1890832</span> /usr/local/lib/python3.8/site-packages/torch/lib/libshm.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1890838</span> /usr/local/lib/python3.8/site-packages/torch/lib/libtorch_python.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1879798</span> /usr/local/lib/python3.8/site-packages/torch/_C.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1890831</span> /usr/local/lib/python3.8/site-packages/torch/lib/libgomp-a34b3233.so.1 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1869207</span> /usr/local/lib/python3.8/site-packages/nvidia/nvtx/lib/libnvToolsExt.so.1 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">1869022</span> /usr/local/lib/python3.8/site-packages/nvidia/cuda_runtime/lib/libcudart.so.12 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24512873</span> /usr/local/lib/python3.8/site-packages/pillow.libs/libXau-154567c4.so.6.0.0 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
<span class="token punctuation">..</span>.
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24512884</span> /usr/local/lib/python3.8/site-packages/pillow.libs/libtiff-0a86184d.so.6.0.2 <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24119318</span> /usr/local/lib/python3.8/site-packages/PIL/_imaging.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
uvicorn <span class="token number">181</span> root mem REG <span class="token number">253,16</span> <span class="token number">24385120</span> /usr/local/lib/python3.8/site-packages/numpy/random/_generator.cpython-38-x86_64-linux-gnu.so <span class="token punctuation">(</span>path <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token number">0,496</span><span class="token punctuation">)</span>
<span class="token punctuation">..</span>.
</code></pre></div><p>可以发现大部分都是依赖，比如 <code>cuda</code>、<code>torch</code>、<code>numpy</code>、<code>PIL</code> 等等。从直觉上来说 <code>torch</code> 和 <code>cuda</code> 可能会很大，所以我们使用 <code>vmtouch</code> 来看一下 <code>cuda</code> 和 <code>torch</code> 有多少被加载到了内存里。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ vmtouch /usr/local/lib/python3.8/site-packages/nvidia/**/*
Files: <span class="token number">300</span>
Directories: <span class="token number">66</span>
Resident Pages: <span class="token number">729487</span>/729487 2G/2G <span class="token number">100</span>%
Elapsed: <span class="token number">0.068292</span> seconds

$ vmtouch /usr/local/lib/python3.8/site-packages/torch/**/*
           Files: <span class="token number">11773</span>
     Directories: <span class="token number">629</span>
  Resident Pages: <span class="token number">381258</span>/387864  1G/1G  <span class="token number">98.3</span>%
         Elapsed: <span class="token number">0.1744</span> seconds
</code></pre></div><p>可以看到 <code>torch</code> 的大部分文件和 <code>nvidia</code> 的所有文件都加载进了内存，而且占用都很高，一共占用了 3G 多的内存。所以 WSS 偏高是因为加载了 cuda 和 torch 的依赖。</p> <p>不过需要注意的是 <code>vmtouch</code> 的结果可能会大于 <code>active_file</code> 的大小，一是因为 <code>vmtouch</code> 只知道文件被加载进内存与否，不区分 <code>active_file</code> 还是 <code>inactive_file</code>。二是因为 <code>vmtouch</code> 查询的是整个宿主机的加载情况，而 <code>active_file</code> 只查询了当前 cgroup 的加载情况。如果当前 cgroup 以外的进程已经把这部分文件加载进内存，那么当前 cgroup 可能就不会把这部分文件计算到 <code>active_file</code> 里。</p> <p>所以，实际情况怎么样，还是需要通过对照实验（起一个不包含这些依赖的镜像）来证明确实是这些依赖导致的。</p></div> <hr role="separator" aria-orientation="horizontal" class="ma-4 v-divider theme--light"> <div data-v-54a1e472><script src="https://giscus.app/client.js" async="async" service="giscus" data-repo="lyh543/blog-comments" data-repo-id="R_kgDOHIb2Zg" data-category="Announcements" data-category-id="DIC_kwDOHIb2Zs4COh2z" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" data-v-54a1e472></script></div></div></div></article></div> <!----></container> <div class="v-dialog__container"><button type="button" role="button" aria-haspopup="true" aria-expanded="false" class="v-btn v-btn--bottom v-btn--is-elevated v-btn--fab v-btn--fixed v-btn--has-bg v-btn--right v-btn--round theme--dark v-size--default primary"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-information-variant theme--dark"></i></span></button><!----></div></div></div></main> <footer id="footer" class="v-footer v-sheet theme--light v-footer--absolute v-footer--padless v-footer--inset" style="left:0px;right:0px;bottom:0px;"><div class="lighten-1 text-center v-card v-sheet theme--light rounded-0" style="width:100%;"><div class="v-card__text"><a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-github theme--light" style="font-size:24px;"></i></span></a><a href="https://blog.lyh543.cn/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-web theme--light" style="font-size:24px;"></i></span></a><a href="mailto:lyh543@outlook.com" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-email theme--light" style="font-size:24px;"></i></span></a><a href="https://weibo.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-sina-weibo theme--light" style="font-size:24px;"></i></span></a><a href="https://weixin.qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-wechat theme--light" style="font-size:24px;"></i></span></a><a href="https://qq.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><i aria-hidden="true" class="v-icon notranslate mdi mdi-qqchat theme--light" style="font-size:24px;"></i></span></a><a href="https://bilibili.com/" target="_blank" class="mx-4 v-btn v-btn--icon v-btn--round theme--light v-size--default"><span class="v-btn__content"><div class="v-image v-responsive theme--light" style="max-width:24px;"><div class="v-image__image v-image__image--preload v-image__image--cover" style="background-image:;background-position:center center;"></div><div class="v-responsive__content"></div></div></span></a></div> <hr role="separator" aria-orientation="horizontal" class="v-divider theme--light"> <div class="v-card__text"><span class="footer-text">lyh543 © 2019 - 2024</span>
        |
      <a href="https://beian.miit.gov.cn/" target="_blank" class="footer-link">蜀ICP备19034464号</a>
        |
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" class="footer-link">署名 - 非商业性 - 相同方式共享 4.0 国际协议</a>
        |
       <span class="footer-text">
        Theme
        <a href="https://github.com/lyh543/vuepress-theme-blog-material/" target="_blank" class="footer-link">
          vuepress-theme-blog-material
        </a></span></div></div></footer></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.adfd3ce4.js" defer></script><script src="/assets/js/230.64cc02e7.js" defer></script>
  </body>
</html>
