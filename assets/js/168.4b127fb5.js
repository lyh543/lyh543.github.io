(window.webpackJsonp=window.webpackJsonp||[]).push([[168],{527:function(t,s,a){"use strict";a.r(s);var n=a(3),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"django-后端学习路线"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#django-后端学习路线"}},[t._v("#")]),t._v(" Django 后端学习路线")]),t._v(" "),s("p",[t._v("推荐从上往下看。")]),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://docs.djangoproject.com/zh-hans/3.1/intro/install/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方快速安装指南（3.1 版本）"),s("OutboundLink")],1),t._v("，安装的教程")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://docs.djangoproject.com/zh-hans/3.1/intro/tutorial01/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方中文教程（3.1 版本）"),s("OutboundLink")],1),t._v("，开发的教程")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/learn/Server-side/Django",target:"_blank",rel:"noopener noreferrer"}},[t._v("MDN 上的 Django 教程"),s("OutboundLink")],1),t._v("，和上面的教程有重叠，推荐只看"),s("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Learn/Server-side/Django/Sessions",target:"_blank",rel:"noopener noreferrer"}},[t._v("会话"),s("OutboundLink")],1),t._v("和"),s("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Learn/Server-side/Django/Authentication",target:"_blank",rel:"noopener noreferrer"}},[t._v("用户认证"),s("OutboundLink")],1),t._v("部分")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://q1mi.github.io/Django-REST-framework-documentation/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Django REST Framework"),s("OutboundLink")],1),t._v("，这是一个基于 Django 的 RESTful 后端框架，为常见 RESTful 操作提供了模板，大大降低 REST API 开发量")])]),t._v(" "),s("h2",{attrs:{id:"django-官方教程-关键步骤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#django-官方教程-关键步骤"}},[t._v("#")]),t._v(" Django 官方教程 关键步骤")]),t._v(" "),s("p",[t._v("本小节记录了 "),s("a",{attrs:{href:"https://docs.djangoproject.com/zh-hans/3.1/intro/tutorial01/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方中文教程（3.1 版本）"),s("OutboundLink")],1),t._v(" 中的关键步骤。")]),t._v(" "),s("h3",{attrs:{id:"_1-创建项目、项目和一个视图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建项目、项目和一个视图"}},[t._v("#")]),t._v(" 1. 创建项目、项目和一个视图")]),t._v(" "),s("ul",[s("li",[t._v("安装："),s("code",[t._v("pip install Django")])]),t._v(" "),s("li",[t._v("验证安装："),s("code",[t._v("python -m django --version")])]),t._v(" "),s("li",[t._v("创建并初始化项目文件夹："),s("code",[t._v("django-admin startproject <projectname>")])]),t._v(" "),s("li",[t._v("即时预览：在 "),s("code",[t._v("<projectname>")]),t._v(" 目录下 "),s("code",[t._v("python manage.py runserver [port]")])]),t._v(" "),s("li",[t._v("创建应用："),s("code",[t._v("python manage.py startapp <appname>")])]),t._v(" "),s("li",[t._v("编写视图：")])]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# polls/views.py")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("http "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" HttpResponse\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("index")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" HttpResponse"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello, world. You\'re at the polls index."')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("ul",[s("li",[t._v("在应用中添加写好的视图：")])]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# polls/urls.py")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("urls "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" path\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" views\n\nurlpatterns "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" views"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("index"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'index'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("ul",[s("li",[t._v("在站点中添加应用的视图：")])]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mysite/urls.py")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("contrib "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" admin\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("urls "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" include"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" path\n\nurlpatterns "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'polls/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" include"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'polls.urls'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'admin/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" admin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("site"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("urls"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("h3",{attrs:{id:"_2-数据库使用、管理员"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-数据库使用、管理员"}},[t._v("#")]),t._v(" 2. 数据库使用、管理员")]),t._v(" "),s("h4",{attrs:{id:"_2-1-配置数据库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-配置数据库"}},[t._v("#")]),t._v(" 2.1 配置数据库")]),t._v(" "),s("ul",[s("li",[t._v("安装 mysqlclient："),s("code",[t._v("pip install mysqlclient")])]),t._v(" "),s("li",[t._v("修改项目配置文件：")])]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mysite/settings.py")]),t._v("\n\nDATABASES "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'default'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ENGINE'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'django.db.backends.mysql'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'NAME'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'django_learn'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'USER'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'PASSWORD'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'yourpassword'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'HOST'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'127.0.0.1'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'PORT'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3306'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-2-创建模型并迁移至数据库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-创建模型并迁移至数据库"}},[t._v("#")]),t._v(" 2.2 创建模型并迁移至数据库")]),t._v(" "),s("p",[t._v("一个 Django 模型对于一个 SQL 数据表。")]),t._v(" "),s("ul",[s("li",[t._v("创建模型：")])]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# polls/models.py")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("db "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" models\n\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Question")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("models"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Model"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    question_text "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" models"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CharField"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("max_length"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    pub_date "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" models"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DateTimeField"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'date published'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__str__")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("question_text\n\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Choice")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("models"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Model"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    question "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" models"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ForeignKey"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Question"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" on_delete"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("models"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CASCADE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    choice_text "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" models"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CharField"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("max_length"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    votes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" models"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("IntegerField"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("default"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("__str__")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" self"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("choice_text\n")])])]),s("ul",[s("li",[t._v("激活模型：")])]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mysite/settings.py")]),t._v("\nINSTALLED_APPS "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'polls.apps.PollsConfig'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加这一项")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("ul",[s("li",[t._v("将模型更改写入数据库：\n"),s("ul",[s("li",[t._v("根据类的更改，生成一个 "),s("code",[t._v("迁移")]),t._v("（一个存储在 "),s("code",[t._v("<app_lable>/migrations")]),t._v(" 下的 py 文件，存储了变化）："),s("code",[t._v("python manage.py makemigrations [app_label]")]),t._v("（"),s("a",{attrs:{href:"https://docs.djangoproject.com/zh-hans/3.1/ref/django-admin/#makemigrations",target:"_blank",rel:"noopener noreferrer"}},[t._v("文档"),s("OutboundLink")],1),t._v("）")]),t._v(" "),s("li",[t._v("将一个 "),s("code",[t._v("迁移")]),t._v(" 应用到数据库，并迁移数据："),s("code",[t._v("python manage.py migrate [app_label] [migration_name]")]),t._v("（"),s("a",{attrs:{href:"https://docs.djangoproject.com/zh-hans/3.1/ref/django-admin/#django-admin-migrate",target:"_blank",rel:"noopener noreferrer"}},[t._v("文档"),s("OutboundLink")],1),t._v("）")]),t._v(" "),s("li",[t._v("查看一个 "),s("code",[t._v("迁移")]),t._v(" 将对数据库造成的影响："),s("code",[t._v("python manage.py sqlmigrate <app_label> <migration_name>")]),t._v("（"),s("a",{attrs:{href:"https://docs.djangoproject.com/zh-hans/3.1/ref/django-admin/#django-admin-sqlmigrate",target:"_blank",rel:"noopener noreferrer"}},[t._v("文档"),s("OutboundLink")],1),t._v("）")]),t._v(" "),s("li",[t._v("一般来说，类变更以后，需要："),s("code",[t._v("python manage.py makemigrations && python manage.py migrate")])]),t._v(" "),s("li",[t._v("第一次部署的时候，需要 "),s("code",[t._v("python manage.py makemigrations <app1> <app2> <...appn> && python manage.py migrate")])])])])]),t._v(" "),s("p",[t._v("对了，"),s("code",[t._v("migrations")]),t._v(" 文件夹应当加入 "),s("code",[t._v(".gitignore")]),t._v("，否则不同开发者的 "),s("code",[t._v("migrations")]),t._v(" 就要冲突啦。")]),t._v(" "),s("h4",{attrs:{id:"_2-3-数据库-api"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-数据库-api"}},[t._v("#")]),t._v(" 2.3 数据库 API")]),t._v(" "),s("ul",[s("li",[t._v("进入 Python 命令行："),s("code",[t._v("python manage.py shell")])]),t._v(" "),s("li",[t._v("使用前先引入类："),s("code",[t._v("from polls.models import Choice, Question")])])]),t._v(" "),s("hr"),t._v(" "),s("p",[t._v("对于一个数据表：")]),t._v(" "),s("ul",[s("li",[t._v("一个表的所有元素："),s("code",[t._v("Question.objects.all()")])]),t._v(" "),s("li",[t._v("以成员筛选记录："),s("code",[t._v("Question.objects.filter(id=1)")])]),t._v(" "),s("li",[t._v("以 "),s("code",[t._v("pub_date")]),t._v(" 成员的 "),s("code",[t._v("year")]),t._v(" 成员筛选（成员方法同理）："),s("code",[t._v("pub_date.year")]),t._v("："),s("code",[t._v("Question.objects.filter(pub_date__year)")])])]),t._v(" "),s("hr"),t._v(" "),s("p",[t._v("对于一个记录：")]),t._v(" "),s("ul",[s("li",[t._v("构造一个新记录："),s("code",[t._v('q = Question(question_text="What\'s new?", pub_date=timezone.now())')])]),t._v(" "),s("li",[t._v("将记录插入表："),s("code",[t._v("q.save()")])]),t._v(" "),s("li",[t._v("查询、修改记录的属性（同理可调用其方法）："),s("code",[t._v("q.question_text")])]),t._v(" "),s("li",[t._v("删除一个记录："),s("code",[t._v("q.delete()")])])]),t._v(" "),s("hr"),t._v(" "),s("p",[t._v("对于一个外键（"),s("code",[t._v("Choice")]),t._v(" 存在外键，为 "),s("code",[t._v("Question")]),t._v("）：")]),t._v(" "),s("ul",[s("li",[t._v("查询一个 Choice 对应的 Question："),s("code",[t._v("c.qeustion")])]),t._v(" "),s("li",[t._v("查询一个 Question 对应的 Choice："),s("code",[t._v("q.choice_set.all()")])]),t._v(" "),s("li",[t._v("为 Question 创建一个 Choice："),s("code",[t._v("q.choice_set.create(choice_text='Not much', votes=0)")])])]),t._v(" "),s("h4",{attrs:{id:"_2-4-管理员相关"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-管理员相关"}},[t._v("#")]),t._v(" 2.4 管理员相关")]),t._v(" "),s("ul",[s("li",[t._v("创建管理员："),s("code",[t._v("python manage.py createsuperuser")])]),t._v(" "),s("li",[t._v("管理员登录界面："),s("code",[t._v("http://127.0.0.1:8000/admin/")])]),t._v(" "),s("li",[t._v("在管理员页面中添加 "),s("code",[t._v("Question")]),t._v(" 模型：")])]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# polls/admin.py")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("contrib "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" admin\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Question\n\nadmin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("site"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("register"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Question"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h3",{attrs:{id:"_3-视图和-urls"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-视图和-urls"}},[t._v("#")]),t._v(" 3. 视图和 urls")]),t._v(" "),s("h4",{attrs:{id:"_3-1-添加更多视图-并用参数匹配-url"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-添加更多视图-并用参数匹配-url"}},[t._v("#")]),t._v(" 3.1 添加更多视图，并用参数匹配 url")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# /polls/views.py")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("detail")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" question_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" HttpResponse"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"You\'re looking at question %s."')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),t._v(" question_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 这里可以做更多的事情，比如调用其他 Python 包")]),t._v("\n")])])]),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# /polls/url.py")]),t._v("\nurlpatterns "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'<int:question_id>/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" views"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("detail"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'detail'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("访问 "),s("code",[t._v("/polls/34")]),t._v(" 会返回 "),s("code",[t._v("You're looking at question 34.")])]),t._v(" "),s("h4",{attrs:{id:"_3-2-使用-html-模板"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-使用-html-模板"}},[t._v("#")]),t._v(" 3.2 使用 HTML 模板")]),t._v(" "),s("p",[t._v("编写一个 HTML 模板：")]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- /polls/templates/polls/index.html --\x3e")]),t._v("\n{% if latest_question_list %}\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("ul")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    {% for question in latest_question_list %}\n        "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("a")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("/polls/{{ question.id }}/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("{{ question.question_text }}"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("a")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("li")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    {% endfor %}\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("ul")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n{% else %}\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("p")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("No polls are available."),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("p")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n{% endif %}\n")])])]),s("p",[t._v("再在视图中：加载模板、用数据渲染、然后转为 HTTP Response，三步使用 "),s("code",[t._v("django.shortcuts.render()")]),t._v(" 完成")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shortcuts "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" render\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("index")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    latest_question_list "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Question"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("objects"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("order_by"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'-pub_date'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    context "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'latest_question_list'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" latest_question_list"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" render"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'polls/index.html'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h4",{attrs:{id:"_3-3-抛出-404-错误码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-抛出-404-错误码"}},[t._v("#")]),t._v(" 3.3 抛出 404 错误码")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("http "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Http404\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("detail")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" question_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        question "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Question"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("objects"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pk"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("question_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("except")]),t._v(" Question"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("DoesNotExist"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("raise")]),t._v(" Http404"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Question does not exist"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" render"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'polls/detail.html'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'question'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" question"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("也可以使用 "),s("code",[t._v("django.shortcuts.get_object_or_404")]),t._v("。该函数在 "),s("code",[t._v("object")]),t._v(" 不存在会 "),s("code",[t._v("raise Http404()")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("shortcuts "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" get_object_or_404"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" render\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("detail")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" question_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    question "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" get_object_or_404"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Question"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pk"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("question_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" render"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'polls/detail.html'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'question'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" question"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("也有 "),s("code",[t._v("get_list_or_404()")]),t._v(" 函数，工作原理和 "),s("code",[t._v("get_object_or_404()")]),t._v(" 一样，除了 "),s("code",[t._v("get()")]),t._v(" 函数被换成了 "),s("code",[t._v("filter()")]),t._v(" 函数。如果列表为空的话会抛出 "),s("code",[t._v("Http404")]),t._v(" 异常。")]),t._v(" "),s("h4",{attrs:{id:"_3-4-使用-name-替代-url-中的硬编码、为-url-名称添加命名空间-app-name"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-使用-name-替代-url-中的硬编码、为-url-名称添加命名空间-app-name"}},[t._v("#")]),t._v(" 3.4 使用 name 替代 URL 中的硬编码、为 URL 名称添加命名空间(app_name)")]),t._v(" "),s("p",[t._v("https://docs.djangoproject.com/zh-hans/3.1/intro/tutorial03/#removing-hardcoded-urls-in-templates")]),t._v(" "),s("p",[t._v("https://docs.djangoproject.com/zh-hans/3.1/intro/tutorial03/#namespacing-url-names")]),t._v(" "),s("h3",{attrs:{id:"_4-编写一个简单的表单"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-编写一个简单的表单"}},[t._v("#")]),t._v(" 4. 编写一个简单的表单")]),t._v(" "),s("p",[t._v("因为我想用 Django 做纯 REST 后端，所以这部分略。")]),t._v(" "),s("p",[t._v("https://docs.djangoproject.com/zh-hans/3.1/intro/tutorial04/")]),t._v(" "),s("h3",{attrs:{id:"_5-测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-测试"}},[t._v("#")]),t._v(" 5. 测试")]),t._v(" "),s("p",[t._v("https://docs.djangoproject.com/zh-hans/3.1/intro/tutorial05/")]),t._v(" "),s("p",[t._v("关于测试还是值得单独拿一个章节出来的："),s("RouterLink",{attrs:{to:"/posts/2020-01-08-django-test.html"}},[t._v("测试")])],1),t._v(" "),s("h3",{attrs:{id:"_6-插入静态文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-插入静态文件"}},[t._v("#")]),t._v(" 6. 插入静态文件")]),t._v(" "),s("p",[t._v("https://docs.djangoproject.com/zh-hans/3.1/intro/tutorial06/")]),t._v(" "),s("h3",{attrs:{id:"_7-修改-admin-页面"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-修改-admin-页面"}},[t._v("#")]),t._v(" 7. 修改 Admin 页面")]),t._v(" "),s("p",[t._v("https://docs.djangoproject.com/zh-hans/3.1/intro/tutorial07/")]),t._v(" "),s("p",[t._v("如果想要修改某元素对应外键的信息（而不是修改其外键），可以参考 "),s("a",{attrs:{href:"https://docs.djangoproject.com/en/3.1/ref/contrib/admin/#django.contrib.admin.StackedInline",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("django.contrib.admin.StackedInline")]),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("如果想要汉化 Admin 页面，可以参考：https://blog.csdn.net/aaazz47/article/details/78666099")]),t._v(" "),s("h2",{attrs:{id:"django-用户认证"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#django-用户认证"}},[t._v("#")]),t._v(" Django 用户认证")]),t._v(" "),s("h3",{attrs:{id:"django-用户认证-后端篇"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#django-用户认证-后端篇"}},[t._v("#")]),t._v(" Django 用户认证（后端篇）")]),t._v(" "),s("blockquote",[s("p",[t._v("MDN 教程：https://developer.mozilla.org/zh-CN/docs/Learn/Server-side/Django/Authentication"),s("br"),t._v("\n文档：https://docs.djangoproject.com/zh-hans/3.1/topics/auth/default/")])]),t._v(" "),s("ul",[s("li",[t._v("创建用户："),s("code",[t._v("user = User.objects.create_user('john', 'lennon@thebeatles.com', 'johnpassword')")])]),t._v(" "),s("li",[t._v("创建超级用户：在命令行中 "),s("code",[t._v("python manage.py createsuperuser")])]),t._v(" "),s("li",[t._v("登录：")])]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("contrib"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auth "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" authenticate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" login\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("my_view")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    username "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("POST"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'username'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    password "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("POST"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'password'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    user "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" authenticate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" username"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("username"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" password"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("password"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" user "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        login"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Redirect to a success page.")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Return an 'invalid login' error message.")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])]),s("ul",[s("li",[t._v("判断用户身份：可以通过 "),s("code",[t._v("request.user.is_authenticated==False")]),t._v(" 表示为匿名者；否则 "),s("code",[t._v("request.user")]),t._v(" 会被设置为 "),s("code",[t._v("User")]),t._v(" 实例。")]),t._v(" "),s("li",[t._v("更改密码：")])]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("contrib"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auth"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("models "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" User\n\nu "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" User"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("objects"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("username"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'john'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("set_password"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'new password'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("save"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("ul",[s("li",[s("a",{attrs:{href:"https://docs.djangoproject.com/zh-hans/3.1/topics/auth/default/#the-login-required-decorator",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("login_required")]),s("OutboundLink")],1),t._v(" 装饰器：")])]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" django"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("contrib"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("auth"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("decorators "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" login_required\n\n"),s("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@login_required")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("my_view")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n")])])]),s("ul",[s("li",[t._v("登出："),s("code",[t._v("django.contrib.auth.logout(request)")])])]),t._v(" "),s("h3",{attrs:{id:"django-用户认证-前端篇"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#django-用户认证-前端篇"}},[t._v("#")]),t._v(" Django 用户认证（前端篇）")]),t._v(" "),s("p",[t._v("Django 的用户认证是用 Session 实现的，和其他的 Session 应该是类似的。但对于零基础前后端开发的我，不清楚这之中究竟发生了什么。于是我简单测试了一下。")]),t._v(" "),s("p",[t._v("在登录成功后，应答的 headers 中就会出现 "),s("code",[t._v("Set-Cookies")]),t._v(" 字段：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('$ http POST http://127.0.0.1:8000/api/accounts/login/ <<< \'{"username":"lyh543@outlook.com", "password":"xxxxxxxx"}\'\nHTTP/1.1 200 OK\nAllow: OPTIONS, POST\nConnection: close\nContent-Length: 493\nContent-Type: application/json\nDate: Tue, 09 Feb 2021 05:34:41 GMT\nReferrer-Policy: same-origin\nServer: WSGIServer/0.2 CPython/3.9.1\nSet-Cookie: csrftoken=sJQyvoxpJ7nIwFpbgXSKKiBIoo7GxogKKTmsFwJshfyFMBIEyPlhQrvl8OK6FlQR; expires=Tue, 08 Feb 2022 05:34:40 GMT; Max-Age=31449600; Path=/; SameSite=Lax\nSet-Cookie: sessionid=kmst16goqdwof54ycuynbz7wzk1scboc; expires=Tue, 23 Feb 2021 05:34:40 GMT; HttpOnly; Max-Age=1209600; Path=/; SameSite=Lax\nVary: Accept, Cookie, Origin\nX-Content-Type-Options: nosniff\nX-Frame-Options: DENY\n')])])]),s("p",[t._v("前一个 "),s("code",[t._v("csrftoken")]),t._v(" 是防止跨站请求的，如果项目是前后端分离的话，就需要进行配置（关于 CSRF，可以看 "),s("RouterLink",{attrs:{to:"/posts/2021-02-23-handle-cors-and-csrf.html"}},[t._v("和 CSRF 与 CORS 斗智斗勇")]),t._v("）；"),s("br"),t._v("\n后一个 "),s("code",[t._v("sessionid")]),t._v(" 就是登录成功后的 "),s("code",[t._v("sessionid")]),t._v(" 了。如果我们在下次请求中的 headers 中加入了这个 "),s("code",[t._v("sessionid")]),t._v("，服务器就能识别到我们。对于 Django 来说，就是 "),s("code",[t._v("request.user")]),t._v(" 为登录的这个用户。")],1),t._v(" "),s("p",[t._v("对于浏览器、"),s("code",[t._v("requests.sessions.Session")]),t._v(" 等，会自动设置 Cookie。下面是利用 "),s("code",[t._v("requests.sessions.Session")]),t._v(" 完成登录、查询管理员字段的过程：")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[t._v("In "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" requests\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" s "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" requests"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Session"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" r1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("post"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8000/api/accounts/login/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"username"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lyh543@outlook.com"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"password"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"xxxxxxxx"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" r1\nOut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Response "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("dict")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nOut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'csrftoken'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s1aepuw0A08k9PsFtTWn6CbCkLU24MU6tTuk3DieW4uj1b6PAXwSjrfHqfCvufz3'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sessionid'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'f9ofrqwar9rs0phbg4p89647pwryowrs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" r1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers\nOut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'User-Agent'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'python-requests/2.18.4'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Accept-Encoding'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'gzip, deflate'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Accept'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'*/*'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Connection'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'keep-alive'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Length'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'47'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/x-www-form-urlencoded'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" r1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("headers\nOut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Date'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Tue, 09 Feb 2021 03:48:32 GMT'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Server'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'WSGIServer/0.2 CPython/3.9.1'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Type'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'application/json'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Vary'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Accept, Cookie, Origin'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Allow'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'OPTIONS, POST'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'X-Frame-Options'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DENY'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Content-Length'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'493'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'X-Content-Type-Options'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nosniff'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Referrer-Policy'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'same-origin'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Set-Cookie'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'csrftoken=s1aepuw0A08k9PsFtTWn6CbCkLU24MU6tTuk3DieW4uj1b6PAXwSjrfHqfCvufz3; expires=Tue, 08 Feb 2022 03:48:32 GMT; Max-Age=31449600; Path=/; SameSite=Lax, sessionid=f9ofrqwar9rs0phbg4p89647pwryowrs; expires=Tue, 23 Feb 2021 03:48:32 GMT; HttpOnly; Max-Age=1209600; Path=/; SameSite=Lax'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Connection'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'close'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" r1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8000/api/activities/1/admin/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("27")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" r1\nOut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("27")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Response "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),s("p",[t._v("而对于非登录操作、或登录失败，应答中的字段就不会有 "),s("code",[t._v("Set-Cookies")]),t._v(" 字段，"),s("code",[t._v("requests.sessions.Session")]),t._v(" 也不会设置 "),s("code",[t._v("Cookies")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[t._v("In "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" requests\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" s "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" requests"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Session"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" r1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://localhost:8000/api/activities/1/admin/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" r1\nOut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("Response "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("403")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies\nOut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("RequestsCookieJar"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\nIn "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("list")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nOut"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("Django Session 的过期时间也是可以通过修改 "),s("a",{attrs:{href:"https://docs.djangoproject.com/zh-hans/3.1/ref/settings/#session-cookie-age",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("SESSION_COOKIE_AGE")]),s("OutboundLink")],1),t._v(" 来修改的。")]),t._v(" "),s("h3",{attrs:{id:"使用-jwt-进行身份验证"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-jwt-进行身份验证"}},[t._v("#")]),t._v(" 使用 JWT 进行身份验证")]),t._v(" "),s("p",[t._v("Django 自带的 Session 对于很多项目已经够用了。如果想要更高级一点的安全验证，如 Json Web Token，可以尝试 "),s("a",{attrs:{href:"https://django-rest-framework-simplejwt.readthedocs.io/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Simple JWT"),s("OutboundLink")],1),t._v(" 配合 Django REST Framework 食用。文档给的示例代码很详细，有需要也可以仿照源码编写自己的 API。")]),t._v(" "),s("h2",{attrs:{id:"django-定时任务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#django-定时任务"}},[t._v("#")]),t._v(" Django 定时任务")]),t._v(" "),s("p",[t._v("可参考 "),s("a",{attrs:{href:"https://pypi.org/project/django-crontab/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Django-crontab"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"django-rest-framework"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#django-rest-framework"}},[t._v("#")]),t._v(" Django REST Framework")]),t._v(" "),s("p",[t._v("这部分就"),s("RouterLink",{attrs:{to:"/posts/2021-01-24-django-rest-framework.html"}},[t._v("另开一篇博文")]),t._v("来写了。")],1),t._v(" "),s("h2",{attrs:{id:"django-项目部署-wsgi"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#django-项目部署-wsgi"}},[t._v("#")]),t._v(" Django 项目部署 (WSGI)")]),t._v(" "),s("p",[t._v("Django 部署可以采用 WSGI，也可以使用 ASGI。WSGI 是为同步 Web Server 编写的，而 ASGI 是为异步 Web Server 编写的。虽然可以混用，但是同步函数和异步函数可以混用，但是会有约 1ms 的用于线程切换的性能损失。")]),t._v(" "),s("p",[t._v("。如果你主要使用的是异步函数，你可以快进到下一章，进行 ASGI 的部署。看完以后，再回来看看如何 "),s("a",{attrs:{href:"#%E5%A4%84%E7%90%86%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6"}},[t._v("处理静态文件")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"gunicorn"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gunicorn"}},[t._v("#")]),t._v(" Gunicorn")]),t._v(" "),s("p",[t._v("诚然，"),s("code",[t._v("python manage.py runserver 8000")]),t._v(" 然后将 8000 端口交给 Nginx / Apache / Caddy 反向代理到 80(http) / 443(https)，是最简单且最直接的方法。但是，其替代方案有多线程、占用内存小等优势。")]),t._v(" "),s("blockquote",[s("p",[t._v("Django 的管理命令 "),s("code",[t._v("startproject")]),t._v(" 生成了一个最小化的默认 WSGI 配置，你可以按照自己项目的需要去调整这个配置，任何兼容 WSGI 的应用程序服务器都可以直接使用。")])]),t._v(" "),s("p",[t._v("而其中一个 WSGI 应用程序服务器的方案，就是使用 Gunicorn。由于细节比较多，各位先不要急着实践，建议先通读这部分，再决定是否采用这种方式还是直接 "),s("code",[t._v("startproject")]),t._v("。")]),t._v(" "),s("p",[t._v("安装 Gunicorn：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("python -m pip "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" gunicorn\n")])])]),s("p",[t._v("在项目文件夹下运行：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("gunicorn -b "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"127.0.0.1:8000"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("projectname"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".wsgi\n")])])]),s("p",[t._v("其中 "),s("code",[t._v("<projectname>.wsgi")]),t._v(" 也是 Python 的模块的表示方法，其表示 "),s("code",[t._v("./<projectname>/wsgi.py")]),t._v(" 这个模块。")]),t._v(" "),s("p",[t._v("可以将执行这条命令的过程写为 Systemd 服务，并实现 2 进程、每进程 3 线程，以及自动重启等：")]),t._v(" "),s("div",{staticClass:"language-ini extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# djangoproject.service")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token section"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token section-name selector"}},[t._v("Unit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("Description")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("Django Project")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("After")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("network.target")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("StartLimitIntervalSec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("0")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token section"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token section-name selector"}},[t._v("Service")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("Type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("simple")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("Restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("always")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("RestartSec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("User")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("root")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("WorkingDirectory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("/path/to/<projectname>/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("ExecStart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v('/usr/local/bin/gunicorn -b "127.0.0.1:8000" \\')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("--workers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("2 \\")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("--threads")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("3 \\")]),t._v("\n    --access-logfile - \\\n    <projectname>.wsgi\n\n"),s("span",{pre:!0,attrs:{class:"token section"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token section-name selector"}},[t._v("Install")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("WantedBy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("multi-user.target")]),t._v("\n")])])]),s("p",[t._v("命令的 "),s("code",[t._v("--access-logfile -")]),t._v(" 表示将 log 输出在控制台，在 Systemd 中即表示可以通过 "),s("code",[t._v("systemctl status djangoproject")]),t._v(" 查询日志。")]),t._v(" "),s("p",[t._v("然后就是将这项服务复制到 "),s("code",[t._v("/etc/systemd/system/")]),t._v("，然后 enable 和 start 了：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" ./djangoproject.service /etc/systemd/system/\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" djangoproject "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 激活")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl start djangoproject  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl status djangoproject "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查询状态")]),t._v("\n")])])]),s("h3",{attrs:{id:"处理静态文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#处理静态文件"}},[t._v("#")]),t._v(" 处理静态文件")]),t._v(" "),s("p",[t._v("但是！这并没有完成部署。访问 "),s("code",[t._v("localhost:8000")]),t._v(" 时，可以看到 Django 有正常响应，但是所有静态文件全部失效，Swagger 文档生成也失效了。")]),t._v(" "),s("p",[t._v("为了解决这个问题，需要配置静态文件。")]),t._v(" "),s("p",[t._v("在 "),s("code",[t._v("<projectname>/settings.py")]),t._v(" 中配置以下几个参数")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" os\nSTATIC_ROOT "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("join"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BASE_DIR"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'.static'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nSTATIC_URL "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/api/static/'")]),t._v("\n\nSTATICFILES_DIRS "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    os"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("join"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("BASE_DIR"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'static'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("三个参数的意义如下：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("BASE_DIR/static")]),t._v(" 是开发中静态文件所在文件夹")]),t._v(" "),s("li",[s("code",[t._v("BASE_DIR/.static")]),t._v(" 是项目生成后静态文件所在文件夹，应当加入 "),s("code",[t._v(".gitignore")])]),t._v(" "),s("li",[s("code",[t._v("/api/static/")]),t._v(" 是在网页中访问静态文件的路径")])]),t._v(" "),s("p",[t._v("整个过程是这样的：")]),t._v(" "),s("ol",[s("li",[t._v("开发者将所需的静态文件放入 "),s("code",[t._v("BASE_DIR/static")])]),t._v(" "),s("li",[t._v("开发者运行 "),s("code",[t._v("python3 manage.py collectstatic")]),t._v("，Django 将开发者提供的 "),s("code",[t._v("BASE_DIR/static")]),t._v(" 文件，和 Swagger 等 APP 提供的静态文件，一并复制进 "),s("code",[t._v("BASE_DIR/.static")])]),t._v(" "),s("li",[t._v("用户在浏览器中访问 "),s("code",[t._v("/api/static/")]),t._v(" 路径，表示用户想访问的文件夹是 "),s("code",[t._v("BASE_DIR/.static")])])]),t._v(" "),s("p",[t._v("所以还需要进行以下两步：")]),t._v(" "),s("ol",[s("li",[t._v("运行 "),s("code",[t._v("python3 manage.py collectstatic")])]),t._v(" "),s("li",[t._v("通过 Nginx / Apache / Caddy 等将静态文件提供给用户")])]),t._v(" "),s("p",[t._v("Gunicorn 提供了一个 "),s("a",{attrs:{href:"https://docs.gunicorn.org/en/latest/deploy.html#id5",target:"_blank",rel:"noopener noreferrer"}},[t._v("Nginx.conf 配置模板"),s("OutboundLink")],1),t._v("，我也提供一份 Caddy 的配置模板：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("example.com {\n    handle /api/static/* {\n        uri strip_prefix /api/static\n        root * /etc/uestcmsc_webapp/backend/.static\n        file_server\n    }\n\n    handle /api/* {\n        reverse_proxy localhost:8000\n    }\n    \n    handle {\n        root * /etc/uestcmsc_webapp/frontend\n        try_files {path} /index.html\n        file_server\n    }\n}\n")])])]),s("p",[t._v("需要注意的是，这种配置的前提是所有 REST API 放在了 "),s("code",[t._v("/api/")]),t._v(" 下，这种方法使用的 "),s("code",[t._v("<projectname>/urls.py")]),t._v(" 如下：")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[t._v("api_urlpatterns "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("r'^docs(?P<format>\\.json|\\.yaml)$'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" schema_view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("without_ui"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cache_timeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'schema-json'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("r'^docs/$'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" schema_view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("with_ui"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'swagger'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cache_timeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'schema-swagger-ui'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("r'^redoc/$'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" schema_view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("with_ui"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'redoc'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" cache_timeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'schema-redoc'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'admin/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" admin"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("site"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("urls"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nurlpatterns "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'api/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" include"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("api_urlpatterns"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("h3",{attrs:{id:"gunicorn-日志-ip-总是显示-127-0-0-1"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gunicorn-日志-ip-总是显示-127-0-0-1"}},[t._v("#")]),t._v(" Gunicorn 日志 ip 总是显示 127.0.0.1")]),t._v(" "),s("p",[t._v("出现这个问题，我第一反应是 Caddy 反代的锅，第二反应是 Django 的锅，最后查了一下才发现是 Gunicorn 的锅。")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://stackoverflow.com/questions/25737589/gunicorn-doesnt-log-real-ip-from-nginx",target:"_blank",rel:"noopener noreferrer"}},[t._v("Gunicorn doesn't log real ip from nginx - Stack Overflow"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("回答也说的很清楚，只需要按照格式修改好后追加到 "),s("code",[t._v("--access-logformat")]),t._v(" 参数即可。")]),t._v(" "),s("p",[t._v("我把时间、两个 "),s("code",[t._v("-")]),t._v("和 127.0.0.1 去掉以后的配置如下：")]),t._v(" "),s("div",{staticClass:"language-ini extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("ExecStart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v('/usr/local/bin/gunicorn -b "127.0.0.1:8000" \\')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("--workers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("2 \\")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("--threads")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("3 \\")]),t._v('\n    --access-logfile - \\\n    --access-logformat "%({X-Real-IP}i)s \\"%(r)s\\" %(s)s %(b)s \\"%(f)s\\" \\"%(a)s\\"" \\\n    <projectname>.wsgi\n')])])]),s("h2",{attrs:{id:"django-项目部署-asgi"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#django-项目部署-asgi"}},[t._v("#")]),t._v(" Django 项目部署 (ASGI)")]),t._v(" "),s("p",[t._v("Django 主推的 ASGI 部署方式，应该是它自己维护的 "),s("a",{attrs:{href:"https://github.com/django/daphne",target:"_blank",rel:"noopener noreferrer"}},[t._v("Daphne"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("p",[t._v("安装 Daphne")]),t._v(" "),s("div",{staticClass:"language-py extra-class"},[s("pre",{pre:!0,attrs:{class:"language-py"}},[s("code",[t._v("python "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("m pip install daphne\n")])])]),s("p",[t._v("在项目文件夹下运行：")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("daphne "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("projectname"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".asgi:application\n")])])]),s("div",{staticClass:"language-ini extra-class"},[s("pre",{pre:!0,attrs:{class:"language-ini"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("ExecStart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("/usr/local/bin/daphne -p 8000 <projectname>.asgi:application")]),t._v("\n")])])]),s("p",[t._v("目前 Daphne 还不支持多进程，如需多进程，请使用 "),s("code",[t._v("uvicorn")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"项目开源地址"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#项目开源地址"}},[t._v("#")]),t._v(" 项目开源地址")]),t._v(" "),s("p",[t._v("上面提到的项目开源在 "),s("a",{attrs:{href:"https://github.com/uestc-msc/uestcmsc_webapp_backend/tree/e1f3208664770ccf0b50522a2620d3ccf766024b",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitHub"),s("OutboundLink")],1),t._v("。")])])}),[],!1,null,null,null);s.default=e.exports}}]);