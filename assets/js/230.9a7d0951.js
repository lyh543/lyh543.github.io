(window.webpackJsonp=window.webpackJsonp||[]).push([[230],{621:function(s,t,a){"use strict";a.r(t);var n=a(3),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("最近公司的 Python 后端服务内存占用偏高，所以花了一些时间分析后端的内存占用。也梳理了一些比较好用的工具和分析方法。")]),s._v(" "),t("p",[s._v("在我们的场景下，我们发现内存占用异常是在服务运行了一段时间以后，所以下面的工具链更偏向于分析"),t("strong",[s._v("应用运行时的内存占用长期持续增长趋势")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"tracemalloc"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tracemalloc"}},[s._v("#")]),s._v(" tracemalloc")]),s._v(" "),t("p",[s._v("提到 Python 内存分析，一定会有 tracemalloc，毕竟是内置的内存追踪工具。")]),s._v(" "),t("p",[s._v("但是实际体验下来比较一般，它只能追踪到 pymalloc 分配的 Python 对象，对于 C 扩展（比如 numpy、PIL）这种库申请的内存是无法追踪的。结果就是进程内存已经占用几个 GB 了，但是 tracemalloc 只追踪到了 50 MB 的内存分配。")]),s._v(" "),t("p",[s._v("下面是 tracemalloc 的一个 demo。")]),s._v(" "),t("div",{staticClass:"language-py extra-class"},[t("pre",{pre:!0,attrs:{class:"language-py"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" tracemalloc\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开始追踪内存分配")]),s._v("\ntracemalloc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("start"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("create_list")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个大的列表")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("i "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("range")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("create_dict")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个大的字典")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("str")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" i "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("range")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 调用函数，分配内存")]),s._v("\nlarge_list "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" create_list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nlarge_dict "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" create_dict"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取当前内存快照")]),s._v("\nsnapshot "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tracemalloc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("take_snapshot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 分析内存分配")]),s._v("\ntop_stats "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" snapshot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("statistics"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'lineno'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"[Top 10 Memory Usage]"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" stat "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" top_stats"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 停止追踪内存分配")]),s._v("\ntracemalloc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stop"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[s._v("对于 Django 后端项目，可以把这段代码放到中间件里。")]),s._v(" "),t("div",{staticClass:"language-py extra-class"},[t("pre",{pre:!0,attrs:{class:"language-py"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" django"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" settings\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MemoryUsageMiddleware")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("__init__")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" get_response"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        self"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_response "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" get_response\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("__call__")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" settings"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("DEBUG"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 仅在 DEBUG 模式下启用")]),s._v("\n            tracemalloc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("start"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        response "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_response"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" settings"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("DEBUG"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            snapshot "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" tracemalloc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("take_snapshot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            tracemalloc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("stop"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n            top_stats "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" snapshot"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("statistics"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'lineno'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" stat "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" top_stats"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或记录到日志中")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" response\n")])])]),t("p",[s._v("总的来说，tracemalloc 可以试试，但是效果不一定好，而且会有一定性能影响，不太好放在时延敏感的后端项目的生产环境上跑，tracemalloc 的统计数据也会占用运行内存。")]),s._v(" "),t("h2",{attrs:{id:"psutil"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#psutil"}},[s._v("#")]),s._v(" psutil")]),s._v(" "),t("p",[s._v("psutil 获取进程的信息，它拿到的数据和系统的 top 命令是一样的，不会存在 tracemalloc 这种统计偏小的问题。")]),s._v(" "),t("p",[s._v("在我们的项目中，对后端和 Celery Worker（一个任务执行服务）分别做了内存分析，两者的使用方法有一点差异。")]),s._v(" "),t("h3",{attrs:{id:"psutil-统计后端内存使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#psutil-统计后端内存使用"}},[s._v("#")]),s._v(" psutil 统计后端内存使用")]),s._v(" "),t("p",[s._v("也是推荐把代码放到中间件里，在请求开始前后分别获取内存占用，做个减法。")]),s._v(" "),t("div",{staticClass:"language-py extra-class"},[t("pre",{pre:!0,attrs:{class:"language-py"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" psutil\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" logging\n\nlogger "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" logging"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("getLogger"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__name__"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MemoryUsageMiddleware")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("__init__")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" get_response"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        self"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_response "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" get_response\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("__call__")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("self"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取当前进程的内存信息（请求开始前）")]),s._v("\n        process "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" psutil"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        memory_before "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("memory_info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rss  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 常驻内存（单位：字节）")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 处理请求")]),s._v("\n        response "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_response"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取当前进程的内存信息（请求结束后）")]),s._v("\n        memory_after "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("memory_info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rss  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 常驻内存（单位：字节）")]),s._v("\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 计算内存使用差值")]),s._v("\n        memory_diff "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" memory_after "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" memory_before\n\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将内存使用信息记录到日志中")]),s._v("\n        logger"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string-interpolation"}},[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"[Memory Usage] Before: ')]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("memory_before "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token format-spec"}},[s._v(".2f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v(' MB, "')])]),s._v("\n                    "),t("span",{pre:!0,attrs:{class:"token string-interpolation"}},[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"After: ')]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("memory_after "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token format-spec"}},[s._v(".2f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v(' MB, "')])]),s._v("\n                    "),t("span",{pre:!0,attrs:{class:"token string-interpolation"}},[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"Diff: ')]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("memory_diff "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token format-spec"}},[s._v(".2f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v(' MB"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" response\n")])])]),t("p",[s._v("正常情况下请求前后的内存值是不会有变化的，如果某个请求以后内存值"),t("strong",[s._v("总是")]),s._v("有增加，就说明这个请求可能有内存泄漏。")]),s._v(" "),t("p",[s._v("需要注意的是：")]),s._v(" "),t("ol",[t("li",[s._v("由于后端一个进程会同时处理多个请求，所以出现内存上升也需要注意是否可能是其他请求引起的。")]),s._v(" "),t("li",[s._v("内存增加有可能是没有及时 GC 导致的。由于 GC 需要拿到 GIL，不建议在后端中间件里直接 GC，所以出现内存增长也不能断定一定有内存泄漏，需要结合代码逻辑综合判断。")])]),s._v(" "),t("p",[s._v("实际业务场景下，发现有两个 "),t("code",[s._v("healthz")]),s._v(" 请求之间内存上升了 200M（第一个 healthz 请求前后内存 400M，第二个 healthz 请求前后内存 600M，中间没有任何别的请求），后来发现是因为在初始化翻译模型导致的。")]),s._v(" "),t("h3",{attrs:{id:"psutil-统计-celery-worker-内存使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#psutil-统计-celery-worker-内存使用"}},[s._v("#")]),s._v(" psutil 统计 Celery Worker 内存使用")]),s._v(" "),t("p",[s._v("Celery Worker 中使用 psutil 的方法也一样，在任务执行前后获取内存占用，做个减法。需要基于 celery 提供的 signals 来在任务开始前和结束后插入代码。")]),s._v(" "),t("div",{staticClass:"language-py extra-class"},[t("pre",{pre:!0,attrs:{class:"language-py"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" gc\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" psutil\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" logging\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" celery "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" signals\n\nlogger "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" logging"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("getLogger"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__name__"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@signals"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("task_prerun"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connect")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("record_memory_before_task")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sender"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" task_id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" task"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" kwargs"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("**")]),s._v("extras"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""\n    在任务开始前记录内存使用，并存储到 sender 的属性中。\n    """')]),s._v("\n    process "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" psutil"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    memory_before "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("memory_info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rss  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取当前进程的常驻内存（字节）")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将内存使用记录到 sender 的属性中")]),s._v("\n    sender"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("memory_before "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" memory_before\n    \n    logger"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string-interpolation"}},[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"[Task ')]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sender"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("] Memory before: ")]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("memory_before "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token format-spec"}},[s._v(".2f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v(' MB"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@signals"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("task_postrun"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connect")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("record_memory_after_task")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sender"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" task_id"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" task"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" args"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" kwargs"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" retval"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" state"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("**")]),s._v("extras"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[s._v('"""\n    在任务结束后记录内存使用，并计算差值。\n    """')]),s._v("\n    gc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("collect"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 强制进行垃圾回收，清理内存")]),s._v("\n    process "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" psutil"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    memory_after "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" process"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("memory_info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rss  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取当前进程的常驻内存（字节）")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从 sender 的属性中读取任务开始前的内存使用")]),s._v("\n    memory_before "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("getattr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sender"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'memory_before'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" memory_before "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("is")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        memory_diff "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" memory_after "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" memory_before\n        logger"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string-interpolation"}},[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"[Task ')]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sender"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("] Memory after: ")]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("memory_after "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token format-spec"}},[s._v(".2f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v(' MB, "')])]),s._v("\n                    "),t("span",{pre:!0,attrs:{class:"token string-interpolation"}},[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"Diff: ')]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("memory_diff "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token format-spec"}},[s._v(".2f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v(' MB"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        logger"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("warning"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string-interpolation"}},[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('f"[Task ')]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("sender"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('] Memory usage before task not found."')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[s._v("Celery Worker 内存监控时需要注意几个点：")]),s._v(" "),t("ol",[t("li",[s._v("Celery Worker 可以使用 prefork 模式执行（"),t("code",[s._v("celery worker --pool=processes")]),s._v("），虽然这会带来一定内存上升（每个 worker process 都需要加载库、拥有一份全局变量），但是 prefork 模式下每个 worker process 是串行执行的，所以任务的内存使用量是隔离的，统计值不会受到其它任务的影响。")]),s._v(" "),t("li",[s._v("Celery Worker 场景下时延不敏感，所以在任务执行前后直接 GC 是可以的，这样统计的内存波动更准确。")]),s._v(" "),t("li",[s._v("Celery Worker 的默认并发数为 CPU 数，在 Docker 和 K8s 环境中，系统获取的 CPU 是宿主机的 CPU 数量，而非 requests 或 limit，prefork 模式下使用默认值数会创建过多的进程，导致。所以强烈建立显式执行并发数（"),t("code",[s._v("--concurrency=4")]),s._v("）。")])]),s._v(" "),t("p",[s._v("实际业务场景中，确实有任务在处理以后多占用了 1.5G 的空间，后来分析发现是因为处理大量数据的时候没有做分批处理，改为分批处理以后内存量就下降了。")]),s._v(" "),t("h2",{attrs:{id:"objgraph"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#objgraph"}},[s._v("#")]),s._v(" objgraph")]),s._v(" "),t("p",[s._v("参考："),t("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/436577356",target:"_blank",rel:"noopener noreferrer"}},[s._v("填坑总结：python内存泄漏排查小技巧 - 知乎"),t("OutboundLink")],1),s._v("。这部分有现成的博客可以参考，就不多赘述了。")]),s._v(" "),t("p",[s._v("objgraph 和 tracemalloc 类似，都是 Python 内置的内存分析工具，分析 pymalloc 分配的内存。objgraph 的好处是自带增量分析，可以分析对象之间的引用关系。")]),s._v(" "),t("div",{staticClass:"language-py extra-class"},[t("pre",{pre:!0,attrs:{class:"language-py"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" objgraph\n\nobjgraph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("show_growth"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("limit"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[s._v("运行一段时间后，发现某个不常见对象的数量一直在少量增长，怀疑是这个对象造成的。")]),s._v(" "),t("p",[s._v("将这些对象的引用关系输出到 dot 文件里，然后使用 graphviz 可视化。")]),s._v(" "),t("div",{staticClass:"language-py extra-class"},[t("pre",{pre:!0,attrs:{class:"language-py"}},[t("code",[s._v("gth "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" objgraph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("growth"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("limit"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" gt "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" gth"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    logger"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"growth type:%s, count:%s, growth:%s"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("or")]),s._v(" gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("continue")]),s._v("\n    objgraph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("show_backrefs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("objgraph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("by_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" max_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" too_many"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                           filename"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./dots/%s_backrefs.dot"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    objgraph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("show_refs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("objgraph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("by_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" max_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" too_many"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                       filename"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./dots/%s_refs.dot"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    objgraph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("show_chain"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        objgraph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("find_backref_chain"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("objgraph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("by_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" objgraph"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_proper_module"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        filename"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./dots/%s_chain.dot"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" gt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("dot -Tpng xxx_chain.dot -o xxx_chain.png\n")])])]),t("p",[s._v("就可以定位到这个对象的引用关系了。")]),s._v(" "),t("h2",{attrs:{id:"wss-偏高"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#wss-偏高"}},[s._v("#")]),s._v(" WSS 偏高")]),s._v(" "),t("p",[s._v("WSS 也是一个很有趣的话题，之前用 K8s 的时候有注意过这个概念，但并没有太理解。最近遇到了 WSS 异常高的问题，深入了解后才明白了 WSS 和 RSS 的区别。")]),s._v(" "),t("ul",[t("li",[s._v("RSS (Resident set size): RSS 是主内存中不对应于磁盘上任何内容的物理内存。RSS 包括栈、堆和匿名内存映射。")]),s._v(" "),t("li",[s._v("WSS (Working set size): WSS 是一个进程在一段时间内工作所需的内存。")])]),s._v(" "),t("p",[s._v("初看这两个概念非常抽象。但是下面会引入两个新的概念和一个公式，两者就好理解多了。")]),s._v(" "),t("ul",[t("li",[s._v("RSS 这个值可以理解成程序申请了并且在使用的内存，不能被外界清理，等于 "),t("code",[s._v("top")]),s._v(" 里的 "),t("code",[s._v("RES")]),s._v("，也等于 Python "),t("code",[s._v("psutil")]),s._v(" 里的 RSS。")]),s._v(" "),t("li",[s._v("除了程序申请的内存，程序还会读取文件，系统会将文件缓存到操作系统中。其中，频繁读取的（读取了两次及以上的）文件会放到 "),t("code",[s._v("active_file")]),s._v("；读取了一次，或者一段时间没有再使用的文件会放到 "),t("code",[s._v("inactive_file")]),s._v("。这个设计思想是合理的，就和 Python、JS 的多级 GC 一样，先把不常用的文件降级，GC 的时候优先清理不常用的文件。")]),s._v(" "),t("li",[t("strong",[s._v("WSS = RSS + active_file")]),s._v("。也就是说 WSS 会把 "),t("code",[s._v("active_file")]),s._v(" 也算上，但不计算 "),t("code",[s._v("inactive_file")]),s._v("。")])]),s._v(" "),t("p",[s._v("所以，如果 RSS 正常，WSS 偏高，可以判断是 "),t("code",[s._v("active_file")]),s._v(" 占用过高。")]),s._v(" "),t("p",[s._v("在 Pod 里可以查询 cgroup 下 "),t("code",[s._v("rss")]),s._v(" 和 "),t("code",[s._v("active_file")]),s._v(" 的大小。")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /sys/fs/cgroup/memory/memory.stat\n\ncache "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6980935680")]),s._v("\nrss "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3365285888")]),s._v("\nrss_huge "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nmapped_file "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("36864")]),s._v("\nswap "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\npgpgin "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("37141945")]),s._v("\npgpgout "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("34616012")]),s._v("\npgfault "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("38453850")]),s._v("\npgmajfault "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\ninactive_anon "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("45056")]),s._v("\nactive_anon "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3365224448")]),s._v("\ninactive_file "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4316774400")]),s._v("\nactive_file "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2664116224")]),s._v("\nunevictable "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nhierarchical_memory_limit "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17179869184")]),s._v("\nhierarchical_memsw_limit "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17179869184")]),s._v("\ntotal_cache "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6980935680")]),s._v("\ntotal_rss "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3365285888")]),s._v("\ntotal_rss_huge "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_mapped_file "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("36864")]),s._v("\ntotal_swap "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_pgpgin "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_pgpgout "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_pgfault "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_pgmajfault "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\ntotal_inactive_anon "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("45056")]),s._v("\ntotal_active_anon "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3365224448")]),s._v("\ntotal_inactive_file "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4316774400")]),s._v("\ntotal_active_file "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2664116224")]),s._v("\ntotal_unevictable "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])])]),t("p",[s._v("这里的 "),t("code",[s._v("rss")]),s._v(" 大小为 3.1G，"),t("code",[s._v("active_file")]),s._v(" 大小为 2.5G，WSS = 3.1G + 2.5G = 5.6G。可以使用 K8s 的 "),t("code",[s._v("kubectl top pod")]),s._v(" 命令查看 WSS 和 RSS 的大小进行验证。")]),s._v(" "),t("hr"),s._v(" "),t("p",[s._v("那么下一个问题是，定位到 "),t("code",[s._v("active_file")]),s._v(" 偏高后，如何定位到加载了什么文件呢？")]),s._v(" "),t("p",[s._v("系统并没有提供枚举内存中 active_file 对应了哪些文件。")]),s._v(" "),t("p",[s._v("有一个工具 "),t("code",[s._v("vmtouch")]),s._v(" 命令可以传入文件列表，查询这里面有多少被加载进了内存，但需要我们提前知道哪些文件可能被加入到内存中。")]),s._v(" "),t("p",[s._v("可以先使用 "),t("code",[s._v("lsof")]),s._v(" 命令来查看当前进程打开的文件列表（部分输出已省略）。")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("lsof")]),s._v(" -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v("\nCOMMAND PID "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v(" FD TYPE DEVICE SIZE/OFF NODE NAME\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root cwd DIR "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2108472")]),s._v(" /src\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root rtd DIR "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2108464")]),s._v(" /\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root txt REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18400")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21366419")]),s._v(" /usr/local/bin/python3.8\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21366419")]),s._v(" /usr/local/bin/python3.8 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24644260")]),s._v(" /usr/local/lib/python3.8/site-packages/rpds/rpds.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24643051")]),s._v(" /usr/local/lib/python3.8/site-packages/ray/thirdparty_files/setproctitle.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24515449")]),s._v(" /usr/local/lib/python3.8/site-packages/ray/_raylet.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24381158")]),s._v(" /usr/local/lib/python3.8/site-packages/gevent/_gevent_c_imap.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24381203")]),s._v(" /usr/local/lib/python3.8/site-packages/gevent/libev/corecext.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24118626")]),s._v(" /usr/local/lib/python3.8/site-packages/Crypto/Cipher/_raw_aesni.abi3.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24118635")]),s._v(" /usr/local/lib/python3.8/site-packages/Crypto/Cipher/_raw_ecb.abi3.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21367099")]),s._v(" /usr/local/lib/python3.8/lib-dynload/_elementtree.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1864875")]),s._v(" /usr/local/lib/python3.8/site-packages/google/_upb/_message.abi3.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24381068")]),s._v(" /usr/local/lib/python3.8/site-packages/frozenlist/_frozenlist.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24120243")]),s._v(" /usr/local/lib/python3.8/site-packages/aiohttp/_websocket.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24120239")]),s._v(" /usr/local/lib/python3.8/site-packages/aiohttp/_http_parser.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24120241")]),s._v(" /usr/local/lib/python3.8/site-packages/aiohttp/_http_writer.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24120236")]),s._v(" /usr/local/lib/python3.8/site-packages/aiohttp/_helpers.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24646390")]),s._v(" /usr/local/lib/python3.8/site-packages/yarl/_quoting_c.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24383932")]),s._v(" /usr/local/lib/python3.8/site-packages/multidict/_multidict.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1870845")]),s._v(" /usr/local/lib/python3.8/site-packages/regex/_regex.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21367140")]),s._v(" /usr/local/lib/python3.8/lib-dynload/mmap.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1869864")]),s._v(" /usr/local/lib/python3.8/site-packages/psutil/_psutil_posix.abi3.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20709986")]),s._v(" /lib/x86_64-linux-gnu/libnss_dns-2.31.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20709988")]),s._v(" /lib/x86_64-linux-gnu/libnss_files-2.31.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21106628")]),s._v(" /usr/lib/x86_64-linux-gnu/libmariadb.so.3 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1869863")]),s._v(" /usr/local/lib/python3.8/site-packages/psutil/_psutil_linux.abi3.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1854269")]),s._v(" /usr/local/lib/python3.8/site-packages/MySQLdb/_mysql.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1871693")]),s._v(" /usr/local/lib/python3.8/site-packages/safetensors/_safetensors_rust.abi3.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1879741")]),s._v(" /usr/local/lib/python3.8/site-packages/tokenizers/tokenizers.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1871713")]),s._v(" /usr/local/lib/python3.8/site-packages/sentencepiece/_sentencepiece.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21367136")]),s._v(" /usr/local/lib/python3.8/lib-dynload/cmath.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1869171")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/nvjitlink/lib/libnvJitLink.so.12 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1869157")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/nccl/lib/libnccl.so.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1868850")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/cublas/lib/libcublasLt.so.12 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1868849")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/cublas/lib/libcublas.so.12 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1869107")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/curand/lib/libcurand.so.10 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1890830")]),s._v(" /usr/local/lib/python3.8/site-packages/torch/lib/libcusparseLt-f8b4a9fb.so.0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1869076")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/cufft/lib/libcufft.so.11 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1869142")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/cusparse/lib/libcusparse.so.12 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1868898")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/cuda_cupti/lib/libcupti.so.12 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1869053")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/cudnn/lib/libcudnn.so.8 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1890827")]),s._v(" /usr/local/lib/python3.8/site-packages/torch/lib/libc10.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1890828")]),s._v(" /usr/local/lib/python3.8/site-packages/torch/lib/libc10_cuda.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1890835")]),s._v(" /usr/local/lib/python3.8/site-packages/torch/lib/libtorch_cuda.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1890834")]),s._v(" /usr/local/lib/python3.8/site-packages/torch/lib/libtorch_cpu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1890833")]),s._v(" /usr/local/lib/python3.8/site-packages/torch/lib/libtorch.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1890832")]),s._v(" /usr/local/lib/python3.8/site-packages/torch/lib/libshm.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1890838")]),s._v(" /usr/local/lib/python3.8/site-packages/torch/lib/libtorch_python.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1879798")]),s._v(" /usr/local/lib/python3.8/site-packages/torch/_C.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1890831")]),s._v(" /usr/local/lib/python3.8/site-packages/torch/lib/libgomp-a34b3233.so.1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1869207")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/nvtx/lib/libnvToolsExt.so.1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1869022")]),s._v(" /usr/local/lib/python3.8/site-packages/nvidia/cuda_runtime/lib/libcudart.so.12 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24512873")]),s._v(" /usr/local/lib/python3.8/site-packages/pillow.libs/libXau-154567c4.so.6.0.0 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24512884")]),s._v(" /usr/local/lib/python3.8/site-packages/pillow.libs/libtiff-0a86184d.so.6.0.2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24119318")]),s._v(" /usr/local/lib/python3.8/site-packages/PIL/_imaging.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nuvicorn "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("181")]),s._v(" root mem REG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("253,16")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24385120")]),s._v(" /usr/local/lib/python3.8/site-packages/numpy/random/_generator.cpython-38-x86_64-linux-gnu.so "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("path "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("dev")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0,496")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])])]),t("p",[s._v("可以发现大部分都是依赖，比如 "),t("code",[s._v("cuda")]),s._v("、"),t("code",[s._v("torch")]),s._v("、"),t("code",[s._v("numpy")]),s._v("、"),t("code",[s._v("PIL")]),s._v(" 等等。从直觉上来说 "),t("code",[s._v("torch")]),s._v(" 和 "),t("code",[s._v("cuda")]),s._v(" 可能会很大，所以我们使用 "),t("code",[s._v("vmtouch")]),s._v(" 来看一下 "),t("code",[s._v("cuda")]),s._v(" 和 "),t("code",[s._v("torch")]),s._v(" 有多少被加载到了内存里。")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("$ vmtouch /usr/local/lib/python3.8/site-packages/nvidia/**/*\nFiles: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("\nDirectories: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("66")]),s._v("\nResident Pages: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("729487")]),s._v("/729487 2G/2G "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("%\nElapsed: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.068292")]),s._v(" seconds\n\n$ vmtouch /usr/local/lib/python3.8/site-packages/torch/**/*\n           Files: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11773")]),s._v("\n     Directories: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("629")]),s._v("\n  Resident Pages: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("381258")]),s._v("/387864  1G/1G  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("98.3")]),s._v("%\n         Elapsed: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.1744")]),s._v(" seconds\n")])])]),t("p",[s._v("可以看到 "),t("code",[s._v("torch")]),s._v(" 的大部分文件和 "),t("code",[s._v("nvidia")]),s._v(" 的所有文件都加载进了内存，而且占用都很高，一共占用了 3G 多的内存。所以 WSS 偏高是因为加载了 cuda 和 torch 的依赖。")]),s._v(" "),t("p",[s._v("不过需要注意的是 "),t("code",[s._v("vmtouch")]),s._v(" 的结果可能会大于 "),t("code",[s._v("active_file")]),s._v(" 的大小，一是因为 "),t("code",[s._v("vmtouch")]),s._v(" 只知道文件被加载进内存与否，不区分 "),t("code",[s._v("active_file")]),s._v(" 还是 "),t("code",[s._v("inactive_file")]),s._v("。二是因为 "),t("code",[s._v("vmtouch")]),s._v(" 查询的是整个宿主机的加载情况，而 "),t("code",[s._v("active_file")]),s._v(" 只查询了当前 cgroup 的加载情况。如果当前 cgroup 以外的进程已经把这部分文件加载进内存，那么当前 cgroup 可能就不会把这部分文件计算到 "),t("code",[s._v("active_file")]),s._v(" 里。")]),s._v(" "),t("p",[s._v("所以，实际情况怎么样，还是需要通过对照实验（起一个不包含这些依赖的镜像）来证明确实是这些依赖导致的。")])])}),[],!1,null,null,null);t.default=e.exports}}]);